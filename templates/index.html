<!doctype html>
<html lang="en"> <!-- Lang attribute will be updated by JS -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dory-Lat Phishing Detector</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='Favicon Gabo 16x16.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='Favicon Gabo 32x32.png') }}">
    <link rel="icon" type="image/png" sizes="128x128" href="{{ url_for('static', filename='Favicon Gabo 128x128.png') }}">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='Favicon Gabo 512x512.png') }}">
    <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='Favicon Gabo 512x512.png') }}">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* === CSS Variables for Theme System === */
        :root {
            /* Dark Theme (Default) */
            --bg-primary: #1a1a2e;
            --bg-secondary: rgba(26, 26, 46, 0.8);
            --bg-gradient-start: #16213e;
            --bg-gradient-end: #0f3460;
            --bg-input: #1a1a2e;
            --bg-select: #1a1f2e;
            
            --text-primary: #ffffff;
            --text-secondary: #a9b4d2;
            --text-placeholder: #a9b4d2;
            --text-select: #e8e6e3;
            
            --border-primary: #0f3460;
            --border-secondary: rgba(255, 255, 255, 0.18);
            --border-light: rgba(255, 255, 255, 0.1);
            --border-medium: rgba(255, 255, 255, 0.2);
            
            --accent-danger: #e94560;
            --accent-danger-hover: #c62a42;
            --accent-danger-light: #f7b6c0;
            --accent-danger-bg: rgba(233, 69, 96, 0.1);
            
            --accent-success: #14dd7a;
            --accent-success-dark: #0fa368;
            --accent-success-light: #a1e9c4;
            --accent-success-bg: rgba(20, 221, 122, 0.1);
            
            --accent-warning: #ffc107;
            --accent-warning-light: #ffddaa;
            --accent-warning-bg: rgba(255, 193, 7, 0.1);
            
            --btn-clear: #536976;
            --btn-clear-hover: #41515b;
            --btn-outline: #f0f0f0;
            
            --shadow-primary: rgba(0, 0, 0, 0.37);
            --shadow-accent: rgba(233, 69, 96, 0.3);
            --shadow-hover: rgba(233, 69, 96, 0.4);
            
            --overlay-bg: rgba(255, 255, 255, 0.1);
            --gray-text: #888;
            --feedback-text: #ccc;
            
            /* Result backgrounds */
            --result-phishing-bg: var(--accent-danger-bg);
            --result-phishing-text: var(--accent-danger-light);
            --result-legitimate-bg: var(--accent-success-bg);
            --result-legitimate-text: var(--accent-success-light);
            --result-warning-bg: var(--accent-warning-bg);
            --result-warning-text: var(--accent-warning-light);
            
            /* Additional UI elements */
            --confidence-bg: rgba(255, 255, 255, 0.1);
            --spinner-bg: rgba(255, 255, 255, 0.2);
            --accent-success-hover: #0fa368;
            
            /* Theme transition */
            --transition-speed: 0.3s;
        }
        
        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #e3f2fd; /* Lighter blue background like in the image */
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-gradient-start: #e3f2fd;
            --bg-gradient-end: #bbdefb;
            --bg-input: #ffffff;
            --bg-select: #ffffff;
            
            --text-primary: #1a1a2e;
            --text-secondary: #5a6c7d;
            --text-placeholder: #9099a3;
            --text-select: #2c3e50;
            
            --border-primary: #d1d8e0;
            --border-secondary: rgba(0, 0, 0, 0.1);
            --border-light: rgba(0, 0, 0, 0.08);
            --border-medium: rgba(0, 0, 0, 0.15);
            
            --accent-danger: #d32f2f;
            --accent-danger-hover: #b71c1c;
            --accent-danger-light: #c62828;
            --accent-danger-bg: rgba(211, 47, 47, 0.08);
            
            --accent-success: #388e3c;
            --accent-success-dark: #2e7d32;
            --accent-success-light: #4caf50;
            --accent-success-bg: rgba(56, 142, 60, 0.08);
            
            --accent-warning: #f57c00;
            --accent-warning-light: #ff9800;
            --accent-warning-bg: rgba(245, 124, 0, 0.08);
            
            --btn-clear: #78909c;
            --btn-clear-hover: #607d8b;
            --btn-outline: #37474f;
            
            --shadow-primary: rgba(0, 0, 0, 0.12);
            --shadow-accent: rgba(211, 47, 47, 0.2);
            --shadow-hover: rgba(211, 47, 47, 0.3);
            
            --overlay-bg: rgba(0, 0, 0, 0.05);
            --gray-text: #666;
            --feedback-text: #555;
            
            /* Result backgrounds for light theme */
            --result-phishing-bg: #ffebee;
            --result-phishing-text: #c62828;
            --result-legitimate-bg: #e8f5e9;
            --result-legitimate-text: #2e7d32;
            --result-warning-bg: #fff3e0;
            --result-warning-text: #e65100;
            
            /* Additional UI elements for light theme */
            --confidence-bg: rgba(0, 0, 0, 0.05);
            --spinner-bg: rgba(0, 0, 0, 0.1);
            --accent-success-hover: #2e7d32;
        }
        
        /* Smooth transitions for theme changes */
        * {
            transition: background-color var(--transition-speed) ease,
                        color var(--transition-speed) ease,
                        border-color var(--transition-speed) ease;
        }
        
        /* Prevent transition on page load */
        .no-transition * {
            transition: none !important;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: start; /* Align to top */
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
        }
        .container {
            background-color: var(--bg-secondary);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 var(--shadow-primary);
            width: 90%;
            max-width: 700px;
            text-align: center; /* Center align text */
            margin-top: 20px; /* Add some margin top */
            border: 1px solid var(--border-secondary);
        }
        h1 {
            color: var(--text-primary);
            margin-bottom: 25px;
            font-weight: 600;
        }
        label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-secondary);
            font-weight: 400;
            text-align: left; /* Align label text left */
        }
        select {
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            background-color: var(--bg-select);
            color: var(--text-select);
            border: 1px solid var(--border-primary);
            font-size: 1rem;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        select:hover {
            border-color: var(--accent-success);
        }
        select:focus {
            outline: none;
            border-color: var(--accent-success);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
        }
        textarea {
            width: 100%;
            min-height: 180px; /* Increased height */
            padding: 15px;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 25px;
            box-sizing: border-box; /* Include padding and border in width */
            background-color: var(--bg-input);
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }
        textarea:focus {
            outline: none;
            border-color: var(--accent-success);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
        }
        textarea::placeholder { /* Style the placeholder text */
            color: var(--text-placeholder);
            font-style: italic;
        }
        .button-container {
            display: flex;
            justify-content: space-between; /* Space out buttons */
            gap: 15px; /* Add gap between buttons */
            margin-bottom: 25px;
        }
        button {
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-grow: 1; /* Make buttons share space */
        }
        .analyze-button {
            background-color: #4caf50; /* Green color like in the image */
            color: white;
        }
        .analyze-button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        .clear-button {
            background-color: #2196f3; /* Blue color like in the image */
            color: white;
        }
        .clear-button:hover {
            background-color: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }
        .lang-button { /* Style for language button */
            background-color: transparent;
            color: var(--text-primary);
            border: 2px solid var(--border-primary);
            max-width: 150px; /* Adjust width if needed */
            flex-grow: 0; /* Don't let it grow like others */
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
        }
        .lang-button:hover {
            background-color: var(--bg-input);
            border-color: var(--accent-success);
            transform: translateY(-2px);
        }
        .result {
            margin-top: 25px;
            padding: 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            word-wrap: break-word; /* Ensure long results wrap */
            text-align: left; /* Align result text left */
            border-left: 5px solid;
        }
        .result.phishing {
            background-color: var(--result-phishing-bg);
            color: var(--result-phishing-text);
            border-color: var(--accent-danger);
        }
        .result.legitimate {
            background-color: var(--result-legitimate-bg);
            color: var(--result-legitimate-text);
            border-color: var(--accent-success);
        }
        .result.error, .model-error { /* Combined error style */
            background-color: var(--result-warning-bg);
            color: var(--result-warning-text);
            border-color: var(--accent-warning);
            text-align: left; /* Align error text left */
        }
        .model-error { /* Specific style for model load error */
             margin-bottom: 20px; /* Add space below model error */
             padding: 15px;
             font-size: 0.9rem;
        }
        /* Result details styles */
        .result-header {
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .result-icon {
            font-size: 1.5rem;
        }
        .result-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-primary);
            font-size: 0.9rem;
            font-weight: normal;
        }
        .detail-row {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
        .detail-label {
            opacity: 0.8;
        }
        .detail-value {
            font-weight: 600;
        }
        .confidence-bar {
            width: 100%;
            height: 8px;
            background-color: var(--confidence-bg);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        .confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .loading {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
        }
        .spinner {
            border: 3px solid var(--spinner-bg);
            border-top: 3px solid var(--accent-danger);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Add container for header and button */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .header-container h1 {
            margin: 0; /* Remove default h1 margin */
            text-align: left; /* Ensure heading stays left */
            flex-grow: 1; /* Allow heading to take space */
        }
        /* Logo styles */
        .logo-link {
            display: inline-block;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        .logo-link:hover {
            transform: scale(1.1);
        }
        .logo-link img {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            box-shadow: 0 4px 15px var(--shadow-hover);
        }
        /* Footer styles */
        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-primary);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .footer a {
            color: var(--accent-danger);
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .footer a:hover {
            color: var(--accent-danger-light);
        }
        
        /* Theme toggle button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--bg-input);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px var(--shadow-primary);
            z-index: 1000;
        }
        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 6px 20px var(--shadow-hover);
        }
        
        /* History button */
        .history-button {
            position: fixed;
            top: 20px;
            right: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 1000;
            /* Make it relative for badge positioning */
            position: fixed;
        }
        .history-button:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.6);
        }
        .history-button:active {
            transform: scale(0.95);
        }
        .history-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.5);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        /* Modal overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        
        /* Modal content */
        .modal-content {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px var(--shadow-primary);
        }
        
        /* Modal header */
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.5rem;
        }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            transition: all 0.3s ease;
        }
        .modal-close:hover {
            color: var(--accent-danger);
            transform: rotate(90deg);
        }
        
        /* Modal body */
        .modal-body {
            padding: 20px 25px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        /* History item */
        .history-item {
            background-color: var(--bg-input);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease-out;
        }
        .history-item:hover {
            border-color: var(--accent-danger);
            box-shadow: 0 4px 12px var(--shadow-hover);
            transform: translateY(-2px);
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .history-item-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .history-item-result {
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .history-item-result.phishing {
            background-color: var(--result-phishing-bg);
            color: var(--result-phishing-text);
        }
        .history-item-result.legitimate {
            background-color: var(--result-legitimate-bg);
            color: var(--result-legitimate-text);
        }
        .history-item-preview {
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 10px;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-item-actions {
            display: flex;
            gap: 10px;
        }
        .history-item-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .history-item-btn.load {
            background-color: var(--accent-success);
            color: white;
        }
        .history-item-btn.load:hover {
            background-color: var(--accent-success-hover);
        }
        .history-item-btn.delete {
            background-color: transparent;
            color: var(--accent-danger);
            border: 1px solid var(--accent-danger);
        }
        .history-item-btn.delete:hover {
            background-color: var(--accent-danger);
            color: white;
        }
        
        /* Modal footer */
        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-footer-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .modal-footer-btn.export {
            background-color: var(--accent-success);
            color: white;
        }
        .modal-footer-btn.export:hover {
            background-color: var(--accent-success-hover);
        }
        .modal-footer-btn.clear {
            background-color: transparent;
            color: var(--accent-danger);
            border: 1px solid var(--accent-danger);
        }
        .modal-footer-btn.clear:hover {
            background-color: var(--accent-danger);
            color: white;
        }
        
        /* Empty state */
        .history-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        .history-empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .history-empty-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        .history-empty-subtext {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* File Upload Styles */
        .file-upload-section {
            margin-bottom: 20px;
        }
        .file-upload-wrapper {
            width: 100%;
        }
        .file-upload-area {
            border: 2px dashed var(--border-primary);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--bg-input);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .file-upload-area:hover {
            border-color: var(--accent-success);
            background-color: var(--accent-success-bg);
        }
        .file-upload-area.dragover {
            border-color: var(--accent-success);
            background-color: var(--accent-success-bg);
            transform: scale(1.02);
        }
        .file-upload-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            opacity: 0.7;
        }
        .file-upload-text {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .file-upload-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .file-upload-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .file-preview {
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 15px;
            background-color: var(--bg-input);
            margin-top: 10px;
        }
        .file-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .file-preview-name {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .file-preview-name::before {
            content: "üìÑ";
        }
        .file-preview-remove {
            background-color: var(--accent-danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .file-preview-remove:hover {
            background-color: var(--accent-danger-hover);
            transform: scale(1.1);
        }
        .file-preview-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        /* Examples Section Styles */
        .examples-section {
            margin-bottom: 20px;
            background-color: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-primary);
            overflow: hidden;
        }
        
        .examples-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            cursor: pointer;
        }
        
        .examples-header h3 {
            margin: 0;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .examples-toggle {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .examples-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .examples-content {
            padding: 20px;
        }
        
        .examples-description {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 0.95rem;
            text-align: center;
        }
        
        .examples-categories {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .example-category {
            background-color: var(--bg-primary);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border-primary);
        }
        
        .category-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-primary);
        }
        
        .category-icon {
            font-size: 1.3rem;
        }
        
        .phishing-category {
            color: #f44336;
        }
        
        .legitimate-category {
            color: #4caf50;
        }
        
        .example-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }
        
        .example-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-family: inherit;
        }
        
        .example-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .phishing-btn {
            border-color: #f44336;
        }
        
        .phishing-btn:hover {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.1), rgba(244, 67, 54, 0.05));
            border-color: #f44336;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);
        }
        
        .legitimate-btn {
            border-color: #4caf50;
        }
        
        .legitimate-btn:hover {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05));
            border-color: #4caf50;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }
        
        .example-emoji {
            font-size: 2rem;
            flex-shrink: 0;
        }
        
        .example-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .example-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
        }
        
        .example-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* URL Analysis Styles */
        .url-analysis-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 20px;
            margin-top: 25px;
            animation: slideIn 0.3s ease-out;
        }
        .url-analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-primary);
        }
        .url-analysis-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.2rem;
        }
        .url-count-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .url-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .url-item {
            background-color: var(--bg-input);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 12px 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .url-item:hover {
            border-color: var(--accent-danger);
            transform: translateX(5px);
            box-shadow: 0 2px 8px var(--shadow-hover);
        }
        .url-risk-indicator {
            width: 8px;
            height: 100%;
            min-height: 40px;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .url-risk-indicator.high {
            background-color: #ff4757;
        }
        .url-risk-indicator.medium {
            background-color: #ffa502;
        }
        .url-risk-indicator.low {
            background-color: #26de81;
        }
        .url-content {
            flex-grow: 1;
            min-width: 0;
        }
        .url-text {
            color: var(--text-primary);
            word-break: break-all;
            font-size: 0.95rem;
            margin-bottom: 5px;
            font-family: 'Courier New', monospace;
        }
        .url-flags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }
        .url-flag {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .url-flag.suspicious-domain {
            background-color: rgba(255, 71, 87, 0.15);
            color: #ff4757;
        }
        .url-flag.shortened {
            background-color: rgba(255, 165, 2, 0.15);
            color: #ffa502;
        }
        .url-flag.ip-address {
            background-color: rgba(255, 71, 87, 0.15);
            color: #ff4757;
        }
        .url-flag.suspicious-tld {
            background-color: rgba(255, 165, 2, 0.15);
            color: #ffa502;
        }
        .url-flag.phishing-keywords {
            background-color: rgba(255, 71, 87, 0.15);
            color: #ff4757;
        }
        .url-flag.long-subdomain {
            background-color: rgba(255, 165, 2, 0.15);
            color: #ffa502;
        }
        .url-flag.http-not-secure {
            background-color: rgba(255, 165, 2, 0.15);
            color: #ffa502;
        }
        .url-flag.safe {
            background-color: rgba(38, 222, 129, 0.15);
            color: #26de81;
        }
        .url-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-shrink: 0;
        }
        .url-action-btn {
            background-color: transparent;
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .url-action-btn:hover {
            background-color: var(--accent-danger);
            color: white;
            border-color: var(--accent-danger);
        }
        .url-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-style: italic;
        }
    </style>
</head>
<body class="no-transition">
    <!-- Theme Toggle Button -->
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
        üåô
    </button>
    
    <!-- History Button -->
    <button id="history-button" class="history-button" aria-label="View history">
        üìú
    </button>
    
    <div class="container">

        <a href="https://github.com/Charly-bite" target="_blank" class="logo-link" rel="noopener noreferrer">
            <img src="{{ url_for('static', filename='Favicon Gabo 128x128.png') }}" alt="GitHub Profile">
        </a>

        <div class="header-container">
            <!-- Added ID for translation -->
            <h1 id="main-heading">Phishing Detector</h1>
            <!-- Added Language Toggle Button -->
            <button id="lang-toggle" class="lang-button">Espa√±ol</button>
        </div>

        {% if model_error %}
            <div class="model-error">{{ model_error }}</div>
        {% endif %}

        <form id="email-form">
             <!-- Added ID for translation -->
            <label for="email_text" id="textarea-label">Enter the email text below:</label>
            
            <!-- File Upload Section -->
            <div class="file-upload-section" id="file-upload-section">
                <div class="file-upload-wrapper">
                    <input type="file" id="file-input" accept=".eml,.msg,.txt,.html" style="display: none;">
                    <div class="file-upload-area" id="file-upload-area">
                        <div class="file-upload-icon">üìé</div>
                        <div class="file-upload-text">
                            <span class="file-upload-title" id="file-upload-title">Click or drag to upload email file</span>
                            <span class="file-upload-subtitle" id="file-upload-subtitle">Supported: .eml, .msg, .txt, .html</span>
                        </div>
                    </div>
                    <div class="file-preview" id="file-preview" style="display: none;">
                        <div class="file-preview-header">
                            <span class="file-preview-name" id="file-preview-name"></span>
                            <button type="button" class="file-preview-remove" id="file-preview-remove">‚úï</button>
                        </div>
                        <div class="file-preview-info" id="file-preview-info"></div>
                    </div>
                </div>
            </div>
            
            <!-- Example Selector Section -->
            <div class="examples-section">
                <div class="examples-header">
                    <h3 id="examples-header-title">üìö Try Example Emails</h3>
                    <button type="button" class="examples-toggle" id="examples-toggle" onclick="toggleExamples()">
                        <span id="examples-toggle-text">Show Examples</span> <span id="examples-toggle-icon">‚ñº</span>
                    </button>
                </div>
                
                <div class="examples-content" id="examples-content" style="display: none;">
                    <p class="examples-description" id="examples-description">
                        Learn to identify phishing by testing real examples. Click any category below:
                    </p>
                    
                    <div class="examples-categories">
                        <!-- Phishing Examples -->
                        <div class="example-category">
                            <div class="category-title phishing-category">
                                <span class="category-icon">üö®</span>
                                <span id="category-phishing-title">Phishing Examples</span>
                            </div>
                            <div class="example-buttons">
                                <button type="button" class="example-btn phishing-btn" onclick="loadExample('phishing_bank')">
                                    <span class="example-emoji">üè¶</span>
                                    <span class="example-text">
                                        <span class="example-name" id="example-bank-name">Fake Bank</span>
                                        <span class="example-desc" id="example-bank-desc">Urgent account verification</span>
                                    </span>
                                </button>
                                <button type="button" class="example-btn phishing-btn" onclick="loadExample('phishing_prize')">
                                    <span class="example-emoji">üéÅ</span>
                                    <span class="example-text">
                                        <span class="example-name" id="example-prize-name">Fake Prize</span>
                                        <span class="example-desc" id="example-prize-desc">You won a lottery</span>
                                    </span>
                                </button>
                                <button type="button" class="example-btn phishing-btn" onclick="loadExample('phishing_social')">
                                    <span class="example-emoji">üì±</span>
                                    <span class="example-text">
                                        <span class="example-name" id="example-social-name">Social Media</span>
                                        <span class="example-desc" id="example-social-desc">Account security alert</span>
                                    </span>
                                </button>
                                <button type="button" class="example-btn phishing-btn" onclick="loadExample('phishing_urgency')">
                                    <span class="example-emoji">‚ö†Ô∏è</span>
                                    <span class="example-text">
                                        <span class="example-name" id="example-urgency-name">Urgent Action</span>
                                        <span class="example-desc" id="example-urgency-desc">Immediate response needed</span>
                                    </span>
                                </button>
                                <button type="button" class="example-btn phishing-btn" onclick="loadExample('phishing_shipping')">
                                    <span class="example-emoji">üì¶</span>
                                    <span class="example-text">
                                        <span class="example-name" id="example-shipping-name">Fake Delivery</span>
                                        <span class="example-desc" id="example-shipping-desc">Package delivery issue</span>
                                    </span>
                                </button>
                                <button type="button" class="example-btn phishing-btn" onclick="loadExample('phishing_tax')">
                                    <span class="example-emoji">üí∞</span>
                                    <span class="example-text">
                                        <span class="example-name" id="example-tax-name">Tax Refund</span>
                                        <span class="example-desc" id="example-tax-desc">Government refund scam</span>
                                    </span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Legitimate Examples -->
                        <div class="example-category">
                            <div class="category-title legitimate-category">
                                <span class="category-icon">‚úÖ</span>
                                <span id="category-legitimate-title">Legitimate Examples</span>
                            </div>
                            <div class="example-buttons">
                                <button type="button" class="example-btn legitimate-btn" onclick="loadExample('legitimate_work')">
                                    <span class="example-emoji">üíº</span>
                                    <span class="example-text">
                                        <span class="example-name" id="example-work-name">Work Meeting</span>
                                        <span class="example-desc" id="example-work-desc">Team meeting reminder</span>
                                    </span>
                                </button>
                                <button type="button" class="example-btn legitimate-btn" onclick="loadExample('legitimate_service')">
                                    <span class="example-emoji">üõí</span>
                                    <span class="example-text">
                                        <span class="example-name" id="example-service-name">Order Confirmed</span>
                                        <span class="example-desc" id="example-service-desc">Purchase confirmation</span>
                                    </span>
                                </button>
                                <button type="button" class="example-btn legitimate-btn" onclick="loadExample('legitimate_newsletter')">
                                    <span class="example-emoji">üì∞</span>
                                    <span class="example-text">
                                        <span class="example-name" id="example-newsletter-name">Newsletter</span>
                                        <span class="example-desc" id="example-newsletter-desc">Company updates</span>
                                    </span>
                                </button>
                                <button type="button" class="example-btn legitimate-btn" onclick="loadExample('legitimate_receipt')">
                                    <span class="example-emoji">üßæ</span>
                                    <span class="example-text">
                                        <span class="example-name" id="example-receipt-name">Receipt</span>
                                        <span class="example-desc" id="example-receipt-desc">Payment receipt</span>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Added placeholder attribute -->
            <textarea
                id="email_text"
                name="email_text"
                required
                placeholder="Paste the full email content here, not just the address..."
                >{{ email_text or '' }}</textarea>

            <div class="button-container">
                 <!-- Added ID for translation -->
                <button type="submit" class="analyze-button" id="analyze-button">Analyze Email</button>
                 <!-- Added ID for translation -->
                <button type="button" class="clear-button" id="clear-button" onclick="clearTextArea()">Clear Text</button>
            </div>
        </form>

        <!-- Added ID for the result container -->
        <div id="result-area">
            {% if prediction_text %}
                <div class="result {% if 'Phishing' in prediction_text %}phishing{% elif 'Legitimate' in prediction_text %}legitimate{% else %}error{% endif %}">
                    {{ prediction_text }}
                </div>
            {% endif %}
        </div>

        <!-- URL Analysis Section -->
        <div id="url-analysis-section" style="display: none;">
            <div class="url-analysis-container">
                <div class="url-analysis-header">
                    <h3 id="url-analysis-title">üîó URLs Detected</h3>
                    <span id="url-count-badge" class="url-count-badge">0</span>
                </div>
                <div id="url-list" class="url-list">
                    <!-- URLs will be inserted here -->
                </div>
            </div>
        </div>

        <div class="footer">
            Contact: <a href="mailto:carlos.aceves6195@alumnos.udg.mx">carlos.aceves6195@alumnos.udg.mx</a>
        </div>
    </div>

    <script>
        // --- Security: HTML Sanitization Functions ---
        /**
         * Sanitizes HTML to prevent XSS attacks
         * @param {string} str - The string to sanitize
         * @returns {string} - Sanitized string safe for innerHTML
         */
        function sanitizeHTML(str) {
            if (!str) return '';
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }
        
        /**
         * Creates safe HTML elements with text content
         * @param {string} tag - HTML tag name
         * @param {string} text - Text content
         * @param {string} className - Optional CSS class
         * @returns {HTMLElement} - Safe DOM element
         */
        function createSafeElement(tag, text, className = '') {
            const element = document.createElement(tag);
            element.textContent = text;
            if (className) element.className = className;
            return element;
        }
        
        /**
         * Truncates text to maximum length
         * @param {string} text - Text to truncate
         * @param {number} maxLength - Maximum length
         * @returns {string} - Truncated text
         */
        function truncateText(text, maxLength) {
            if (!text || text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '... [truncated]';
        }
        
        // --- Conditional Logging (Production-Safe) ---
        // Set to false for production deployment
        const DEBUG_MODE = true; // Change to false in production
        
        const logger = {
            info: DEBUG_MODE ? console.log.bind(console) : function() {},
            warn: DEBUG_MODE ? console.warn.bind(console) : function() {},
            error: DEBUG_MODE ? console.error.bind(console) : function() {},
            debug: DEBUG_MODE ? console.debug.bind(console) : function() {}
        };
        
        // --- localStorage Encryption Functions ---
        /**
         * Obfuscates data before storing (basic protection)
         * For production, consider using Web Crypto API for real encryption
         * @param {object} data - Data to obfuscate
         * @returns {string} - Obfuscated string
         */
        function obfuscateData(data) {
            try {
                const jsonStr = JSON.stringify(data);
                // Simple base64 encoding (not true encryption, but better than plain text)
                return btoa(encodeURIComponent(jsonStr));
            } catch (error) {
                logger.error('Error obfuscating data:', error);
                return null;
            }
        }
        
        /**
         * Deobfuscates data from storage
         * @param {string} obfuscatedStr - Obfuscated string
         * @returns {object} - Original data
         */
        function deobfuscateData(obfuscatedStr) {
            try {
                if (!obfuscatedStr) return null;
                const jsonStr = decodeURIComponent(atob(obfuscatedStr));
                return JSON.parse(jsonStr);
            } catch (error) {
                logger.error('Error deobfuscating data:', error);
                return null;
            }
        }
        
        // Wait for the HTML to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- Theme Toggle Logic ---
            const themeToggle = document.getElementById('theme-toggle');
            const html = document.documentElement;
            
            // Helper function to get CSS variable values
            function getCSSVar(varName) {
                return getComputedStyle(html).getPropertyValue(varName).trim();
            }
            
            // Load saved theme or default to dark
            const savedTheme = localStorage.getItem('theme') || 'dark';
            html.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            // Remove no-transition class after initial load
            setTimeout(() => {
                document.body.classList.remove('no-transition');
            }, 100);
            
            // Theme toggle handler
            themeToggle.addEventListener('click', function() {
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });
            
            // Update theme icon
            function updateThemeIcon(theme) {
                themeToggle.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
                themeToggle.setAttribute('aria-label', theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
            }
            
            // --- History Management Functions ---
            const HISTORY_KEY = 'dory_analysis_history';
            const MAX_HISTORY_ITEMS = 10;
            const MAX_EMAIL_LENGTH = 5000; // 5KB per email
            const MAX_STORAGE_SIZE = 1000000; // ~1MB total storage
            
            // ENCRYPTION: Get history from localStorage with decryption
            function getHistory() {
                try {
                    const obfuscatedData = localStorage.getItem(HISTORY_KEY);
                    if (!obfuscatedData) return [];
                    
                    // Try to deobfuscate (encrypted format)
                    let parsed = deobfuscateData(obfuscatedData);
                    
                    // Fallback: try plain JSON (for backward compatibility)
                    if (!parsed) {
                        try {
                            parsed = JSON.parse(obfuscatedData);
                            // If successful, re-save in encrypted format
                            if (Array.isArray(parsed)) {
                                const encrypted = obfuscateData(parsed);
                                if (encrypted) {
                                    localStorage.setItem(HISTORY_KEY, encrypted);
                                }
                            }
                        } catch (e) {
                            logger.warn('Could not parse as plain JSON either');
                            parsed = null;
                        }
                    }
                    
                    // Validate that it's an array
                    if (!Array.isArray(parsed)) {
                        logger.warn('Invalid history format, resetting...');
                        localStorage.removeItem(HISTORY_KEY);
                        return [];
                    }
                    
                    return parsed;
                } catch (error) {
                    logger.error('Error reading history:', error);
                    // Clear corrupted data
                    try {
                        localStorage.removeItem(HISTORY_KEY);
                    } catch (e) {
                        logger.error('Cannot clear storage:', e);
                    }
                    return [];
                }
            }
            
            // Save analysis to history with size limits and sanitization
            function saveToHistory(emailText, prediction, confidence, data) {
                try {
                    // Sanitize and truncate email text for storage
                    const truncatedEmail = truncateText(emailText, MAX_EMAIL_LENGTH);
                    
                    const history = getHistory();
                    const newEntry = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        email_text: truncatedEmail, // Use truncated version
                        prediction: prediction,
                        confidence: confidence,
                        is_phishing: data.is_phishing,
                        risk_score: data.risk_score || 0,
                        threats_detected: data.threats_detected || [],
                        google_safe_browsing: data.google_safe_browsing || null
                    };
                    
                    // Add to beginning of array
                    history.unshift(newEntry);
                    
                    // Keep only last MAX_HISTORY_ITEMS
                    if (history.length > MAX_HISTORY_ITEMS) {
                        history.splice(MAX_HISTORY_ITEMS);
                    }
                    
                    // ENCRYPTION: Obfuscate before saving
                    const obfuscatedHistory = obfuscateData(history);
                    
                    if (!obfuscatedHistory) {
                        logger.error('Failed to obfuscate history data');
                        return;
                    }
                    
                    // Check storage size before saving
                    if (obfuscatedHistory.length > MAX_STORAGE_SIZE) {
                        logger.warn('History too large, reducing to 5 items...');
                        history.splice(5); // Keep only 5 most recent
                        const reducedObfuscated = obfuscateData(history);
                        if (reducedObfuscated) {
                            localStorage.setItem(HISTORY_KEY, reducedObfuscated);
                        }
                    } else {
                        localStorage.setItem(HISTORY_KEY, obfuscatedHistory);
                    }
                    
                    updateHistoryBadge();
                    
                } catch (error) {
                    // Handle QuotaExceededError
                    if (error.name === 'QuotaExceededError') {
                        logger.error('Storage quota exceeded, clearing old history...');
                        const currentLang = localStorage.getItem('preferredLang') || 'es';
                        const message = currentLang === 'es' 
                            ? 'Almacenamiento lleno. Limpiando historial antiguo...'
                            : 'Storage full. Clearing old history...';
                        alert(message);
                        
                        // Try to save with reduced history
                        try {
                            const reducedHistory = [newEntry]; // Keep only current item
                            const obfuscated = obfuscateData(reducedHistory);
                            if (obfuscated) {
                                localStorage.setItem(HISTORY_KEY, obfuscated);
                            }
                            updateHistoryBadge();
                        } catch (e) {
                            logger.error('Cannot save even reduced history:', e);
                        }
                    } else {
                        logger.error('Error saving to history:', error);
                    }
                }
            }
            
            // Delete single history item
            function deleteHistoryItem(id) {
                try {
                    let history = getHistory();
                    history = history.filter(item => item.id !== id);
                    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                    updateHistoryBadge();
                    renderHistory();
                } catch (error) {
                    logger.error('Error deleting history item:', error);
                }
            }
            
            // Clear all history
            function clearAllHistory() {
                const currentLang = localStorage.getItem('preferredLang') || 'es';
                const confirmMsg = currentLang === 'es' 
                    ? '¬øEst√°s seguro de que quieres borrar todo el historial?' 
                    : 'Are you sure you want to clear all history?';
                
                if (confirm(confirmMsg)) {
                    localStorage.removeItem(HISTORY_KEY);
                    updateHistoryBadge();
                    renderHistory();
                }
            }
            
            // Export history as JSON
            function exportHistory() {
                try {
                    const history = getHistory();
                    if (history.length === 0) {
                        const currentLang = localStorage.getItem('preferredLang') || 'es';
                        alert(currentLang === 'es' ? 'No hay historial para exportar' : 'No history to export');
                        return;
                    }
                    
                    const dataStr = JSON.stringify(history, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `dory-analysis-history-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    logger.error('Error exporting history:', error);
                }
            }
            
            // Load history item into textarea
            function loadHistoryItem(id) {
                try {
                    const history = getHistory();
                    const item = history.find(h => h.id === id);
                    if (item) {
                        const emailTextarea = document.getElementById('email_text');
                        emailTextarea.value = item.email_text;
                        closeHistoryModal();
                        
                        // Scroll to textarea
                        emailTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Optional: auto-analyze
                        // document.getElementById('email-form').dispatchEvent(new Event('submit'));
                    }
                } catch (error) {
                    logger.error('Error loading history item:', error);
                }
            }
            
            // Render history in modal
            function renderHistory() {
                const history = getHistory();
                const historyList = document.getElementById('history-list');
                const historyCount = document.getElementById('history-count');
                const currentLang = localStorage.getItem('preferredLang') || 'es';
                
                // Calculate statistics
                const phishingCount = history.filter(item => item.is_phishing).length;
                const legitimateCount = history.length - phishingCount;
                
                // Update count with statistics
                const countText = currentLang === 'es' 
                    ? `${history.length} an√°lisis total | üî¥ ${phishingCount} phishing | üü¢ ${legitimateCount} leg√≠timos` 
                    : `${history.length} analyses | üî¥ ${phishingCount} phishing | üü¢ ${legitimateCount} legitimate`;
                historyCount.textContent = countText;
                
                // Render items or empty state
                if (history.length === 0) {
                    historyList.innerHTML = `
                        <div class="history-empty">
                            <div class="history-empty-icon">üì≠</div>
                            <div class="history-empty-text">${currentLang === 'es' ? 'No hay historial a√∫n' : 'No history yet'}</div>
                            <div class="history-empty-subtext">${currentLang === 'es' ? 'Los an√°lisis que realices aparecer√°n aqu√≠' : 'Your analyses will appear here'}</div>
                        </div>
                    `;
                } else {
                    // Clear existing content
                    historyList.innerHTML = '';
                    
                    history.forEach(item => {
                        const date = new Date(item.timestamp);
                        const dateStr = date.toLocaleString(currentLang === 'es' ? 'es-ES' : 'en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        const resultClass = item.is_phishing ? 'phishing' : 'legitimate';
                        const resultText = item.is_phishing 
                            ? (currentLang === 'es' ? '‚ö†Ô∏è Phishing' : '‚ö†Ô∏è Phishing')
                            : (currentLang === 'es' ? '‚úì Leg√≠timo' : '‚úì Legitimate');
                        
                        // SECURITY: Sanitize email preview
                        const sanitizedPreview = sanitizeHTML(item.email_text);
                        const preview = sanitizedPreview.substring(0, 150) + (sanitizedPreview.length > 150 ? '...' : '');
                        
                        const loadBtnText = currentLang === 'es' ? 'üìù Cargar' : 'üìù Load';
                        const deleteBtnText = currentLang === 'es' ? 'üóëÔ∏è Borrar' : 'üóëÔ∏è Delete';
                        
                        // Create history item using DOM methods (safer than innerHTML)
                        const historyItemDiv = document.createElement('div');
                        historyItemDiv.className = 'history-item';
                        
                        // Create header
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'history-item-header';
                        
                        const dateSpan = document.createElement('span');
                        dateSpan.className = 'history-item-date';
                        dateSpan.textContent = dateStr;
                        
                        const resultSpan = document.createElement('span');
                        resultSpan.className = `history-item-result ${resultClass}`;
                        resultSpan.textContent = resultText;
                        
                        headerDiv.appendChild(dateSpan);
                        headerDiv.appendChild(resultSpan);
                        
                        // Create preview
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'history-item-preview';
                        previewDiv.textContent = preview;
                        
                        // Create actions
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'history-item-actions';
                        
                        const loadBtn = document.createElement('button');
                        loadBtn.className = 'history-item-btn load';
                        loadBtn.textContent = loadBtnText;
                        loadBtn.onclick = () => loadHistoryItem(item.id);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'history-item-btn delete';
                        deleteBtn.textContent = deleteBtnText;
                        deleteBtn.onclick = () => deleteHistoryItem(item.id);
                        
                        actionsDiv.appendChild(loadBtn);
                        actionsDiv.appendChild(deleteBtn);
                        
                        // Assemble the item
                        historyItemDiv.appendChild(headerDiv);
                        historyItemDiv.appendChild(previewDiv);
                        historyItemDiv.appendChild(actionsDiv);
                        
                        // Add to history list
                        historyList.appendChild(historyItemDiv);
                    });
                }
            }
            
            // Update history badge count
            function updateHistoryBadge() {
                const history = getHistory();
                const historyButton = document.getElementById('history-button');
                
                // Remove old badge if exists
                const oldBadge = historyButton.querySelector('.history-badge');
                if (oldBadge) {
                    oldBadge.remove();
                }
                
                // Add new badge if there's history
                if (history.length > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'history-badge';
                    badge.textContent = history.length;
                    historyButton.appendChild(badge);
                }
            }
            
            // MEMORY LEAK FIX: Named function for modal click handler
            function handleModalOutsideClick(e) {
                if (e.target === this) {
                    closeHistoryModal();
                }
            }
            
            // Open history modal
            function openHistoryModal() {
                renderHistory();
                const modal = document.getElementById('history-modal');
                modal.classList.add('active');
                
                // Add listener only when modal opens
                modal.addEventListener('click', handleModalOutsideClick);
            }
            
            // Close history modal
            function closeHistoryModal() {
                const modal = document.getElementById('history-modal');
                modal.classList.remove('active');
                
                // Remove listener when modal closes (prevent memory leak)
                modal.removeEventListener('click', handleModalOutsideClick);
            }
            
            // History button click handler
            const historyButton = document.getElementById('history-button');
            if (historyButton) {
                historyButton.addEventListener('click', openHistoryModal);
            }
            
            // Initialize badge on load
            updateHistoryBadge();

            // --- File Upload Functionality ---
            const fileInput = document.getElementById('file-input');
            const fileUploadArea = document.getElementById('file-upload-area');
            const filePreview = document.getElementById('file-preview');
            const filePreviewName = document.getElementById('file-preview-name');
            const filePreviewInfo = document.getElementById('file-preview-info');
            const filePreviewRemove = document.getElementById('file-preview-remove');
            const emailTextarea = document.getElementById('email_text');

            // Click to upload
            fileUploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // MEMORY LEAK FIX: Named handlers for drag and drop
            function handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                fileUploadArea.classList.add('dragover');
            }
            
            function handleDragLeave(e) {
                e.preventDefault();
                e.stopPropagation();
                fileUploadArea.classList.remove('dragover');
            }
            
            function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                fileUploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            }
            
            function handleRemoveFile(e) {
                e.stopPropagation();
                removeFile();
            }
            
            // Attach event listeners (only once)
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            if (fileUploadArea) {
                fileUploadArea.addEventListener('dragover', handleDragOver);
                fileUploadArea.addEventListener('dragleave', handleDragLeave);
                fileUploadArea.addEventListener('drop', handleDrop);
            }
            
            if (filePreviewRemove) {
                filePreviewRemove.addEventListener('click', handleRemoveFile);
            }

            // Handle file selection
            function handleFileSelect(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            }

            // Process the file
            function handleFile(file) {
                // Validate file type
                const validExtensions = ['.eml', '.msg', '.txt', '.html', '.htm'];
                const fileName = file.name.toLowerCase();
                const isValid = validExtensions.some(ext => fileName.endsWith(ext));

                if (!isValid) {
                    const currentLang = localStorage.getItem('preferredLang') || 'es';
                    const errorMsg = currentLang === 'es' 
                        ? 'Tipo de archivo no v√°lido. Por favor sube archivos .eml, .msg, .txt o .html'
                        : 'Invalid file type. Please upload .eml, .msg, .txt or .html files';
                    alert(errorMsg);
                    return;
                }

                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    const currentLang = localStorage.getItem('preferredLang') || 'es';
                    const errorMsg = currentLang === 'es'
                        ? 'El archivo es demasiado grande. M√°ximo 5MB'
                        : 'File is too large. Maximum 5MB';
                    alert(errorMsg);
                    return;
                }

                // Read file content
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    
                    // Set textarea content
                    emailTextarea.value = content;
                    
                    // Show preview
                    showFilePreview(file, content);
                };
                reader.onerror = function() {
                    const currentLang = localStorage.getItem('preferredLang') || 'es';
                    const errorMsg = currentLang === 'es'
                        ? 'Error al leer el archivo'
                        : 'Error reading file';
                    alert(errorMsg);
                };
                reader.readAsText(file);
            }

            // Show file preview
            function showFilePreview(file, content) {
                const currentLang = localStorage.getItem('preferredLang') || 'es';
                
                // Hide upload area, show preview
                fileUploadArea.style.display = 'none';
                filePreview.style.display = 'block';
                
                // Set file name
                filePreviewName.textContent = file.name;
                
                // Set file info
                const fileSize = (file.size / 1024).toFixed(2);
                const lines = content.split('\n').length;
                const chars = content.length;
                
                const infoText = currentLang === 'es'
                    ? `Tama√±o: ${fileSize} KB | L√≠neas: ${lines} | Caracteres: ${chars}`
                    : `Size: ${fileSize} KB | Lines: ${lines} | Characters: ${chars}`;
                
                filePreviewInfo.textContent = infoText;
            }

            // Remove file
            function removeFile() {
                // Reset file input
                fileInput.value = '';
                
                // Clear textarea
                emailTextarea.value = '';
                
                // Hide preview, show upload area
                filePreview.style.display = 'none';
                fileUploadArea.style.display = 'flex';
            }

            // --- URL Analysis Functionality ---
            
            // REDOS PROTECTION: Extract URLs from text with safety limits
            function extractURLs(text) {
                // Limit text length to prevent ReDoS
                const MAX_TEXT_LENGTH = 50000;
                if (text.length > MAX_TEXT_LENGTH) {
                    logger.warn('Text too long for URL extraction, truncating...');
                    text = text.substring(0, MAX_TEXT_LENGTH);
                }
                
                // Simplified regex - less complex, safer against ReDoS
                // Matches http(s):// URLs and www. URLs with max length limit
                const urlRegex = /https?:\/\/[^\s<>"']{1,500}|www\.[^\s<>"']{1,500}/gi;
                const matches = text.match(urlRegex) || [];
                
                // Limit number of URLs processed
                const MAX_URLS = 50;
                const limitedMatches = matches.slice(0, MAX_URLS);
                
                if (matches.length > MAX_URLS) {
                    logger.warn(`Found ${matches.length} URLs, processing only first ${MAX_URLS}`);
                }
                
                // Clean and normalize URLs
                return limitedMatches.map(url => {
                    url = url.trim();
                    
                    // Remove trailing punctuation
                    url = url.replace(/[.,;:!?)]+$/, '');
                    
                    // Add http:// if missing
                    if (!url.match(/^https?:\/\//i)) {
                        url = 'http://' + url;
                    }
                    return url;
                }).filter((url, index, self) => self.indexOf(url) === index); // Remove duplicates
            }
            
            // SECURITY: Analyze URL for suspicious characteristics with validation
            function analyzeURL(url) {
                const analysis = {
                    url: url,
                    riskLevel: 'low',
                    riskScore: 0,
                    flags: []
                };
                
                try {
                    // Validate URL length
                    if (url.length > 2000) {
                        analysis.riskScore += 30;
                        analysis.flags.push({ type: 'high', text: 'Extremely long URL' });
                        analysis.riskLevel = 'high';
                        return analysis;
                    }
                    
                    const urlObj = new URL(url);
                    const domain = urlObj.hostname.toLowerCase();
                    const path = urlObj.pathname.toLowerCase();
                    const fullURL = url.toLowerCase();
                    
                    // Check for IP address instead of domain
                    if (/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(domain)) {
                        analysis.flags.push({ type: 'ip-address', text: '‚ö†Ô∏è IP Address' });
                        analysis.riskScore += 30;
                    }
                    
                    // Check for suspicious TLDs
                    const suspiciousTLDs = ['.tk', '.ml', '.ga', '.cf', '.gq', '.xyz', '.top', '.club', '.work', '.date', '.racing', '.download'];
                    if (suspiciousTLDs.some(tld => domain.endsWith(tld))) {
                        analysis.flags.push({ type: 'suspicious-tld', text: '‚ö†Ô∏è Suspicious TLD' });
                        analysis.riskScore += 20;
                    }
                    
                    // Check for phishing keywords in URL
                    const phishingKeywords = ['verify', 'account', 'update', 'secure', 'banking', 'login', 'signin', 'suspended', 'locked', 'confirm', 'password', 'credential'];
                    if (phishingKeywords.some(keyword => fullURL.includes(keyword))) {
                        analysis.flags.push({ type: 'phishing-keywords', text: 'üö® Phishing Keywords' });
                        analysis.riskScore += 25;
                    }
                    
                    // Check for suspicious domain keywords
                    const suspiciousDomainKeywords = ['paypal', 'amazon', 'microsoft', 'google', 'apple', 'facebook', 'instagram', 'netflix', 'bank', 'secure', 'account', 'verify'];
                    const hasSuspiciousDomain = suspiciousDomainKeywords.some(keyword => {
                        return domain.includes(keyword) && !domain.includes(keyword + '.com') && !domain.endsWith(keyword + '.com');
                    });
                    if (hasSuspiciousDomain) {
                        analysis.flags.push({ type: 'suspicious-domain', text: 'üö® Suspicious Domain' });
                        analysis.riskScore += 35;
                    }
                    
                    // Check for URL shorteners
                    const shorteners = ['bit.ly', 'tinyurl.com', 't.co', 'goo.gl', 'ow.ly', 'is.gd', 'buff.ly', 'adf.ly', 'bit.do', 'cutt.ly', 'short.io'];
                    if (shorteners.some(shortener => domain.includes(shortener))) {
                        analysis.flags.push({ type: 'shortened', text: '‚ö†Ô∏è Shortened URL' });
                        analysis.riskScore += 15;
                    }
                    
                    // Check for long subdomains (often used in phishing)
                    const subdomains = domain.split('.');
                    if (subdomains.length > 4) {
                        analysis.flags.push({ type: 'long-subdomain', text: '‚ö†Ô∏è Long Subdomain' });
                        analysis.riskScore += 15;
                    }
                    
                    // Check for HTTP instead of HTTPS
                    if (urlObj.protocol === 'http:') {
                        analysis.flags.push({ type: 'http-not-secure', text: '‚ö†Ô∏è Not HTTPS' });
                        analysis.riskScore += 10;
                    }
                    
                    // Determine risk level
                    if (analysis.riskScore >= 50) {
                        analysis.riskLevel = 'high';
                    } else if (analysis.riskScore >= 25) {
                        analysis.riskLevel = 'medium';
                    } else {
                        analysis.riskLevel = 'low';
                        if (analysis.flags.length === 0) {
                            analysis.flags.push({ type: 'safe', text: '‚úÖ Looks Safe' });
                        }
                    }
                    
                } catch (error) {
                    logger.error('Error analyzing URL:', error);
                    analysis.flags.push({ type: 'suspicious-domain', text: '‚ö†Ô∏è Invalid URL' });
                    analysis.riskLevel = 'medium';
                }
                
                return analysis;
            }
            
            // Display URLs in the UI
            function displayURLs(text) {
                const urls = extractURLs(text);
                const urlSection = document.getElementById('url-analysis-section');
                const urlList = document.getElementById('url-list');
                const urlCountBadge = document.getElementById('url-count-badge');
                const currentLang = localStorage.getItem('preferredLang') || 'es';
                
                if (urls.length === 0) {
                    urlSection.style.display = 'none';
                    return;
                }
                
                // Update count
                urlCountBadge.textContent = urls.length;
                
                // Analyze and display each URL
                let html = '';
                urls.forEach((url, index) => {
                    const analysis = analyzeURL(url);
                    
                    const flagsHTML = analysis.flags.map(flag => 
                        `<span class="url-flag ${flag.type}">${flag.text}</span>`
                    ).join('');
                    
                    html += `
                        <div class="url-item">
                            <div class="url-risk-indicator ${analysis.riskLevel}"></div>
                            <div class="url-content">
                                <div class="url-text">${url}</div>
                                <div class="url-flags">${flagsHTML}</div>
                            </div>
                            <div class="url-actions">
                                <button class="url-action-btn" onclick="copyURL('${url.replace(/'/g, "\\'")}')">
                                    ${currentLang === 'es' ? 'üìã Copiar' : 'üìã Copy'}
                                </button>
                                <button class="url-action-btn" onclick="openURL('${url.replace(/'/g, "\\'")}')">
                                    ${currentLang === 'es' ? 'üîó Abrir' : 'üîó Open'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                urlList.innerHTML = html;
                urlSection.style.display = 'block';
            }
            
            // Copy URL to clipboard
            window.copyURL = function(url) {
                navigator.clipboard.writeText(url).then(() => {
                    const currentLang = localStorage.getItem('preferredLang') || 'es';
                    const message = currentLang === 'es' ? 'URL copiada al portapapeles' : 'URL copied to clipboard';
                    alert(message);
                }).catch(err => {
                    logger.error('Error copying URL:', err);
                });
            };
            
            // Open URL (with warning)
            window.openURL = function(url) {
                const currentLang = localStorage.getItem('preferredLang') || 'es';
                const warningMsg = currentLang === 'es'
                    ? '‚ö†Ô∏è ADVERTENCIA: Esta URL puede ser peligrosa. ¬øEst√°s seguro de que quieres abrirla?'
                    : '‚ö†Ô∏è WARNING: This URL may be dangerous. Are you sure you want to open it?';
                    
                if (confirm(warningMsg)) {
                    window.open(url, '_blank', 'noopener,noreferrer');
                }
            };

            // --- Elements to Translate ---
            const elements = {
                mainHeading: document.getElementById('main-heading'),
                textareaLabel: document.getElementById('textarea-label'),
                analyzeButton: document.getElementById('analyze-button'),
                clearButton: document.getElementById('clear-button'),
                langToggleButton: document.getElementById('lang-toggle'),
                emailTextarea: document.getElementById('email_text'), // Reference to textarea for placeholder
                exampleSelector: document.getElementById('example-selector'),
                exampleOptionDefault: document.getElementById('example-option-default'),
                exampleOptionBank: document.getElementById('example-option-bank'),
                exampleOptionPrize: document.getElementById('example-option-prize'),
                exampleOptionSocial: document.getElementById('example-option-social'),
                exampleOptionUrgency: document.getElementById('example-option-urgency'),
                exampleOptionWork: document.getElementById('example-option-work'),
                exampleOptionService: document.getElementById('example-option-service'),
                historyModalTitle: document.getElementById('history-modal-title'),
                exportBtnText: document.getElementById('export-btn-text'),
                clearBtnText: document.getElementById('clear-btn-text'),
                fileUploadTitle: document.getElementById('file-upload-title'),
                fileUploadSubtitle: document.getElementById('file-upload-subtitle'),
                urlAnalysisTitle: document.getElementById('url-analysis-title'),
            };

            // --- Example Emails ---
            const examples = {
                phishing_bank: {
                    en: "URGENT: SECURITY ALERT\n\nDear valued customer,\n\nYour Bank of America account has been LOCKED due to suspicious activity detected from Nigeria. You must verify your identity IMMEDIATELY or your account will be permanently closed within 24 hours.\n\nClick here to verify now: http://bankofamerica-secure-login.tk/verify?id=8472910\n\nDO NOT ignore this message. Failure to act will result in permanent loss of access to your funds.\n\nBank Security Team\n(This is an automated message, do not reply)",
                    es: "URGENTE: ALERTA DE SEGURIDAD\n\nEstimado cliente,\n\nSu cuenta de Banco Santander ha sido BLOQUEADA debido a actividad sospechosa detectada desde el extranjero. Debe verificar su identidad INMEDIATAMENTE o su cuenta ser√° cerrada permanentemente en las pr√≥ximas 24 horas.\n\nHaga clic aqu√≠ para verificar ahora: http://bancosantander-verificacion.tk/login?id=8472910\n\nNO ignore este mensaje. Si no act√∫a, perder√° acceso permanente a sus fondos.\n\nEquipo de Seguridad Bancaria\n(Este es un mensaje automatizado, no responda)"
                },
                phishing_prize: {
                    en: "üéâ CONGRATULATIONS! YOU'VE WON! üéâ\n\nDear LUCKY WINNER,\n\nYou have been selected as the GRAND PRIZE WINNER of our Apple iPhone 15 Pro Max GIVEAWAY! üì±‚ú®\n\nYour winning number: #847291\nPrize value: $1,299 USD\n\nClaim your FREE iPhone now before it expires:\nüëâ http://apple-prizes-claim.xyz/winner?code=IPHONE2024\n\nHurry! Only 3 hours left to claim!\n\nüéÅ 100% FREE - No purchase necessary!\nüöö FREE International Shipping!\n\nClick NOW or lose your prize forever!",
                    es: "üéâ ¬°FELICIDADES! ¬°HAS GANADO! üéâ\n\nEstimado GANADOR AFORTUNADO,\n\n¬°Has sido seleccionado como GANADOR DEL GRAN PREMIO de nuestro SORTEO de iPhone 15 Pro Max! üì±‚ú®\n\nTu n√∫mero ganador: #847291\nValor del premio: $1,299 USD\n\nReclama tu iPhone GRATIS ahora antes de que expire:\nüëâ http://sorteo-apple-oficial.xyz/ganador?codigo=IPHONE2024\n\n¬°Ap√∫rate! ¬°Solo quedan 3 horas para reclamar!\n\nüéÅ 100% GRATIS - ¬°No requiere compra!\nüöö ¬°Env√≠o Internacional GRATIS!\n\n¬°Haz clic AHORA o pierde tu premio para siempre!"
                },
                phishing_social: {
                    en: "‚ö†Ô∏è Instagram Security Alert ‚ö†Ô∏è\n\nWe detected an unusual login attempt to your account from:\nLocation: Lagos, Nigeria\nDevice: Unknown Android Device\nTime: 2 hours ago\n\nThis wasn't you? Secure your account immediately:\nhttp://instagram-security-check.com/verify/account\n\nIf you don't verify within 12 hours, your account will be permanently deleted to prevent unauthorized access.\n\nInstagram Security Team\n---\nThis is an automated security notification.",
                    es: "‚ö†Ô∏è Alerta de Seguridad de Instagram ‚ö†Ô∏è\n\nDetectamos un intento de inicio de sesi√≥n inusual en tu cuenta desde:\nUbicaci√≥n: Lagos, Nigeria\nDispositivo: Dispositivo Android Desconocido\nHora: Hace 2 horas\n\n¬øNo fuiste t√∫? Asegura tu cuenta inmediatamente:\nhttp://instagram-seguridad-verificar.com/verificar/cuenta\n\nSi no verificas en 12 horas, tu cuenta ser√° eliminada permanentemente para prevenir acceso no autorizado.\n\nEquipo de Seguridad de Instagram\n---\nEsta es una notificaci√≥n de seguridad automatizada."
                },
                phishing_urgency: {
                    en: "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FINAL NOTICE - IMMEDIATE ACTION REQUIRED ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è\n\nYour Microsoft Office 365 subscription will EXPIRE TODAY at 11:59 PM!\n\nAll your files, emails, and documents will be DELETED if you don't renew NOW!\n\n‚ùå Time remaining: 4 hours 23 minutes\n‚ùå Files at risk: 15,847 documents\n‚ùå Emails to be deleted: 9,234 messages\n\nRENEW IMMEDIATELY to avoid data loss:\nüîó http://microsoft-office-renewal.net/urgent/renew\n\nCredit card required for verification. Act now!\n\nMicrosoft Billing Department",
                    es: "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è AVISO FINAL - ACCI√ìN INMEDIATA REQUERIDA ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è\n\n¬°Tu suscripci√≥n a Microsoft Office 365 EXPIRAR√Å HOY a las 11:59 PM!\n\n¬°Todos tus archivos, correos y documentos ser√°n ELIMINADOS si no renuevas AHORA!\n\n‚ùå Tiempo restante: 4 horas 23 minutos\n‚ùå Archivos en riesgo: 15,847 documentos\n‚ùå Correos a eliminar: 9,234 mensajes\n\nRENUEVA INMEDIATAMENTE para evitar p√©rdida de datos:\nüîó http://microsoft-office-renovacion.net/urgente/renovar\n\nTarjeta de cr√©dito requerida para verificaci√≥n. ¬°Act√∫a ahora!\n\nDepartamento de Facturaci√≥n de Microsoft"
                },
                phishing_shipping: {
                    en: "üì¶ DHL Express - Package Delivery Failed\n\nTracking Number: DHL847291034\n\nDear Customer,\n\nWe attempted to deliver your package but FAILED due to incomplete address information.\n\nYour package contains: 1 item from Apple Store\nCurrent location: Warehouse - Will be returned in 48 hours\n\n‚ö†Ô∏è URGENT: Update your delivery address to avoid return:\nüîó http://dhl-delivery-update.com/track/847291034\n\nAdditional delivery fee required: $3.99\nEnter your credit card to confirm delivery.\n\n‚ùå Package will be destroyed if not claimed within 2 days!\n\nDHL Customer Service\nDo not reply to this email.",
                    es: "üì¶ DHL Express - Entrega de Paquete Fallida\n\nN√∫mero de Rastreo: DHL847291034\n\nEstimado Cliente,\n\nIntentamos entregar su paquete pero FALL√ì debido a informaci√≥n de direcci√≥n incompleta.\n\nSu paquete contiene: 1 art√≠culo de Apple Store\nUbicaci√≥n actual: Almac√©n - Ser√° devuelto en 48 horas\n\n‚ö†Ô∏è URGENTE: Actualice su direcci√≥n de entrega para evitar devoluci√≥n:\nüîó http://dhl-entrega-actualizar.com/rastreo/847291034\n\nTarifa adicional de entrega requerida: $3.99\nIngrese su tarjeta de cr√©dito para confirmar entrega.\n\n‚ùå ¬°El paquete ser√° destruido si no se reclama en 2 d√≠as!\n\nServicio al Cliente DHL\nNo responda a este correo."
                },
                phishing_tax: {
                    en: "üí∞ IRS Tax Refund Notification\n\nDear Taxpayer,\n\nGood news! You are eligible for a tax refund of $1,847.00 from your 2024 tax return.\n\nRefund Amount: $1,847.00\nTax Year: 2024\nStatus: APPROVED - Pending Action\n\n‚úÖ Claim your refund now (expires in 72 hours):\nüîó http://irs-refund-claim.gov.us/refund?id=2024847291\n\nYou will need to provide:\n- Full Social Security Number\n- Date of Birth\n- Bank Account Details for direct deposit\n\n‚è∞ Hurry! Unclaimed refunds are forfeited after 3 days.\n\nThis is an official notification from the Internal Revenue Service.\nReference: IRS-2024-REF-847291\n\nDo not reply to this email.",
                    es: "üí∞ Notificaci√≥n de Reembolso del SAT\n\nEstimado Contribuyente,\n\n¬°Buenas noticias! Es elegible para un reembolso de impuestos de $1,847.00 de su declaraci√≥n de 2024.\n\nMonto del Reembolso: $1,847.00\nA√±o Fiscal: 2024\nEstado: APROBADO - Acci√≥n Pendiente\n\n‚úÖ Reclame su reembolso ahora (expira en 72 horas):\nüîó http://sat-reembolso-reclamar.gob.mx/reembolso?id=2024847291\n\nNecesitar√° proporcionar:\n- N√∫mero completo de RFC\n- Fecha de Nacimiento\n- Detalles de Cuenta Bancaria para dep√≥sito directo\n\n‚è∞ ¬°Ap√∫rese! Los reembolsos no reclamados se pierden despu√©s de 3 d√≠as.\n\nEsta es una notificaci√≥n oficial del Servicio de Administraci√≥n Tributaria.\nReferencia: SAT-2024-REMB-847291\n\nNo responda a este correo."
                },
                legitimate_work: {
                    en: "Subject: Team Meeting Tomorrow - Project Update\n\nHi everyone,\n\nJust a friendly reminder about our weekly team meeting tomorrow (Tuesday) at 10:00 AM in Conference Room 3.\n\nAgenda:\n- Q4 progress review\n- Upcoming deadlines discussion\n- Resource allocation for next sprint\n\nPlease bring your monthly reports. If you can't attend, let me know by EOD today.\n\nBest regards,\nJohn Smith\nProject Manager\nTech Solutions Inc.",
                    es: "Asunto: Reuni√≥n de Equipo Ma√±ana - Actualizaci√≥n de Proyecto\n\nHola a todos,\n\nSolo un recordatorio amistoso sobre nuestra reuni√≥n semanal de equipo ma√±ana (martes) a las 10:00 AM en la Sala de Conferencias 3.\n\nAgenda:\n- Revisi√≥n de progreso del Q4\n- Discusi√≥n de fechas l√≠mite pr√≥ximas\n- Asignaci√≥n de recursos para el siguiente sprint\n\nPor favor traigan sus reportes mensuales. Si no pueden asistir, av√≠senme antes del fin del d√≠a.\n\nSaludos,\nJuan P√©rez\nGerente de Proyecto\nSoluciones Tecnol√≥gicas S.A."
                },
                legitimate_service: {
                    en: "Order Confirmation - Amazon.com\n\nHello,\n\nThank you for your order! Your package has been shipped and is on its way.\n\nOrder #: 123-4567890-1234567\nShipping Address: 123 Main St, Anytown, ST 12345\nEstimated Delivery: November 5, 2025\n\nYou can track your package at: amazon.com/orders\n(Please log into your account to view tracking details)\n\nItems ordered:\n- Wireless Mouse - $25.99\n- USB-C Cable (2-pack) - $12.99\n\nThank you for shopping with Amazon!\n\nThe Amazon Team",
                    es: "Confirmaci√≥n de Pedido - Amazon.com.mx\n\nHola,\n\n¬°Gracias por tu pedido! Tu paquete ha sido enviado y est√° en camino.\n\nPedido #: 123-4567890-1234567\nDirecci√≥n de Env√≠o: Calle Principal 123, Ciudad, CP 12345\nEntrega Estimada: 5 de noviembre, 2025\n\nPuedes rastrear tu paquete en: amazon.com.mx/pedidos\n(Por favor inicia sesi√≥n en tu cuenta para ver detalles de rastreo)\n\nArt√≠culos ordenados:\n- Mouse Inal√°mbrico - $25.99\n- Cable USB-C (paquete de 2) - $12.99\n\n¬°Gracias por comprar en Amazon!\n\nEl Equipo de Amazon"
                },
                legitimate_newsletter: {
                    en: "üì∞ Weekly Tech Newsletter - November 2025\n\nHello Tech Enthusiasts!\n\nWelcome to this week's edition of our technology newsletter.\n\nüîπ Top Stories This Week:\n- New AI developments in machine learning\n- Cybersecurity best practices for 2025\n- Cloud computing trends analysis\n\nüìö Featured Article:\n\"Understanding Modern Authentication Methods\"\nRead more on our blog: techinsights.com/blog/authentication\n\nüéì Upcoming Webinar:\nDate: November 15, 2025\nTopic: Data Privacy in the Digital Age\nRegister: techinsights.com/webinars\n\nYou're receiving this because you subscribed to Tech Insights Newsletter.\nUnsubscribe: techinsights.com/unsubscribe\n\nBest regards,\nThe Tech Insights Team",
                    es: "üì∞ Bolet√≠n Semanal de Tecnolog√≠a - Noviembre 2025\n\n¬°Hola Entusiastas de la Tecnolog√≠a!\n\nBienvenidos a la edici√≥n de esta semana de nuestro bolet√≠n de tecnolog√≠a.\n\nüîπ Historias Principales de Esta Semana:\n- Nuevos desarrollos en IA y aprendizaje autom√°tico\n- Mejores pr√°cticas de ciberseguridad para 2025\n- An√°lisis de tendencias en computaci√≥n en la nube\n\nüìö Art√≠culo Destacado:\n\"Entendiendo los M√©todos Modernos de Autenticaci√≥n\"\nLee m√°s en nuestro blog: techinsights.com/blog/autenticacion\n\nüéì Webinar Pr√≥ximo:\nFecha: 15 de noviembre, 2025\nTema: Privacidad de Datos en la Era Digital\nRegistrarse: techinsights.com/webinars\n\nEst√°s recibiendo esto porque te suscribiste al Bolet√≠n de Tech Insights.\nDarse de baja: techinsights.com/cancelar-suscripcion\n\nSaludos cordiales,\nEl Equipo de Tech Insights"
                },
                legitimate_receipt: {
                    en: "üßæ Payment Receipt - Stripe\n\nTransaction Successful\n\nThank you for your payment!\n\nReceipt #: rcpt_1234567890\nDate: November 9, 2025\nTime: 10:45 AM EST\n\nBilled to:\nJohn Smith\njohn.smith@email.com\n\nPayment Details:\n- Monthly Subscription: $29.99\n- Tax: $2.40\n- Total: $32.39\n\nPayment Method: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242\nStatus: Paid ‚úì\n\nYour subscription is active until December 9, 2025.\n\nView invoice: stripe.com/invoices/inv_1234567890\n(Login required to view full details)\n\nQuestions? Contact support@company.com\n\nStripe Payments - Secure Payment Processing\nThis email confirms a payment processed through Stripe.",
                    es: "üßæ Recibo de Pago - Stripe\n\nTransacci√≥n Exitosa\n\n¬°Gracias por su pago!\n\nRecibo #: rcpt_1234567890\nFecha: 9 de noviembre, 2025\nHora: 10:45 AM\n\nFacturado a:\nJuan P√©rez\njuan.perez@email.com\n\nDetalles del Pago:\n- Suscripci√≥n Mensual: $29.99\n- Impuesto: $2.40\n- Total: $32.39\n\nM√©todo de Pago: ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242\nEstado: Pagado ‚úì\n\nSu suscripci√≥n est√° activa hasta el 9 de diciembre, 2025.\n\nVer factura: stripe.com/facturas/inv_1234567890\n(Se requiere inicio de sesi√≥n para ver detalles completos)\n\n¬øPreguntas? Contacte a soporte@empresa.com\n\nStripe Payments - Procesamiento Seguro de Pagos\nEste correo confirma un pago procesado a trav√©s de Stripe."
                }
            };

            // --- Translations ---
            const translations = {
                en: {
                    mainHeading: "Phishing Detector",
                    textareaLabel: "Enter the email text below:",
                    analyzeButton: "Analyze Email",
                    clearButton: "Clear Text",
                    langToggleButton: "Espa√±ol", // Show Spanish option when in English
                    textareaPlaceholder: "Paste the full email content here, not just the address...",
                    historyModalTitle: "Analysis History",
                    exportBtnText: "Export JSON",
                    clearBtnText: "Clear All",
                    fileUploadTitle: "Click or drag to upload email file",
                    fileUploadSubtitle: "Supported: .eml, .msg, .txt, .html",
                    urlAnalysisTitle: "üîó URLs Detected",
                    // Examples Section
                    examplesHeaderTitle: "üìö Try Example Emails",
                    examplesToggleShow: "Show Examples",
                    examplesToggleHide: "Hide Examples",
                    examplesDescription: "Learn to identify phishing by testing real examples. Click any category below:",
                    categoryPhishingTitle: "Phishing Examples",
                    categoryLegitimateTitle: "Legitimate Examples",
                    // Example names and descriptions
                    exampleBankName: "Fake Bank",
                    exampleBankDesc: "Urgent account verification",
                    examplePrizeName: "Fake Prize",
                    examplePrizeDesc: "You won a lottery",
                    exampleSocialName: "Social Media",
                    exampleSocialDesc: "Account security alert",
                    exampleUrgencyName: "Urgent Action",
                    exampleUrgencyDesc: "Immediate response needed",
                    exampleShippingName: "Fake Delivery",
                    exampleShippingDesc: "Package delivery issue",
                    exampleTaxName: "Tax Refund",
                    exampleTaxDesc: "Government refund scam",
                    exampleWorkName: "Work Meeting",
                    exampleWorkDesc: "Team meeting reminder",
                    exampleServiceName: "Order Confirmed",
                    exampleServiceDesc: "Purchase confirmation",
                    exampleNewsletterName: "Newsletter",
                    exampleNewsletterDesc: "Company updates",
                    exampleReceiptName: "Receipt",
                    exampleReceiptDesc: "Payment receipt",
                },
                es: {
                    mainHeading: "Detector de Phishing",
                    textareaLabel: "Introduzca el texto del correo electr√≥nico a continuaci√≥n:",
                    analyzeButton: "Analizar Correo",
                    clearButton: "Limpiar Texto",
                    langToggleButton: "English", // Show English option when in Spanish
                    textareaPlaceholder: "Pegue aqu√≠ el contenido completo del correo electr√≥nico, no s√≥lo la direcci√≥n...",
                    historyModalTitle: "Historial de An√°lisis",
                    exportBtnText: "Exportar JSON",
                    fileUploadTitle: "Haz clic o arrastra para subir archivo de correo",
                    fileUploadSubtitle: "Soportados: .eml, .msg, .txt, .html",
                    clearBtnText: "Limpiar Todo",
                    urlAnalysisTitle: "üîó URLs Detectadas",
                    // Examples Section
                    examplesHeaderTitle: "üìö Probar Correos de Ejemplo",
                    examplesToggleShow: "Mostrar Ejemplos",
                    examplesToggleHide: "Ocultar Ejemplos",
                    examplesDescription: "Aprende a identificar phishing probando ejemplos reales. Haz clic en cualquier categor√≠a:",
                    categoryPhishingTitle: "Ejemplos de Phishing",
                    categoryLegitimateTitle: "Ejemplos Leg√≠timos",
                    // Example names and descriptions
                    exampleBankName: "Banco Falso",
                    exampleBankDesc: "Verificaci√≥n urgente de cuenta",
                    examplePrizeName: "Premio Falso",
                    examplePrizeDesc: "Ganaste una loter√≠a",
                    exampleSocialName: "Redes Sociales",
                    exampleSocialDesc: "Alerta de seguridad de cuenta",
                    exampleUrgencyName: "Acci√≥n Urgente",
                    exampleUrgencyDesc: "Respuesta inmediata requerida",
                    exampleShippingName: "Entrega Falsa",
                    exampleShippingDesc: "Problema de entrega de paquete",
                    exampleTaxName: "Reembolso Fiscal",
                    exampleTaxDesc: "Estafa de reembolso gubernamental",
                    exampleWorkName: "Reuni√≥n de Trabajo",
                    exampleWorkDesc: "Recordatorio de reuni√≥n de equipo",
                    exampleServiceName: "Pedido Confirmado",
                    exampleServiceDesc: "Confirmaci√≥n de compra",
                    exampleNewsletterName: "Bolet√≠n",
                    exampleNewsletterDesc: "Actualizaciones de empresa",
                    exampleReceiptName: "Recibo",
                    exampleReceiptDesc: "Recibo de pago",
                }
            };

            // --- Function to Set Language ---
            function setLanguage(lang) {
                if (!translations[lang]) {
                    logger.error("Language not supported:", lang);
                    return;
                }

                // Update text content
                elements.mainHeading.innerText = translations[lang].mainHeading;
                elements.textareaLabel.innerText = translations[lang].textareaLabel;
                elements.analyzeButton.innerText = translations[lang].analyzeButton;
                elements.clearButton.innerText = translations[lang].clearButton;
                elements.langToggleButton.innerText = translations[lang].langToggleButton;

                // Update placeholder
                elements.emailTextarea.placeholder = translations[lang].textareaPlaceholder;

                // Update examples section translations
                const examplesHeaderTitle = document.getElementById('examples-header-title');
                const examplesToggleText = document.getElementById('examples-toggle-text');
                const examplesDescription = document.getElementById('examples-description');
                const categoryPhishingTitle = document.getElementById('category-phishing-title');
                const categoryLegitimateTitle = document.getElementById('category-legitimate-title');
                
                if (examplesHeaderTitle) examplesHeaderTitle.innerText = translations[lang].examplesHeaderTitle;
                if (examplesToggleText) {
                    const isVisible = document.getElementById('examples-content').style.display !== 'none';
                    examplesToggleText.innerText = isVisible ? translations[lang].examplesToggleHide : translations[lang].examplesToggleShow;
                }
                if (examplesDescription) examplesDescription.innerText = translations[lang].examplesDescription;
                if (categoryPhishingTitle) categoryPhishingTitle.innerText = translations[lang].categoryPhishingTitle;
                if (categoryLegitimateTitle) categoryLegitimateTitle.innerText = translations[lang].categoryLegitimateTitle;
                
                // Update example button names and descriptions
                const exampleElements = {
                    'example-bank-name': 'exampleBankName',
                    'example-bank-desc': 'exampleBankDesc',
                    'example-prize-name': 'examplePrizeName',
                    'example-prize-desc': 'examplePrizeDesc',
                    'example-social-name': 'exampleSocialName',
                    'example-social-desc': 'exampleSocialDesc',
                    'example-urgency-name': 'exampleUrgencyName',
                    'example-urgency-desc': 'exampleUrgencyDesc',
                    'example-shipping-name': 'exampleShippingName',
                    'example-shipping-desc': 'exampleShippingDesc',
                    'example-tax-name': 'exampleTaxName',
                    'example-tax-desc': 'exampleTaxDesc',
                    'example-work-name': 'exampleWorkName',
                    'example-work-desc': 'exampleWorkDesc',
                    'example-service-name': 'exampleServiceName',
                    'example-service-desc': 'exampleServiceDesc',
                    'example-newsletter-name': 'exampleNewsletterName',
                    'example-newsletter-desc': 'exampleNewsletterDesc',
                    'example-receipt-name': 'exampleReceiptName',
                    'example-receipt-desc': 'exampleReceiptDesc'
                };
                
                Object.keys(exampleElements).forEach(elementId => {
                    const element = document.getElementById(elementId);
                    const translationKey = exampleElements[elementId];
                    if (element && translations[lang][translationKey]) {
                        element.innerText = translations[lang][translationKey];
                    }
                });
                
                // Update history modal translations
                elements.historyModalTitle.innerText = translations[lang].historyModalTitle;
                elements.exportBtnText.innerText = translations[lang].exportBtnText;
                elements.clearBtnText.innerText = translations[lang].clearBtnText;
                
                // Update file upload translations
                elements.fileUploadTitle.innerText = translations[lang].fileUploadTitle;
                elements.fileUploadSubtitle.innerText = translations[lang].fileUploadSubtitle;
                
                // Update URL analysis translations
                if (elements.urlAnalysisTitle) {
                    elements.urlAnalysisTitle.innerText = translations[lang].urlAnalysisTitle;
                }

                // Store preference
                localStorage.setItem('preferredLang', lang);
                // Set lang attribute on HTML tag for potential CSS use or accessibility
                document.documentElement.lang = lang;
            }

            // --- Toggle Button Event Listener ---
            elements.langToggleButton.addEventListener('click', function() {
                // Get current language (from storage or default to 'en')
                const currentLang = localStorage.getItem('preferredLang') || 'en';
                // Determine the new language
                const newLang = currentLang === 'en' ? 'es' : 'en';
                // Set the new language
                setLanguage(newLang);
            });

            // --- Example Selector Handler ---
            elements.exampleSelector.addEventListener('change', function() {
                const selectedExample = this.value;
                if (selectedExample) {
                    const currentLang = localStorage.getItem('preferredLang') || 'en';
                    elements.emailTextarea.value = examples[selectedExample][currentLang];
                    // Reset selector to default
                    this.value = '';
                }
            });

            // --- Initial Language Load ---
            // Get language from storage or default to Spanish (for .lat domain)
            const initialLang = localStorage.getItem('preferredLang') || 'es';
            setLanguage(initialLang);

            // --- Global variable to store last prediction ---
            let lastPredictionData = null;

            // --- Form Submission with AJAX ---
            const emailForm = document.getElementById('email-form');
            const resultArea = document.getElementById('result-area');

            emailForm.addEventListener('submit', async function(e) {
                e.preventDefault(); // Prevent default form submission

                const emailText = document.getElementById('email_text').value.trim();
                const currentLang = localStorage.getItem('preferredLang') || 'es';
                
                if (!emailText) {
                    const emptyMessage = currentLang === 'es' 
                        ? 'Por favor ingrese un texto de correo para analizar'
                        : 'Please enter some email text to analyze';
                    showError(emptyMessage);
                    return;
                }

                // Extract and display URLs immediately
                displayURLs(emailText);

                // Show loading state
                showLoading();

                try {
                    const response = await fetch('/predict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `email_text=${encodeURIComponent(emailText)}`
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Store prediction data for feedback
                        lastPredictionData = {
                            email_text: emailText,
                            prediction: data.prediction,
                            confidence: data.confidence,
                            risk_score: data.analysis.risk_score,
                            threats_detected: data.threats_detected,
                            google_safe_browsing_checked: data.google_safe_browsing?.checked || false,
                            google_safe_browsing_safe: data.google_safe_browsing?.is_safe || true
                        };
                        showResult(data);
                    } else {
                        const errorMessage = currentLang === 'es'
                            ? data.error || 'Ocurri√≥ un error durante el an√°lisis'
                            : data.error || 'An error occurred during analysis';
                        showError(errorMessage);
                    }
                } catch (error) {
                    logger.error('Error:', error);
                    showError('Failed to connect to the server. Please try again.');
                }
            });

            // --- Show Loading State ---
            function showLoading() {
                const currentLang = localStorage.getItem('preferredLang') || 'en';
                const loadingText = currentLang === 'es' ? 'Analizando...' : 'Analyzing...';
                
                resultArea.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>${loadingText}</div>
                    </div>
                `;
            }

            // --- Show Result ---
            function showResult(data) {
                const currentLang = localStorage.getItem('preferredLang') || 'en';
                const isPhishing = data.prediction === 'PHISHING';
                const resultClass = isPhishing ? 'phishing' : 'legitimate';
                const icon = isPhishing ? '‚ö†Ô∏è' : '‚úÖ';
                
                const translations = {
                    en: {
                        phishing: 'Phishing Detected',
                        legitimate: 'Legitimate Email',
                        confidence: 'Confidence',
                        textLength: 'Text Length',
                        wordCount: 'Word Count',
                        urls: 'URLs Found',
                        excessiveCaps: 'Excessive Caps',
                        urgentLanguage: 'Urgent Language',
                        threatsDetected: 'Threats Detected',
                        riskScore: 'Risk Score',
                        keywordMatches: 'Phishing Keywords',
                        emojiCount: 'Emojis',
                        exclamationMarks: 'Exclamation Marks',
                        uppercaseRatio: 'Uppercase Ratio',
                        advancedFlags: 'Advanced Analysis',
                        advancedAnalysis: 'Advanced Analysis',
                        suspiciousTLD: 'Suspicious Domain',
                        suspiciousDomain: 'Suspicious Domain',
                        urlShortener: 'URL Shortener',
                        ipInUrl: 'IP in URL',
                        urgencyTactics: 'Urgency Tactics',
                        credentialRequest: 'Requests Credentials',
                        unrealisticOffer: 'Unrealistic Offer',
                        brandTypo: 'Brand Misspelling',
                        genericGreeting: 'Generic Greeting',
                        yes: 'Yes',
                        no: 'No',
                        none: 'None',
                        characters: 'characters',
                        words: 'words',
                        googleSafeBrowsing: 'Google Safe Browsing',
                        urlVerification: 'URL Verification',
                        checked: 'Checked',
                        notChecked: 'Not Checked',
                        safe: 'Safe',
                        malicious: 'Malicious',
                        maliciousUrls: 'Malicious URLs',
                        threatTypes: 'Threat Types',
                        apiNotConfigured: 'API not configured',
                        feedbackQuestion: 'Was this prediction correct?',
                        feedbackCorrect: 'Yes, correct',
                        feedbackIncorrect: 'No, incorrect',
                        feedbackThanks: 'Thank you for your feedback!',
                        feedbackError: 'Error submitting feedback'
                    },
                    es: {
                        phishing: 'Phishing Detectado',
                        legitimate: 'Correo Leg√≠timo',
                        confidence: 'Confianza',
                        textLength: 'Longitud del Texto',
                        wordCount: 'Cantidad de Palabras',
                        urls: 'URLs Encontradas',
                        excessiveCaps: 'May√∫sculas Excesivas',
                        urgentLanguage: 'Lenguaje Urgente',
                        threatsDetected: 'Amenazas Detectadas',
                        riskScore: 'Puntuaci√≥n de Riesgo',
                        keywordMatches: 'Palabras Clave',
                        emojiCount: 'Emojis',
                        exclamationMarks: 'Signos de Exclamaci√≥n',
                        uppercaseRatio: 'Ratio de May√∫sculas',
                        advancedFlags: 'An√°lisis Avanzado',
                        advancedAnalysis: 'An√°lisis Avanzado',
                        suspiciousTLD: 'Dominio Sospechoso',
                        suspiciousDomain: 'Dominio Sospechoso',
                        urlShortener: 'Acortador de URL',
                        ipInUrl: 'IP en URL',
                        urgencyTactics: 'T√°cticas de Urgencia',
                        credentialRequest: 'Solicita Credenciales',
                        unrealisticOffer: 'Oferta Irreal',
                        brandTypo: 'Marca Mal Escrita',
                        genericGreeting: 'Saludo Gen√©rico',
                        yes: 'S√≠',
                        no: 'No',
                        none: 'Ninguna',
                        characters: 'caracteres',
                        words: 'palabras',
                        googleSafeBrowsing: 'Google Safe Browsing',
                        urlVerification: 'Verificaci√≥n de URLs',
                        checked: 'Verificada',
                        notChecked: 'No Verificada',
                        safe: 'Segura',
                        malicious: 'Maliciosa',
                        maliciousUrls: 'URLs Maliciosas',
                        threatTypes: 'Tipos de Amenazas',
                        apiNotConfigured: 'API no configurada',
                        feedbackQuestion: '¬øFue correcta esta predicci√≥n?',
                        feedbackCorrect: 'S√≠, correcta',
                        feedbackIncorrect: 'No, incorrecta',
                        feedbackThanks: '¬°Gracias por tu retroalimentaci√≥n!',
                        feedbackError: 'Error al enviar retroalimentaci√≥n'
                    }
                };

                const t = translations[currentLang];
                const resultTitle = isPhishing ? t.phishing : t.legitimate;
                const confidence = (data.confidence * 100).toFixed(1);
                const confidenceColor = isPhishing ? getCSSVar('--accent-danger') : getCSSVar('--accent-success');
                
                // Threat translations
                const threatTranslations = {
                    en: {
                        'Suspicious domain extension': 'Suspicious domain extension',
                        'URL shortener detected': 'URL shortener detected',
                        'IP address in URL': 'IP address in URL',
                        'Urgent language tactics': 'Urgent language tactics',
                        'Requests credentials': 'Requests credentials',
                        'Too-good-to-be-true offer': 'Too-good-to-be-true offer',
                        'Brand name misspelling': 'Brand name misspelling',
                        'Generic greeting': 'Generic greeting',
                        'Excessive capitalization': 'Excessive capitalization',
                        'phishing keywords': 'phishing keywords',
                        'Google Safe Browsing': 'Google Safe Browsing',
                        'Malware': 'Malware',
                        'Phishing/Social Engineering': 'Phishing/Social Engineering',
                        'Unwanted Software': 'Unwanted Software',
                        'Harmful Application': 'Harmful Application'
                    },
                    es: {
                        'Suspicious domain extension': 'Extensi√≥n de dominio sospechosa',
                        'URL shortener detected': 'Acortador de URL detectado',
                        'IP address in URL': 'Direcci√≥n IP en la URL',
                        'Urgent language tactics': 'T√°cticas de lenguaje urgente',
                        'Requests credentials': 'Solicita credenciales',
                        'Too-good-to-be-true offer': 'Oferta demasiado buena para ser verdad',
                        'Brand name misspelling': 'Nombre de marca mal escrito',
                        'Generic greeting': 'Saludo gen√©rico',
                        'Excessive capitalization': 'Uso excesivo de may√∫sculas',
                        'phishing keywords': 'palabras clave de phishing',
                        'Google Safe Browsing': 'Google Safe Browsing',
                        'Malware': 'Malware',
                        'Phishing/Social Engineering': 'Phishing/Ingenier√≠a Social',
                        'Unwanted Software': 'Software No Deseado',
                        'Harmful Application': 'Aplicaci√≥n Da√±ina'
                    }
                };
                
                // Function to translate threat messages
                function translateThreat(threat, lang) {
                    // Handle dynamic messages like "7 phishing keywords"
                    const keywordMatch = threat.match(/^(\d+)\s+phishing keywords$/);
                    if (keywordMatch) {
                        const count = keywordMatch[1];
                        return lang === 'es' 
                            ? `${count} palabras clave de phishing`
                            : `${count} phishing keywords`;
                    }
                    
                    // Handle Google Safe Browsing threats like "Google Safe Browsing: Malware"
                    const googleMatch = threat.match(/^Google Safe Browsing:\s+(.+)$/);
                    if (googleMatch) {
                        const threatType = googleMatch[1];
                        const translatedType = threatTranslations[lang][threatType] || threatType;
                        return lang === 'es'
                            ? `Google Safe Browsing: ${translatedType}`
                            : `Google Safe Browsing: ${translatedType}`;
                    }
                    
                    // Use translation table or return original if not found
                    return threatTranslations[lang][threat] || threat;
                }
                
                // Build threats list HTML
                let threatsHTML = '';
                if (data.threats_detected && data.threats_detected.length > 0) {
                    threatsHTML = '<div class="detail-row" style="grid-column: 1 / -1;"><span class="detail-label">' + t.threatsDetected + ':</span><ul style="margin: 5px 0 0 20px; color: ' + getCSSVar('--accent-danger') + ';">';
                    data.threats_detected.forEach(threat => {
                        const translatedThreat = translateThreat(threat, currentLang);
                        threatsHTML += '<li>' + translatedThreat + '</li>';
                    });
                    threatsHTML += '</ul></div>';
                } else {
                    threatsHTML = '<div class="detail-row" style="grid-column: 1 / -1;"><span class="detail-label">' + t.threatsDetected + ':</span><span class="detail-value" style="color: ' + getCSSVar('--accent-success') + ';">' + t.none + '</span></div>';
                }
                
                // Build Google Safe Browsing HTML
                let safeBrowsingHTML = '';
                if (data.google_safe_browsing) {
                    const gsb = data.google_safe_browsing;
                    safeBrowsingHTML = '<div style="grid-column: 1 / -1; margin-top: 15px; padding-top: 15px; border-top: 1px solid ' + getCSSVar('--border-primary') + ';"><strong>üõ°Ô∏è ' + t.googleSafeBrowsing + '</strong></div>';
                    
                    // Status badge
                    if (gsb.checked) {
                        const statusText = gsb.is_safe ? t.safe : t.malicious;
                        const statusColor = gsb.is_safe ? getCSSVar('--accent-success') : getCSSVar('--accent-danger');
                        const statusIcon = gsb.is_safe ? '‚úì' : '‚ö†Ô∏è';
                        safeBrowsingHTML += '<div class="detail-row"><span class="detail-label">' + t.urlVerification + ':</span><span class="detail-value" style="color: ' + statusColor + ';"> ' + statusIcon + ' ' + statusText + '</span></div>';
                        
                        // Show malicious URLs if found
                        if (!gsb.is_safe && gsb.malicious_urls && gsb.malicious_urls.length > 0) {
                            safeBrowsingHTML += '<div class="detail-row" style="grid-column: 1 / -1;"><span class="detail-label">' + t.maliciousUrls + ':</span><ul style="margin: 5px 0 0 20px; color: ' + getCSSVar('--accent-danger') + ';">';
                            gsb.malicious_urls.forEach(url => {
                                safeBrowsingHTML += '<li style="word-break: break-all;">' + url + '</li>';
                            });
                            safeBrowsingHTML += '</ul></div>';
                            
                            // Show threat types if found
                            if (gsb.threats_found && gsb.threats_found.length > 0) {
                                safeBrowsingHTML += '<div class="detail-row" style="grid-column: 1 / -1;"><span class="detail-label">' + t.threatTypes + ':</span><ul style="margin: 5px 0 0 20px; color: ' + getCSSVar('--accent-danger') + ';">';
                                gsb.threats_found.forEach(threat => {
                                    const translatedThreat = threatTranslations[currentLang][threat] || threat;
                                    safeBrowsingHTML += '<li>' + translatedThreat + '</li>';
                                });
                                safeBrowsingHTML += '</ul></div>';
                            }
                        }
                    } else {
                        // API not configured
                        safeBrowsingHTML += '<div class="detail-row" style="grid-column: 1 / -1;"><span class="detail-label">' + t.urlVerification + ':</span><span class="detail-value" style="color: ' + getCSSVar('--text-tertiary') + ';">‚äò ' + t.apiNotConfigured + '</span></div>';
                    }
                }
                
                // Build advanced flags HTML
                let flagsHTML = '';
                if (data.flags) {
                    const flagsToShow = [
                        { key: 'suspicious_tld', label: t.suspiciousTLD },
                        { key: 'url_shortener', label: t.urlShortener },
                        { key: 'ip_in_url', label: t.ipInUrl },
                        { key: 'urgency_tactics', label: t.urgencyTactics },
                        { key: 'credential_request', label: t.credentialRequest },
                        { key: 'unrealistic_offer', label: t.unrealisticOffer },
                        { key: 'brand_typo', label: t.brandTypo },
                        { key: 'generic_greeting', label: t.genericGreeting }
                    ];
                    
                    flagsHTML = '<div style="grid-column: 1 / -1; margin-top: 15px; padding-top: 15px; border-top: 1px solid ' + getCSSVar('--border-primary') + ';"><strong>' + t.advancedFlags + '</strong></div>';
                    flagsToShow.forEach(flag => {
                        const value = data.flags[flag.key];
                        const valueText = value ? t.yes : t.no;
                        const valueColor = value ? getCSSVar('--accent-danger') : getCSSVar('--accent-success');
                        flagsHTML += '<div class="detail-row"><span class="detail-label">' + flag.label + ':</span><span class="detail-value" style="color: ' + valueColor + ';">' + valueText + '</span></div>';
                    });
                }

                resultArea.innerHTML = `
                    <div class="result ${resultClass}">
                        <div class="result-header">
                            <span class="result-icon">${icon}</span>
                            <span>${resultTitle}</span>
                        </div>
                        <div class="result-details">
                            <div class="detail-row">
                                <span class="detail-label">${t.confidence}:</span>
                                <span class="detail-value">${confidence}%</span>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidence}%; background-color: ${confidenceColor};"></div>
                            </div>
                            ${threatsHTML}
                            <div class="detail-row">
                                <span class="detail-label">${t.riskScore}:</span>
                                <span class="detail-value">${data.analysis.risk_score}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.textLength}:</span>
                                <span class="detail-value">${data.analysis.text_length}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.wordCount}:</span>
                                <span class="detail-value">${data.analysis.word_count}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.urls}:</span>
                                <span class="detail-value">${data.analysis.url_count}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.keywordMatches}:</span>
                                <span class="detail-value">${data.analysis.phishing_keywords}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.uppercaseRatio}:</span>
                                <span class="detail-value">${(data.analysis.uppercase_ratio * 100).toFixed(1)}%</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.exclamationMarks}:</span>
                                <span class="detail-value">${data.analysis.exclamation_marks}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.emojiCount}:</span>
                                <span class="detail-value">${data.analysis.emoji_count}</span>
                            </div>
                            ${safeBrowsingHTML}
                            ${flagsHTML}
                        </div>
                        <div id="feedback-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid ${getCSSVar('--border-primary')}; text-align: center;">
                            <p style="margin-bottom: 15px; color: ${getCSSVar('--text-secondary')}; font-size: 14px;">${t.feedbackQuestion}</p>
                            <div style="display: flex; gap: 15px; justify-content: center;">
                                <button onclick="submitFeedback('correct')" style="padding: 10px 20px; background: linear-gradient(135deg, ${getCSSVar('--accent-success')}, ${getCSSVar('--accent-success-hover')}); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s;">
                                    üëç ${t.feedbackCorrect}
                                </button>
                                <button onclick="submitFeedback('incorrect')" style="padding: 10px 20px; background: linear-gradient(135deg, ${getCSSVar('--accent-danger')}, ${getCSSVar('--accent-danger-hover')}); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s;">
                                    üëé ${t.feedbackIncorrect}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Save to history
                const emailText = document.getElementById('email_text').value;
                saveToHistory(emailText, data.prediction, data.confidence, data);
            }

            // --- Show Error ---
            function showError(message) {
                const currentLang = localStorage.getItem('preferredLang') || 'es';
                const errorTitle = currentLang === 'es' ? 'Error' : 'Error';
                
                resultArea.innerHTML = `
                    <div class="result error">
                        <div class="result-header">
                            <span class="result-icon">‚ùå</span>
                            <span>${errorTitle}</span>
                        </div>
                        <div class="result-details">
                            ${message}
                        </div>
                    </div>
                `;
            }

            // --- Submit Feedback Function ---
            window.submitFeedback = async function(feedbackType) {
                if (!lastPredictionData) {
                    logger.error('No prediction data available');
                    return;
                }

                const currentLang = localStorage.getItem('preferredLang') || 'es';
                const translations = {
                    en: {
                        thanks: 'Thank you for your feedback!',
                        error: 'Error submitting feedback'
                    },
                    es: {
                        thanks: '¬°Gracias por tu retroalimentaci√≥n!',
                        error: 'Error al enviar retroalimentaci√≥n'
                    }
                };

                try {
                    const response = await fetch('/feedback', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email_text: lastPredictionData.email_text,
                            prediction: lastPredictionData.prediction,
                            user_feedback: feedbackType,
                            confidence: lastPredictionData.confidence,
                            risk_score: lastPredictionData.risk_score,
                            threats_detected: lastPredictionData.threats_detected,
                            google_safe_browsing_checked: lastPredictionData.google_safe_browsing_checked,
                            google_safe_browsing_safe: lastPredictionData.google_safe_browsing_safe
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Replace feedback section with thank you message
                        const feedbackSection = document.getElementById('feedback-section');
                        if (feedbackSection) {
                            feedbackSection.innerHTML = `
                                <p style="color: ${getCSSVar('--accent-success')}; font-weight: bold; font-size: 16px;">
                                    ‚úì ${translations[currentLang].thanks}
                                </p>
                            `;
                        }
                    } else {
                        alert(translations[currentLang].error);
                    }
                } catch (error) {
                    logger.error('Feedback error:', error);
                    alert(translations[currentLang].error);
                }
            };

        }); // End DOMContentLoaded

        // --- Clear Text Area Function ---
        function clearTextArea() {
            document.getElementById('email_text').value = '';
            // Clear the result area as well
            const resultArea = document.getElementById('result-area');
            if (resultArea) {
                resultArea.innerHTML = ''; // Clear previous results
            }
            // Clear file upload if exists
            const fileInput = document.getElementById('file-input');
            const filePreview = document.getElementById('file-preview');
            const fileUploadArea = document.getElementById('file-upload-area');
            if (fileInput) {
                fileInput.value = '';
            }
            if (filePreview && fileUploadArea) {
                filePreview.style.display = 'none';
                fileUploadArea.style.display = 'flex';
            }
            // Clear URL analysis
            const urlSection = document.getElementById('url-analysis-section');
            if (urlSection) {
                urlSection.style.display = 'none';
            }
        }
        
        // --- Examples Section Functions ---
        function toggleExamples() {
            const content = document.getElementById('examples-content');
            const toggleText = document.getElementById('examples-toggle-text');
            const toggleIcon = document.getElementById('examples-toggle-icon');
            const currentLang = localStorage.getItem('preferredLang') || 'es';
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggleText.innerText = translations[currentLang].examplesToggleHide;
                toggleIcon.innerText = '‚ñ≤';
            } else {
                content.style.display = 'none';
                toggleText.innerText = translations[currentLang].examplesToggleShow;
                toggleIcon.innerText = '‚ñº';
            }
        }
        
        function loadExample(exampleKey) {
            const currentLang = localStorage.getItem('preferredLang') || 'es';
            const exampleText = examples[exampleKey]?.[currentLang];
            
            if (exampleText) {
                const textarea = document.getElementById('email_text');
                textarea.value = exampleText;
                
                // Smooth scroll to textarea
                textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Add a highlight animation
                textarea.style.transition = 'background-color 0.5s ease';
                const originalBg = textarea.style.backgroundColor;
                textarea.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
                
                setTimeout(() => {
                    textarea.style.backgroundColor = originalBg;
                }, 1000);
            } else {
                logger.error('Example not found:', exampleKey);
            }
        }
    </script>

    <!-- History Modal -->
    <div id="history-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="history-modal-title">Analysis History</h2>
                <button class="modal-close" onclick="closeHistoryModal()" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body" id="history-list">
                <!-- History items will be inserted here -->
            </div>
            <div class="modal-footer">
                <div>
                    <span id="history-count" style="color: var(--text-secondary); font-size: 0.9rem;">0 analyses</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="modal-footer-btn export" onclick="exportHistory()" id="export-history-btn">
                        üì• <span id="export-btn-text">Export JSON</span>
                    </button>
                    <button class="modal-footer-btn clear" onclick="clearAllHistory()" id="clear-history-btn">
                        üóëÔ∏è <span id="clear-btn-text">Clear All</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>