<!doctype html>
<html lang="en"> <!-- Lang attribute will be updated by JS -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dory-Lat Phishing Detector</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='Favicon Gabo 16x16.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='Favicon Gabo 32x32.png') }}">
    <link rel="icon" type="image/png" sizes="128x128" href="{{ url_for('static', filename='Favicon Gabo 128x128.png') }}">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='Favicon Gabo 512x512.png') }}">
    <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='Favicon Gabo 512x512.png') }}">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a1a2e;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: start; /* Align to top */
            min-height: 100vh;
            background: linear-gradient(135deg, #16213e, #0f3460);
        }
        .container {
            background-color: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            width: 90%;
            max-width: 700px;
            text-align: center; /* Center align text */
            margin-top: 20px; /* Add some margin top */
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        h1 {
            color: #ffffff;
            margin-bottom: 25px;
            font-weight: 600;
        }
        label {
            display: block;
            margin-bottom: 10px;
            color: #a9b4d2;
            font-weight: 400;
            text-align: left; /* Align label text left */
        }
        textarea {
            width: 100%;
            min-height: 180px; /* Increased height */
            padding: 15px;
            border: 1px solid #0f3460;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 25px;
            box-sizing: border-box; /* Include padding and border in width */
            background-color: #1a1a2e;
            color: #ffffff;
            font-family: 'Poppins', sans-serif;
        }
        textarea::placeholder { /* Style the placeholder text */
            color: #a9b4d2;
            font-style: italic;
        }
        .button-container {
            display: flex;
            justify-content: space-between; /* Space out buttons */
            gap: 15px; /* Add gap between buttons */
            margin-bottom: 25px;
        }
        button {
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-grow: 1; /* Make buttons share space */
        }
        .analyze-button {
            background-color: #e94560;
            color: white;
        }
        .analyze-button:hover {
            background-color: #c62a42;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }
        .clear-button {
            background-color: #536976;
            color: white;
        }
        .clear-button:hover {
            background-color: #41515b;
            transform: translateY(-2px);
        }
        .lang-button { /* Style for language button */
            background-color: transparent;
            color: #f0f0f0;
            border: 1px solid #f0f0f0;
            max-width: 150px; /* Adjust width if needed */
            flex-grow: 0; /* Don't let it grow like others */
        }
        .lang-button:hover {
            background-color: #f0f0f0;
            color: #1a1a2e;
        }
        .result {
            margin-top: 25px;
            padding: 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            word-wrap: break-word; /* Ensure long results wrap */
            text-align: left; /* Align result text left */
            border-left: 5px solid;
        }
        .result.phishing {
            background-color: rgba(233, 69, 96, 0.1);
            color: #f7b6c0;
            border-color: #e94560;
        }
        .result.legitimate {
            background-color: rgba(20, 221, 122, 0.1);
            color: #a1e9c4;
            border-color: #14dd7a;
        }
        .result.error, .model-error { /* Combined error style */
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffdDAA;
            border-color: #ffc107;
            text-align: left; /* Align error text left */
        }
        .model-error { /* Specific style for model load error */
             margin-bottom: 20px; /* Add space below model error */
             padding: 15px;
             font-size: 0.9rem;
        }
        /* Result details styles */
        .result-header {
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .result-icon {
            font-size: 1.5rem;
        }
        .result-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.9rem;
            font-weight: normal;
        }
        .detail-row {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
        .detail-label {
            opacity: 0.8;
        }
        .detail-value {
            font-weight: 600;
        }
        .confidence-bar {
            width: 100%;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        .confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .loading {
            text-align: center;
            color: #a9b4d2;
            padding: 20px;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #e94560;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Add container for header and button */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .header-container h1 {
            margin: 0; /* Remove default h1 margin */
            text-align: left; /* Ensure heading stays left */
            flex-grow: 1; /* Allow heading to take space */
        }
        /* Logo styles */
        .logo-link {
            display: inline-block;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        .logo-link:hover {
            transform: scale(1.1);
        }
        .logo-link img {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }
        /* Footer styles */
        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #a9b4d2;
            font-size: 0.9rem;
        }
        .footer a {
            color: #e94560;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .footer a:hover {
            color: #f7b6c0;
        }
    </style>
</head>
<body>
    <div class="container">

        <a href="https://github.com/Charly-bite" target="_blank" class="logo-link" rel="noopener noreferrer">
            <img src="{{ url_for('static', filename='Favicon Gabo 128x128.png') }}" alt="GitHub Profile">
        </a>

        <div class="header-container">
            <!-- Added ID for translation -->
            <h1 id="main-heading">Phishing Detector</h1>
            <!-- Added Language Toggle Button -->
            <button id="lang-toggle" class="lang-button">Español</button>
        </div>

        {% if model_error %}
            <div class="model-error">{{ model_error }}</div>
        {% endif %}

        <form id="email-form">
             <!-- Added ID for translation -->
            <label for="email_text" id="textarea-label">Enter the email text below:</label>
            <!-- Added placeholder attribute -->
            <textarea
                id="email_text"
                name="email_text"
                required
                placeholder="Paste the full email content here, not just the address..."
                >{{ email_text or '' }}</textarea>

            <div class="button-container">
                 <!-- Added ID for translation -->
                <button type="submit" class="analyze-button" id="analyze-button">Analyze Email</button>
                 <!-- Added ID for translation -->
                <button type="button" class="clear-button" id="clear-button" onclick="clearTextArea()">Clear Text</button>
            </div>
        </form>

        <!-- Added ID for the result container -->
        <div id="result-area">
            {% if prediction_text %}
                <div class="result {% if 'Phishing' in prediction_text %}phishing{% elif 'Legitimate' in prediction_text %}legitimate{% else %}error{% endif %}">
                    {{ prediction_text }}
                </div>
            {% endif %}
        </div>

        <div class="footer">
            Contact: <a href="mailto:carlos.aceves6195@alumnos.udg.mx">carlos.aceves6195@alumnos.udg.mx</a>
        </div>
    </div>

    <script>
        // Wait for the HTML to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {

            // --- Elements to Translate ---
            const elements = {
                mainHeading: document.getElementById('main-heading'),
                textareaLabel: document.getElementById('textarea-label'),
                analyzeButton: document.getElementById('analyze-button'),
                clearButton: document.getElementById('clear-button'),
                langToggleButton: document.getElementById('lang-toggle'),
                emailTextarea: document.getElementById('email_text'), // Reference to textarea for placeholder
            };

            // --- Translations ---
            const translations = {
                en: {
                    mainHeading: "Phishing Detector",
                    textareaLabel: "Enter the email text below:",
                    analyzeButton: "Analyze Email",
                    clearButton: "Clear Text",
                    langToggleButton: "Español", // Show Spanish option when in English
                    textareaPlaceholder: "Paste the full email content here, not just the address...",
                },
                es: {
                    mainHeading: "Detector de Phishing",
                    textareaLabel: "Introduzca el texto del correo electrónico a continuación:",
                    analyzeButton: "Analizar Correo",
                    clearButton: "Limpiar Texto",
                    langToggleButton: "English", // Show English option when in Spanish
                    textareaPlaceholder: "Pegue aquí el contenido completo del correo electrónico, no sólo la dirección...",
                }
            };

            // --- Function to Set Language ---
            function setLanguage(lang) {
                if (!translations[lang]) {
                    console.error("Language not supported:", lang);
                    return;
                }

                // Update text content
                elements.mainHeading.innerText = translations[lang].mainHeading;
                elements.textareaLabel.innerText = translations[lang].textareaLabel;
                elements.analyzeButton.innerText = translations[lang].analyzeButton;
                elements.clearButton.innerText = translations[lang].clearButton;
                elements.langToggleButton.innerText = translations[lang].langToggleButton;

                // Update placeholder
                elements.emailTextarea.placeholder = translations[lang].textareaPlaceholder;

                // Store preference
                localStorage.setItem('preferredLang', lang);
                // Set lang attribute on HTML tag for potential CSS use or accessibility
                document.documentElement.lang = lang;
            }

            // --- Toggle Button Event Listener ---
            elements.langToggleButton.addEventListener('click', function() {
                // Get current language (from storage or default to 'en')
                const currentLang = localStorage.getItem('preferredLang') || 'en';
                // Determine the new language
                const newLang = currentLang === 'en' ? 'es' : 'en';
                // Set the new language
                setLanguage(newLang);
            });

            // --- Initial Language Load ---
            // Get language from storage or default to English
            const initialLang = localStorage.getItem('preferredLang') || 'en';
            setLanguage(initialLang);

            // --- Form Submission with AJAX ---
            const emailForm = document.getElementById('email-form');
            const resultArea = document.getElementById('result-area');

            emailForm.addEventListener('submit', async function(e) {
                e.preventDefault(); // Prevent default form submission

                const emailText = document.getElementById('email_text').value.trim();
                
                if (!emailText) {
                    showError('Please enter some email text to analyze');
                    return;
                }

                // Show loading state
                showLoading();

                try {
                    const response = await fetch('/predict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `email_text=${encodeURIComponent(emailText)}`
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showResult(data);
                    } else {
                        showError(data.error || 'An error occurred during analysis');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showError('Failed to connect to the server. Please try again.');
                }
            });

            // --- Show Loading State ---
            function showLoading() {
                const currentLang = localStorage.getItem('preferredLang') || 'en';
                const loadingText = currentLang === 'es' ? 'Analizando...' : 'Analyzing...';
                
                resultArea.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>${loadingText}</div>
                    </div>
                `;
            }

            // --- Show Result ---
            function showResult(data) {
                const currentLang = localStorage.getItem('preferredLang') || 'en';
                const isPhishing = data.prediction === 'PHISHING';
                const resultClass = isPhishing ? 'phishing' : 'legitimate';
                const icon = isPhishing ? '⚠️' : '✅';
                
                const translations = {
                    en: {
                        phishing: 'Phishing Detected',
                        legitimate: 'Legitimate Email',
                        confidence: 'Confidence',
                        textLength: 'Text Length',
                        wordCount: 'Word Count',
                        urls: 'URLs Found',
                        excessiveCaps: 'Excessive Caps',
                        urgentLanguage: 'Urgent Language',
                        yes: 'Yes',
                        no: 'No'
                    },
                    es: {
                        phishing: 'Phishing Detectado',
                        legitimate: 'Correo Legítimo',
                        confidence: 'Confianza',
                        textLength: 'Longitud del Texto',
                        wordCount: 'Cantidad de Palabras',
                        urls: 'URLs Encontradas',
                        excessiveCaps: 'Mayúsculas Excesivas',
                        urgentLanguage: 'Lenguaje Urgente',
                        yes: 'Sí',
                        no: 'No'
                    }
                };

                const t = translations[currentLang];
                const resultTitle = isPhishing ? t.phishing : t.legitimate;
                const confidence = (data.confidence * 100).toFixed(1);
                const confidenceColor = isPhishing ? '#e94560' : '#14dd7a';

                resultArea.innerHTML = `
                    <div class="result ${resultClass}">
                        <div class="result-header">
                            <span class="result-icon">${icon}</span>
                            <span>${resultTitle}</span>
                        </div>
                        <div class="result-details">
                            <div class="detail-row">
                                <span class="detail-label">${t.confidence}:</span>
                                <span class="detail-value">${confidence}%</span>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidence}%; background-color: ${confidenceColor};"></div>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.textLength}:</span>
                                <span class="detail-value">${data.analysis.text_length}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.wordCount}:</span>
                                <span class="detail-value">${data.analysis.word_count}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.urls}:</span>
                                <span class="detail-value">${data.analysis.suspicious_patterns.urls}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.excessiveCaps}:</span>
                                <span class="detail-value">${data.analysis.suspicious_patterns.excessive_caps ? t.yes : t.no}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.urgentLanguage}:</span>
                                <span class="detail-value">${data.analysis.suspicious_patterns.urgent_language ? t.yes : t.no}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            // --- Show Error ---
            function showError(message) {
                resultArea.innerHTML = `
                    <div class="result error">
                        <div class="result-header">
                            <span class="result-icon">❌</span>
                            <span>Error</span>
                        </div>
                        <div class="result-details">
                            ${message}
                        </div>
                    </div>
                `;
            }

        }); // End DOMContentLoaded

        // --- Clear Text Area Function ---
        function clearTextArea() {
            document.getElementById('email_text').value = '';
            // Clear the result area as well
            const resultArea = document.getElementById('result-area');
            if (resultArea) {
                resultArea.innerHTML = ''; // Clear previous results
            }
        }
    </script>

</body>
</html>