<!doctype html>
<html lang="en"> <!-- Lang attribute will be updated by JS -->

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dory-Lat Phishing Detector</title>

    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='Favicon Gabo 16x16.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='Favicon Gabo 32x32.png') }}">
    <link rel="icon" type="image/png" sizes="128x128"
        href="{{ url_for('static', filename='Favicon Gabo 128x128.png') }}">
    <link rel="icon" type="image/png" sizes="512x512"
        href="{{ url_for('static', filename='Favicon Gabo 512x512.png') }}">
    <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='Favicon Gabo 512x512.png') }}">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* === CSS Variables for Theme System === */
        :root {
            /* Dark Theme (Default) */
            --bg-primary: #0f172a;
            /* Darker, richer blue */
            --bg-secondary: rgba(30, 41, 59, 0.7);
            /* Glassmorphism effect */
            --bg-gradient-start: #0f172a;
            --bg-gradient-end: #1e293b;
            --bg-input: rgba(15, 23, 42, 0.6);
            --bg-select: rgba(15, 23, 42, 0.6);

            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-placeholder: #64748b;
            --text-select: #e2e8f0;

            --border-primary: rgba(148, 163, 184, 0.1);
            --border-secondary: rgba(148, 163, 184, 0.2);
            --border-focus: #3b82f6;

            --accent-danger: #ef4444;
            --accent-danger-hover: #dc2626;
            --accent-danger-bg: rgba(239, 68, 68, 0.1);

            --accent-success: #10b981;
            --accent-success-hover: #059669;
            --accent-success-bg: rgba(16, 185, 129, 0.1);

            --accent-warning: #f59e0b;
            --accent-warning-bg: rgba(245, 158, 11, 0.1);

            --btn-primary: #3b82f6;
            --btn-primary-hover: #2563eb;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;

            --transition-speed: 0.2s;
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #f0f9ff;
            --bg-secondary: rgba(255, 255, 255, 0.8);
            --bg-gradient-start: #f0f9ff;
            --bg-gradient-end: #e0f2fe;
            --bg-input: #ffffff;
            --bg-select: #ffffff;

            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-placeholder: #94a3b8;
            --text-select: #1e293b;

            --border-primary: #e2e8f0;
            --border-secondary: #cbd5e1;

            --accent-danger: #ef4444;
            --accent-danger-hover: #dc2626;
            --accent-danger-bg: #fee2e2;

            --accent-success: #10b981;
            --accent-success-hover: #059669;
            --accent-success-bg: #d1fae5;

            --accent-warning: #f59e0b;
            --accent-warning-bg: #fef3c7;

            --btn-primary: #3b82f6;
            --btn-primary-hover: #2563eb;
        }

        * {
            box-sizing: border-box;
            transition: background-color var(--transition-speed), border-color var(--transition-speed), color var(--transition-speed);
        }

        body {
            font-family: 'Inter', 'Poppins', sans-serif;
            /* Prefer Inter for modern look */
            background-color: var(--bg-primary);
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            /* Align to top instead of center */
            padding-top: 40px;
            /* Add top padding */
        }

        .container {
            background-color: var(--bg-secondary);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 2rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 900px;
            /* Wider container */
            border: 1px solid var(--border-primary);
            position: relative;
        }

        /* Header Layout */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(to right, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Compact Controls */
        .controls {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            background: var(--bg-input);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border-focus);
        }

        .lang-button {
            background: transparent;
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            cursor: pointer;
            font-weight: 500;
        }

        .lang-button:hover {
            color: var(--text-primary);
            border-color: var(--border-focus);
        }

        /* Main Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-area {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 0;
        }

        @media (min-width: 768px) {
            .main-grid {
                grid-template-columns: 3fr 2fr;
                /* Input area larger than sidebar */
            }
        }

        /* File Upload - Compact */
        .file-upload-area {
            border: 2px dashed var(--border-primary);
            border-radius: var(--radius-md);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            background-color: var(--bg-input);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .file-upload-area:hover {
            border-color: var(--accent-success);
            background-color: var(--bg-primary);
        }

        .file-upload-icon {
            font-size: 1.5rem;
            margin: 0;
        }

        .file-upload-text {
            text-align: left;
        }

        .file-upload-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            display: block;
        }

        .file-upload-subtitle {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: block;
        }

        /* Textarea */
        .input-group {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        textarea {
            width: 100%;
            flex-grow: 1;
            min-height: 250px;
            /* Taller default */
            padding: 1rem;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            background-color: var(--bg-input);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            resize: vertical;
            line-height: 1.6;
        }

        textarea:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--btn-primary), var(--btn-primary-hover));
            color: white;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 8px -1px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--bg-input);
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        /* Examples Sidebar */
        .sidebar {
            background: var(--bg-input);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-primary);
            padding: 1rem;
            height: fit-content;
        }

        .sidebar-header {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .example-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .example-item {
            background: transparent;
            border: 1px solid transparent;
            padding: 0.75rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .example-item:hover {
            background: var(--bg-primary);
            border-color: var(--border-primary);
        }

        .example-item-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .example-item-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Results */
        .result-area {
            margin-top: 2rem;
            clear: both;
            width: 100%;
            display: block;
        }

        .result-card {
            padding: 1.5rem;
            border-radius: var(--radius-md);
            border: 1px solid;
            animation: slideUp 0.3s ease-out;
            background-color: var(--bg-secondary);
            position: relative;
            z-index: 1;
            margin-top: 0;
        }

        .result-phishing {
            background: linear-gradient(var(--accent-danger-bg), var(--accent-danger-bg)), var(--bg-secondary);
            border-color: var(--accent-danger);
            color: var(--accent-danger);
        }

        .result-legitimate {
            background: linear-gradient(var(--accent-success-bg), var(--accent-success-bg)), var(--bg-secondary);
            border-color: var(--accent-success);
            color: var(--accent-success-hover);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Footer */
        .footer {
            margin-top: 2rem;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-primary);
            padding-top: 1rem;
        }

        .footer a {
            color: var(--text-placeholder);
            text-decoration: none;
        }

        .footer a:hover {
            color: var(--text-primary);
        }

        /* File Preview */
        .file-preview {
            background: var(--bg-input);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .file-preview-name {
            font-size: 0.9rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-remove-btn {
            background: none;
            border: none;
            color: var(--accent-danger);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 50%;
        }

        .file-remove-btn:hover {
            background: var(--accent-danger-bg);
        }


        /* Examples Section Styles */
        .examples-section {
            margin-bottom: 20px;
            background-color: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-primary);
            overflow: hidden;
        }

        .examples-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            cursor: pointer;
        }

        .examples-header h3 {
            margin: 0;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .examples-toggle {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .examples-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .examples-content {
            padding: 20px;
        }

        .examples-description {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 0.95rem;
            text-align: center;
        }

        .examples-categories {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .example-category {
            background-color: var(--bg-primary);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border-primary);
        }

        .category-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-primary);
        }

        .category-icon {
            font-size: 1.3rem;
        }

        .phishing-category {
            color: #f44336;
        }

        .legitimate-category {
            color: #4caf50;
        }

        .example-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }

        .example-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-family: inherit;
        }

        .example-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .phishing-btn {
            border-color: #f44336;
        }

        .phishing-btn:hover {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.1), rgba(244, 67, 54, 0.05));
            border-color: #f44336;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);
        }

        .legitimate-btn {
            border-color: #4caf50;
        }

        .legitimate-btn:hover {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05));
            border-color: #4caf50;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }

        .example-emoji {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .example-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .example-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .example-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* URL Analysis Styles */
        .url-analysis-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 20px;
            margin-top: 25px;
            animation: slideIn 0.3s ease-out;
        }

        .url-analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-primary);
        }

        .url-analysis-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.2rem;
        }

        .url-count-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .url-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .url-item {
            background-color: var(--bg-input);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 12px 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .url-item:hover {
            border-color: var(--accent-danger);
            transform: translateX(5px);
            box-shadow: 0 2px 8px var(--shadow-hover);
        }

        .url-risk-indicator {
            width: 8px;
            height: 100%;
            min-height: 40px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .url-risk-indicator.high {
            background-color: #ff4757;
        }

        .url-risk-indicator.medium {
            background-color: #ffa502;
        }

        .url-risk-indicator.low {
            background-color: #26de81;
        }

        .url-content {
            flex-grow: 1;
            min-width: 0;
        }

        .url-text {
            color: var(--text-primary);
            word-break: break-all;
            font-size: 0.95rem;
            margin-bottom: 5px;
            font-family: 'Courier New', monospace;
        }

        .url-flags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }

        .url-flag {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .url-flag.suspicious-domain {
            background-color: rgba(255, 71, 87, 0.15);
            color: #ff4757;
        }

        .url-flag.shortened {
            background-color: rgba(255, 165, 2, 0.15);
            color: #ffa502;
        }

        .url-flag.ip-address {
            background-color: rgba(255, 71, 87, 0.15);
            color: #ff4757;
        }

        .url-flag.suspicious-tld {
            background-color: rgba(255, 165, 2, 0.15);
            color: #ffa502;
        }

        .url-flag.phishing-keywords {
            background-color: rgba(255, 71, 87, 0.15);
            color: #ff4757;
        }

        .url-flag.long-subdomain {
            background-color: rgba(255, 165, 2, 0.15);
            color: #ffa502;
        }

        .url-flag.http-not-secure {
            background-color: rgba(255, 165, 2, 0.15);
            color: #ffa502;
        }

        .url-flag.safe {
            background-color: rgba(38, 222, 129, 0.15);
            color: #26de81;
        }

        .url-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-shrink: 0;
        }

        .url-action-btn {
            background-color: transparent;
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .url-action-btn:hover {
            background-color: var(--accent-danger);
            color: white;
            border-color: var(--accent-danger);
        }

        .url-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: 0;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-primary);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease-out;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: flex-end;
        }

        /* History List */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .history-item {
            background: var(--bg-input);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: 1rem;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .history-item-date {
            color: var(--text-secondary);
        }

        .history-item-result.phishing {
            color: var(--accent-danger);
            font-weight: 600;
        }

        .history-item-result.legitimate {
            color: var(--accent-success);
            font-weight: 600;
        }

        .history-item-preview {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .history-item-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .history-item-btn {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            cursor: pointer;
            border: 1px solid var(--border-primary);
            background: transparent;
            color: var(--text-secondary);
        }

        .history-item-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .history-item-btn.delete:hover {
            color: var(--accent-danger);
            border-color: var(--accent-danger);
        }

        .history-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .history-empty-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* Badge */
        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-danger);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
    </style>
</head>

<body class="no-transition">
    <!-- Theme Toggle Button -->
    <button id="theme-toggle" class="icon-btn" style="position: fixed; top: 1rem; right: 1rem; z-index: 100;">
        <span id="theme-icon">üåô</span>
    </button>

    <!-- History Button -->
    <button id="history-btn" class="icon-btn" style="position: fixed; top: 1rem; right: 4rem; z-index: 100;">
        <span>üìú</span>
        <span id="history-badge" class="badge" style="display: none;">0</span>
    </button>

    <div class="container">
        <!-- Header -->
        <div class="header-container">
            <div class="header-left">
                <a href="https://github.com/Charly-bite" target="_blank" rel="noopener noreferrer" title="Visit GitHub Profile">
                    <img src="{{ url_for('static', filename='Favicon Gabo 512x512.png') }}" alt="Logo" class="logo-img">
                </a>
                <h1 id="main-heading" data-i18n="title">Phishing Detector</h1>
            </div>
            <div class="controls">
                <button id="lang-toggle" class="lang-button">Espa√±ol</button>
            </div>
        </div>

        <div class="main-grid">
            <!-- Left Column: Input -->
            <div class="input-area">
                <!-- File Upload -->
                <div class="file-upload-area" id="drop-zone">
                    <input type="file" id="file-upload" hidden accept=".eml,.msg,.txt,.html">
                    <div class="file-upload-icon">üìÇ</div>
                    <div class="file-upload-text">
                        <span class="file-upload-title" id="file-upload-title" data-i18n="upload_title">Click or drag to
                            upload email file</span>
                        <span class="file-upload-subtitle" id="file-upload-subtitle"
                            data-i18n="upload_subtitle">Supported: .eml, .msg, .txt, .html</span>
                    </div>
                </div>

                <!-- File Preview (Hidden by default) -->
                <div class="file-preview" id="file-preview" style="display: none;">
                    <div class="file-preview-name">
                        <span>üìÑ</span>
                        <span id="file-name">filename.eml</span>
                    </div>
                    <div id="file-preview-info" class="file-preview-info" style="color: var(--text-secondary); font-size:0.85rem; margin-left:8px;">
                        <!-- File info (size, lines, chars) -->
                    </div>
                    <button class="file-remove-btn" id="remove-file">‚úï</button>
                </div>

                <!-- Textarea -->
                <div class="input-group">
                    <label for="email_text" id="textarea-label" data-i18n="enter_text">Enter the email text
                        below:</label>
                    <textarea id="email_text" placeholder="Paste the full email content here, not just the address..."
                        data-i18n-placeholder="placeholder"></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button id="analyze-btn" class="btn btn-primary">
                        <span data-i18n="analyze_button">Analyze Email</span>
                    </button>
                    <button id="clear-btn" class="btn btn-secondary">
                        <span data-i18n="clear_text">Clear Text</span>
                    </button>
                </div>
            </div>

            <!-- Right Column: Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <span id="examples-header-title" data-i18n="examples_label">Try Example Emails</span>
                </div>

                <div class="example-list" id="example-list">
                    <div class="category-title" id="category-phishing-title" data-i18n="phishing_cat"
                        style="color: var(--accent-danger); margin-top: 0.5rem;">Phishing Examples</div>

                    <button class="example-item" onclick="loadExample('phishing_bank')">
                        <div class="example-item-title">
                            <span>üè¶</span>
                            <span id="example-bank-name" data-i18n="ex_bank_name">Fake Bank</span>
                        </div>
                        <div class="example-item-desc" id="example-bank-desc" data-i18n="ex_bank_desc">Urgent account
                            verification</div>
                    </button>

                    <button class="example-item" onclick="loadExample('phishing_prize')">
                        <div class="example-item-title">
                            <span>üèÜ</span>
                            <span id="example-prize-name" data-i18n="ex_prize_name">Fake Prize</span>
                        </div>
                        <div class="example-item-desc" id="example-prize-desc" data-i18n="ex_prize_desc">You won a
                            lottery</div>
                    </button>

                    <button class="example-item" onclick="loadExample('phishing_social')">
                        <div class="example-item-title">
                            <span>üîí</span>
                            <span id="example-social-name" data-i18n="ex_social_name">Social Media</span>
                        </div>
                        <div class="example-item-desc" id="example-social-desc" data-i18n="ex_social_desc">Account
                            security alert</div>
                    </button>

                    <div class="category-title" id="category-legit-title" data-i18n="legit_cat"
                        style="color: var(--accent-success); margin-top: 1rem;">Legitimate Examples</div>

                    <button class="example-item" onclick="loadExample('legit_meeting')">
                        <div class="example-item-title">
                            <span>üìÖ</span>
                            <span id="example-meeting-name" data-i18n="ex_meeting_name">Meeting Invite</span>
                        </div>
                        <div class="example-item-desc" id="example-meeting-desc" data-i18n="ex_meeting_desc">Standard
                            calendar invite</div>
                    </button>

                    <button class="example-item" onclick="loadExample('legit_order')">
                        <div class="example-item-title">
                            <span>üì¶</span>
                            <span id="example-order-name" data-i18n="ex_order_name">Order Confirmed</span>
                        </div>
                        <div class="example-item-desc" id="example-order-desc" data-i18n="ex_order_desc">Shipping
                            notification</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Area -->
        <div id="result" class="result-area" style="display: none;"></div>

        <!-- Footer -->
        <div class="footer">
            Contact: <a href="mailto:carlos.aceves6195@alumnos.udg.mx">carlos.aceves6195@alumnos.udg.mx</a>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-i18n="history_title">Analysis History</h2>
                <span id="history-count" style="color: var(--text-secondary); font-size: 0.9rem; margin-left: 12px;">0 analyses</span>
                <button id="close-history" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="history-list" class="history-list">
                    <!-- History items will be inserted here -->
                </div>
            </div>
            <div class="modal-footer">
                <div style="display:flex; gap:8px;">
                    <button id="export-history-btn" class="btn btn-secondary">üì• <span id="export-btn-text">Export JSON</span></button>
                    <button id="clear-history" class="btn btn-secondary" data-i18n="clear_history">üóëÔ∏è Clear History</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Security: HTML Sanitization Functions ---
        /**
         * Sanitizes HTML to prevent XSS attacks
         * @param {string} str - The string to sanitize
         * @returns {string} - Sanitized string safe for innerHTML
         */
        function sanitizeHTML(str) {
            if (!str) return '';
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        /**
         * Creates safe HTML elements with text content
         * @param {string} tag - HTML tag name
         * @param {string} text - Text content
         * @param {string} className - Optional CSS class
         * @returns {HTMLElement} - Safe DOM element
         */
        function createSafeElement(tag, text, className = '') {
            const element = document.createElement(tag);
            element.textContent = text;
            if (className) element.className = className;
            return element;
        }

        /**
         * Truncates text to maximum length
         * @param {string} text - Text to truncate
         * @param {number} maxLength - Maximum length
         * @returns {string} - Truncated text
         */
        function truncateText(text, maxLength) {
            if (!text || text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '... [truncated]';
        }

        // --- Conditional Logging (Production-Safe) ---
        // Set to false for production deployment
        const DEBUG_MODE = true; // Change to false in production

        const logger = {
            info: DEBUG_MODE ? console.log.bind(console) : function () { },
            warn: DEBUG_MODE ? console.warn.bind(console) : function () { },
            error: DEBUG_MODE ? console.error.bind(console) : function () { },
            debug: DEBUG_MODE ? console.debug.bind(console) : function () { }
        };

        // --- localStorage Encryption Functions ---
        /**
         * Obfuscates data before storing (basic protection)
         * For production, consider using Web Crypto API for real encryption
         * @param {object} data - Data to obfuscate
         * @returns {string} - Obfuscated string
         */
        function obfuscateData(data) {
            try {
                const jsonStr = JSON.stringify(data);
                // Simple base64 encoding (not true encryption, but better than plain text)
                return btoa(encodeURIComponent(jsonStr));
            } catch (error) {
                logger.error('Error obfuscating data:', error);
                return null;
            }
        }

        /**
         * Deobfuscates data from storage
         * @param {string} obfuscatedStr - Obfuscated string
         * @returns {object} - Original data
         */
        function deobfuscateData(obfuscatedStr) {
            try {
                if (!obfuscatedStr) return null;
                const jsonStr = decodeURIComponent(atob(obfuscatedStr));
                return JSON.parse(jsonStr);
            } catch (error) {
                logger.error('Error deobfuscating data:', error);
                return null;
            }
        }

        // --- Global Variables ---
        let lastPredictionData = null;

        const translations = {
            en: {
                title: "Phishing Detector",
                upload_title: "Click or drag to upload email file",
                upload_subtitle: "Supported: .eml, .msg, .txt, .html",
                enter_text: "Enter the email text below:",
                analyze_button: "Analyze Email",
                clear_text: "Clear Text",
                examples_label: "Try Example Emails",
                phishing_cat: "Phishing Examples",
                ex_bank_name: "Fake Bank",
                ex_bank_desc: "Urgent account verification",
                ex_prize_name: "Fake Prize",
                ex_prize_desc: "You won a lottery",
                ex_social_name: "Social Media",
                ex_social_desc: "Account security alert",
                phishing: "Phishing Detected",
                legitimate: "Legitimate Email",
                confidence: "Confidence",
                risk_score: "Risk Score",
                threatsDetected: "Threats Detected",
                none: "None",
                googleSafeBrowsing: "Google Safe Browsing",
                safe: "Safe",
                malicious: "Malicious",
                urlVerification: "URL Verification",
                maliciousUrls: "Malicious URLs",
                threatTypes: "Threat Types",
                apiNotConfigured: "API Not Configured",
                advancedFlags: "Advanced Flags",
                suspiciousTLD: "Suspicious TLD",
                urlShortener: "URL Shortener",
                ipInUrl: "IP in URL",
                urgencyTactics: "Urgency Tactics",
                credentialRequest: "Credential Request",
                unrealisticOffer: "Unrealistic Offer",
                brandTypo: "Brand Typo",
                genericGreeting: "Generic Greeting",
                yes: "Yes",
                no: "No",
                textLength: "Text Length",
                wordCount: "Word Count",
                urls: "URLs",
                keywordMatches: "Keyword Matches",
                uppercaseRatio: "Uppercase Ratio",
                exclamationMarks: "Exclamation Marks",
                emojiCount: "Emoji Count",
                feedbackQuestion: "Was this analysis correct?",
                feedbackCorrect: "Yes, Correct",
                feedbackIncorrect: "No, Incorrect",
                examplesToggleShow: "Show Examples",
                examplesToggleHide: "Hide Examples"
            },
            es: {
                title: "Detector de Phishing",
                upload_title: "Haz clic o arrastra para subir archivo",
                upload_subtitle: "Soportado: .eml, .msg, .txt, .html",
                enter_text: "Ingresa el texto del correo abajo:",
                analyze_button: "Analizar Correo",
                clear_text: "Borrar Texto",
                examples_label: "Prueba Correos de Ejemplo",
                phishing_cat: "Ejemplos de Phishing",
                ex_bank_name: "Banco Falso",
                ex_bank_desc: "Verificaci√≥n de cuenta urgente",
                ex_prize_name: "Premio Falso",
                ex_prize_desc: "Ganaste la loter√≠a",
                ex_social_name: "Redes Sociales",
                ex_social_desc: "Alerta de seguridad de cuenta",
                phishing: "Phishing Detectado",
                legitimate: "Correo Leg√≠timo",
                confidence: "Confianza",
                risk_score: "Puntuaci√≥n de Riesgo",
                threatsDetected: "Amenazas Detectadas",
                none: "Ninguna",
                googleSafeBrowsing: "Navegaci√≥n Segura de Google",
                safe: "Seguro",
                malicious: "Malicioso",
                urlVerification: "Verificaci√≥n de URL",
                maliciousUrls: "URLs Maliciosas",
                threatTypes: "Tipos de Amenaza",
                apiNotConfigured: "API No Configurada",
                advancedFlags: "Banderas Avanzadas",
                suspiciousTLD: "TLD Sospechoso",
                urlShortener: "Acortador de URL",
                ipInUrl: "IP en URL",
                urgencyTactics: "T√°cticas de Urgencia",
                credentialRequest: "Solicitud de Credenciales",
                unrealisticOffer: "Oferta Irreal",
                brandTypo: "Error en Marca",
                genericGreeting: "Saludo Gen√©rico",
                yes: "S√≠",
                no: "No",
                textLength: "Longitud del Texto",
                wordCount: "Conteo de Palabras",
                urls: "URLs",
                keywordMatches: "Coincidencias de Palabras Clave",
                uppercaseRatio: "Ratio de May√∫sculas",
                exclamationMarks: "Signos de Exclamaci√≥n",
                emojiCount: "Conteo de Emojis",
                feedbackQuestion: "¬øFue correcto este an√°lisis?",
                feedbackCorrect: "S√≠, Correcto",
                feedbackIncorrect: "No, Incorrecto",
                examplesToggleShow: "Mostrar Ejemplos",
                examplesToggleHide: "Ocultar Ejemplos"
            }
        };

        const examples = {
            phishing_bank: {
                en: "URGENT: SECURITY ALERT\n\nDear valued customer,\n\nYour Bank of America account has been LOCKED due to suspicious activity detected from Nigeria. You must verify your identity IMMEDIATELY or your account will be permanently closed within 24 hours.\n\nClick here to verify now: http://bankofamerica-secure-login.tk/verify?id=8472910\n\nDO NOT ignore this message. Failure to act will result in permanent loss of access to your funds.\n\nBank Security Team\n(This is an automated message, do not reply)",
                es: "URGENTE: ALERTA DE SEGURIDAD\n\nEstimado cliente,\n\nSu cuenta de Banco Santander ha sido BLOQUEADA debido a actividad sospechosa detectada desde el extranjero. Debe verificar su identidad INMEDIATAMENTE o su cuenta ser√° cerrada permanentemente en las pr√≥ximas 24 horas.\n\nHaga clic aqu√≠ para verificar ahora: http://bancosantander-verificacion.tk/login?id=8472910\n\nNO ignore este mensaje. Si no act√∫a, perder√° acceso permanente a sus fondos.\n\nEquipo de Seguridad Bancaria\n(Este es un mensaje automatizado, no responda)"
            },
            phishing_prize: {
                en: "üéâ CONGRATULATIONS! YOU'VE WON! üéâ\n\nDear LUCKY WINNER,\n\nYou have been selected as the GRAND PRIZE WINNER of our Apple iPhone 15 Pro Max GIVEAWAY! üì±‚ú®\n\nYour winning number: #847291\nPrize value: $1,299 USD\n\nClaim your FREE iPhone now before it expires:\nüëâ http://apple-prizes-claim.xyz/winner?code=IPHONE2024\n\nHurry! Only 3 hours left to claim!\n\nüéÅ 100% FREE - No purchase necessary!\nüöö FREE International Shipping!\n\nClick NOW or lose your prize forever!",
                es: "üéâ ¬°FELICIDADES! ¬°HAS GANADO! üéâ\n\nEstimado GANADOR AFORTUNADO,\n\n¬°Has sido seleccionado como GANADOR DEL GRAN PREMIO de nuestro SORTEO de iPhone 15 Pro Max! üì±‚ú®\n\nTu n√∫mero ganador: #847291\nValor del premio: $1,299 USD\n\nReclama tu iPhone GRATIS ahora antes de que expire:\nüëâ http://sorteo-apple-oficial.xyz/ganador?codigo=IPHONE2024\n\n¬°Ap√∫rate! ¬°Solo quedan 3 horas para reclamar!\n\nüéÅ 100% GRATIS - ¬°No requiere compra!\nüöö ¬°Env√≠o Internacional GRATIS!\n\n¬°Haz clic AHORA o pierde tu premio para siempre!"
            },
            phishing_social: {
                en: "‚ö†Ô∏è Instagram Security Alert ‚ö†Ô∏è\n\nWe detected an unusual login attempt to your account from:\nLocation: Lagos, Nigeria\nDevice: Unknown Android Device\nTime: 2 hours ago\n\nThis wasn't you? Secure your account immediately:\nhttp://instagram-security-check.com/verify/account\n\nIf you don't verify within 12 hours, your account will be permanently deleted to prevent unauthorized access.\n\nInstagram Security Team\n---\nThis is an automated security notification.",
                es: "‚ö†Ô∏è Alerta de Seguridad de Instagram ‚ö†Ô∏è\n\nDetectamos un intento de inicio de sesi√≥n inusual en tu cuenta desde:\nUbicaci√≥n: Lagos, Nigeria\nDispositivo: Dispositivo Android Desconocido\nHora: Hace 2 horas\n\n¬øNo fuiste t√∫? Asegura tu cuenta inmediatamente:\nhttp://instagram-seguridad-verificar.com/verificar/cuenta\n\nSi no verificas en 12 horas, tu cuenta ser√° eliminada permanentemente para prevenir acceso no autorizado.\n\nEquipo de Seguridad de Instagram\n---\nEsta es una notificaci√≥n de seguridad automatizada."
            },
            phishing_urgency: {
                en: "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FINAL NOTICE - IMMEDIATE ACTION REQUIRED ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è\n\nYour Microsoft Office 365 subscription will EXPIRE TODAY at 11:59 PM!\n\nAll your files, emails, and documents will be DELETED if you don't renew NOW!\n\n‚ùå Time remaining: 4 hours 23 minutes\n‚ùå Files at risk: 15,847 documents\n‚ùå Emails to be deleted: 9,234 messages\n\nRENEW IMMEDIATELY to avoid data loss:\nüîó http://microsoft-office-renewal.net/urgent/renew\n\nCredit card required for verification. Act now!\n\nMicrosoft Billing Department",
                es: "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è AVISO FINAL - ACCI√ìN INMEDIATA REQUERIDA ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è\n\n¬°Tu suscripci√≥n a Microsoft Office 365 EXPIRAR√Å HOY a las 11:59 PM!\n\n¬°Todos tus archivos, correos y documentos ser√°n ELIMINADOS si no renuevas AHORA!\n\n‚ùå Tiempo restante: 4 horas 23 minutos\n‚ùå Archivos en riesgo: 15,847 documentos\n‚ùå Correos a eliminar: 9,234 mensajes\n\nRENUEVA INMEDIATAMENTE para evitar p√©rdida de datos:\nüîó http://microsoft-office-renovacion.net/urgente/renovar\n\nTarjeta de cr√©dito requerida para verificaci√≥n. ¬°Act√∫a ahora!\n\nDepartamento de Facturaci√≥n de Microsoft"
            },
            phishing_shipping: {
                en: "üì¶ DHL Express - Package Delivery Failed\n\nTracking Number: DHL847291034\n\nDear Customer,\n\nWe attempted to deliver your package but FAILED due to incomplete address information.\n\nYour package contains: 1 item from Apple Store\nCurrent location: Warehouse - Will be returned in 48 hours\n\n‚ö†Ô∏è URGENT: Update your delivery address to avoid return:\nüîó http://dhl-delivery-update.com/track/847291034\n\nAdditional delivery fee required: $3.99\nEnter your credit card to confirm delivery.\n\n‚ùå Package will be destroyed if not claimed within 2 days!\n\nDHL Customer Service\nDo not reply to this email.",
                es: "üì¶ DHL Express - Entrega de Paquete Fallida\n\nN√∫mero de Rastreo: DHL847291034\n\nEstimado Cliente,\n\nIntentamos entregar su paquete pero FALL√ì debido a informaci√≥n de direcci√≥n incompleta.\n\nSu paquete contiene: 1 art√≠culo de Apple Store\nUbicaci√≥n actual: Almac√©n - Ser√° devuelto en 48 horas\n\n‚ö†Ô∏è URGENTE: Actualice su direcci√≥n de entrega para evitar devoluci√≥n:\nüîó http://dhl-entrega-actualizar.com/rastreo/847291034\n\nTarifa adicional de entrega requerida: $3.99\nIngrese su tarjeta de cr√©dito para confirmar entrega.\n\n‚ùå ¬°El paquete ser√° destruido si no se reclama en 2 d√≠as!\n\nServicio al Cliente DHL\nNo responda a este correo."
            },
            phishing_tax: {
                en: "üí∞ IRS Tax Refund Notification\n\nDear Taxpayer,\n\nGood news! You are eligible for a tax refund of $1,847.00 from your 2024 tax return.\n\nRefund Amount: $1,847.00\nTax Year: 2024\nStatus: APPROVED - Pending Action\n\n‚úÖ Claim your refund now (expires in 72 hours):\nüîó http://irs-refund-claim.gov.us/refund?id=2024847291\n\nYou will need to provide:\n- Full Social Security Number\n- Date of Birth\n- Bank Account Details for direct deposit\n\n‚è∞ Hurry! Unclaimed refunds are forfeited after 3 days.\n\nThis is an official notification from the Internal Revenue Service.\nReference: IRS-2024-REF-847291\n\nDo not reply to this email.",
                es: "üí∞ Notificaci√≥n de Reembolso del SAT\n\nEstimado Contribuyente,\n\n¬°Buenas noticias! Es elegible para un reembolso de impuestos de $1,847.00 de su declaraci√≥n de 2024.\n\nMonto del Reembolso: $1,847.00\nA√±o Fiscal: 2024\nEstado: APROBADO - Acci√≥n Pendiente\n\n‚úÖ Reclame su reembolso ahora (expira en 72 horas):\nüîó http://sat-reembolso-reclamar.gob.mx/reembolso?id=2024847291\n\nNecesitar√° proporcionar:\n- N√∫mero completo de RFC\n- Fecha de Nacimiento\n- Detalles de Cuenta Bancaria para dep√≥sito directo\n\n‚è∞ ¬°Ap√∫rese! Los reembolsos no reclamados se pierden despu√©s de 3 d√≠as.\n\nEsta es una notificaci√≥n oficial del Servicio de Administraci√≥n Tributaria.\nReferencia: SAT-2024-REMB-847291\n\nNo responda a este correo."
            },
            legitimate_work: {
                en: "Subject: Team Meeting Tomorrow - Project Update\n\nHi everyone,\n\nJust a friendly reminder about our weekly team meeting tomorrow (Tuesday) at 10:00 AM in Conference Room 3.\n\nAgenda:\n- Q4 progress review\n- Upcoming deadlines discussion\n- Resource allocation for next sprint\n\nPlease bring your monthly reports. If you can't attend, let me know by EOD today.\n\nBest regards,\nJohn Smith\nProject Manager\nTech Solutions Inc.",
                es: "Asunto: Reuni√≥n de Equipo Ma√±ana - Actualizaci√≥n de Proyecto\n\nHola a todos,\n\nSolo un recordatorio amistoso sobre nuestra reuni√≥n semanal de equipo ma√±ana (martes) a las 10:00 AM en la Sala de Conferencias 3.\n\nAgenda:\n- Revisi√≥n de progreso del Q4\n- Discusi√≥n de fechas l√≠mite pr√≥ximas\n- Asignaci√≥n de recursos para el siguiente sprint\n\nPor favor traigan sus reportes mensuales. Si no pueden asistir, av√≠senme antes del fin del d√≠a.\n\nSaludos,\nJuan P√©rez\nGerente de Proyecto\nSoluciones Tecnol√≥gicas S.A."
            },
            legitimate_service: {
                en: "Order Confirmation - Amazon.com\n\nHello,\n\nThank you for your order! Your package has been shipped and is on its way.\n\nOrder #: 123-4567890-1234567\nShipping Address: 123 Main St, Anytown, ST 12345\nEstimated Delivery: November 5, 2025\n\nYou can track your package at: amazon.com/orders\n(Please log into your account to view tracking details)\n\nItems ordered:\n- Wireless Mouse - $25.99\n- USB-C Cable (2-pack) - $12.99\n\nThank you for shopping with Amazon!\n\nThe Amazon Team",
                es: "Confirmaci√≥n de Pedido - Amazon.com.mx\n\nHola,\n\n¬°Gracias por tu pedido! Tu paquete ha sido enviado y est√° en camino.\n\nPedido #: 123-4567890-1234567\nDirecci√≥n de Env√≠o: Calle Principal 123, Ciudad, CP 12345\nEntrega Estimada: 5 de noviembre, 2025\n\nPuedes rastrear tu paquete en: amazon.com.mx/pedidos\n(Por favor inicia sesi√≥n en tu cuenta para ver detalles de rastreo)\n\nArt√≠culos ordenados:\n- Mouse Inal√°mbrico - $25.99\n- Cable USB-C (paquete de 2) - $12.99\n\n¬°Gracias por comprar en Amazon!\n\nEl Equipo de Amazon"
            },
            legit_meeting: {
                en: "Subject: Team Meeting Tomorrow - Project Update\n\nHi everyone,\n\nJust a friendly reminder about our weekly team meeting tomorrow (Tuesday) at 10:00 AM in Conference Room 3.\n\nAgenda:\n- Q4 progress review\n- Upcoming deadlines discussion\n- Resource allocation for next sprint\n\nPlease bring your monthly reports. If you can't attend, let me know by EOD today.\n\nBest regards,\nJohn Smith\nProject Manager\nTech Solutions Inc.",
                es: "Asunto: Reuni√≥n de Equipo Ma√±ana - Actualizaci√≥n de Proyecto\n\nHola a todos,\n\nSolo un recordatorio amistoso sobre nuestra reuni√≥n semanal de equipo ma√±ana (martes) a las 10:00 AM en la Sala de Conferencias 3.\n\nAgenda:\n- Revisi√≥n de progreso del Q4\n- Discusi√≥n de fechas l√≠mite pr√≥ximas\n- Asignaci√≥n de recursos para el siguiente sprint\n\nPor favor traigan sus reportes mensuales. Si no pueden asistir, av√≠senme antes del fin del d√≠a.\n\nSaludos,\nJuan P√©rez\nGerente de Proyecto\nSoluciones Tecnol√≥gicas S.A."
            },
            legit_order: {
                en: "Order Confirmation - Amazon.com\n\nHello,\n\nThank you for your order! Your package has been shipped and is on its way.\n\nOrder #: 123-4567890-1234567\nShipping Address: 123 Main St, Anytown, ST 12345\nEstimated Delivery: November 5, 2025\n\nYou can track your package at: amazon.com/orders\n(Please log into your account to view tracking details)\n\nItems ordered:\n- Wireless Mouse - $25.99\n- USB-C Cable (2-pack) - $12.99\n\nThank you for shopping with Amazon!\n\nThe Amazon Team",
                es: "Confirmaci√≥n de Pedido - Amazon.com.mx\n\nHola,\n\n¬°Gracias por tu pedido! Tu paquete ha sido enviado y est√° en camino.\n\nPedido #: 123-4567890-1234567\nDirecci√≥n de Env√≠o: Calle Principal 123, Ciudad, CP 12345\nEntrega Estimada: 5 de noviembre, 2025\n\nPuedes rastrear tu paquete en: amazon.com.mx/pedidos\n(Por favor inicia sesi√≥n en tu cuenta para ver detalles de rastreo)\n\nArt√≠culos ordenados:\n- Mouse Inal√°mbrico - $25.99\n- Cable USB-C (paquete de 2) - $12.99\n\n¬°Gracias por comprar en Amazon!\n\nEl Equipo de Amazon"
            }
        };

        // Wait for the HTML to be fully loaded
        document.addEventListener('DOMContentLoaded', function () {

            // --- Theme Toggle Logic ---
            const themeToggle = document.getElementById('theme-toggle');
            const html = document.documentElement;

            // Helper function to get CSS variable values
            function getCSSVar(varName) {
                return getComputedStyle(html).getPropertyValue(varName).trim();
            }

            // Load saved theme or default to dark
            const savedTheme = localStorage.getItem('theme') || 'dark';
            html.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);

            // Remove no-transition class after initial load
            setTimeout(() => {
                document.body.classList.remove('no-transition');
            }, 100);

            // Theme toggle handler
            themeToggle.addEventListener('click', function () {
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });

            // Update theme icon
            function updateThemeIcon(theme) {
                themeToggle.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
                themeToggle.setAttribute('aria-label', theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
            }

            // --- History Management Functions ---
            const HISTORY_KEY = 'dory_analysis_history';
            const MAX_HISTORY_ITEMS = 10;
            const MAX_EMAIL_LENGTH = 5000; // 5KB per email
            const MAX_STORAGE_SIZE = 1000000; // ~1MB total storage

            // ENCRYPTION: Get history from localStorage with decryption
            function getHistory() {
                try {
                    const obfuscatedData = localStorage.getItem(HISTORY_KEY);
                    if (!obfuscatedData) return [];

                    // Try to deobfuscate (encrypted format)
                    let parsed = deobfuscateData(obfuscatedData);

                    // Fallback: try plain JSON (for backward compatibility)
                    if (!parsed) {
                        try {
                            parsed = JSON.parse(obfuscatedData);
                            // If successful, re-save in encrypted format
                            if (Array.isArray(parsed)) {
                                const encrypted = obfuscateData(parsed);
                                if (encrypted) {
                                    localStorage.setItem(HISTORY_KEY, encrypted);
                                }
                            }
                        } catch (e) {
                            logger.warn('Could not parse as plain JSON either');
                            parsed = null;
                        }
                    }

                    // Validate that it's an array
                    if (!Array.isArray(parsed)) {
                        logger.warn('Invalid history format, resetting...');
                        localStorage.removeItem(HISTORY_KEY);
                        return [];
                    }

                    return parsed;
                } catch (error) {
                    logger.error('Error reading history:', error);
                    // Clear corrupted data
                    try {
                        localStorage.removeItem(HISTORY_KEY);
                    } catch (e) {
                        logger.error('Cannot clear storage:', e);
                    }
                    return [];
                }
            }

            // Save analysis to history with size limits and sanitization
            function saveToHistory(emailText, prediction, confidence, data) {
                try {
                    // Sanitize and truncate email text for storage
                    const truncatedEmail = truncateText(emailText, MAX_EMAIL_LENGTH);

                    const history = getHistory();
                    const newEntry = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        email_text: truncatedEmail, // Use truncated version
                        prediction: prediction,
                        confidence: confidence,
                        is_phishing: data.is_phishing,
                        risk_score: data.risk_score || 0,
                        threats_detected: data.threats_detected || [],
                        google_safe_browsing: data.google_safe_browsing || null
                    };

                    // Add to beginning of array
                    history.unshift(newEntry);

                    // Keep only last MAX_HISTORY_ITEMS
                    if (history.length > MAX_HISTORY_ITEMS) {
                        history.splice(MAX_HISTORY_ITEMS);
                    }

                    // ENCRYPTION: Obfuscate before saving
                    const obfuscatedHistory = obfuscateData(history);

                    if (!obfuscatedHistory) {
                        logger.error('Failed to obfuscate history data');
                        return;
                    }

                    // Check storage size before saving
                    if (obfuscatedHistory.length > MAX_STORAGE_SIZE) {
                        logger.warn('History too large, reducing to 5 items...');
                        history.splice(5); // Keep only 5 most recent
                        const reducedObfuscated = obfuscateData(history);
                        if (reducedObfuscated) {
                            localStorage.setItem(HISTORY_KEY, reducedObfuscated);
                        }
                    } else {
                        localStorage.setItem(HISTORY_KEY, obfuscatedHistory);
                    }

                    updateHistoryBadge();

                } catch (error) {
                    // Handle QuotaExceededError
                    if (error.name === 'QuotaExceededError') {
                        logger.error('Storage quota exceeded, clearing old history...');
                        const currentLang = localStorage.getItem('preferredLang') || 'es';
                        const message = currentLang === 'es'
                            ? 'Almacenamiento lleno. Limpiando historial antiguo...'
                            : 'Storage full. Clearing old history...';
                        alert(message);

                        // Try to save with reduced history
                        try {
                            const reducedHistory = [newEntry]; // Keep only current item
                            const obfuscated = obfuscateData(reducedHistory);
                            if (obfuscated) {
                                localStorage.setItem(HISTORY_KEY, obfuscated);
                            }
                            updateHistoryBadge();
                        } catch (e) {
                            logger.error('Cannot save even reduced history:', e);
                        }
                    } else {
                        logger.error('Error saving to history:', error);
                    }
                }
            }

            // Delete single history item
            function deleteHistoryItem(id) {
                try {
                    let history = getHistory();
                    history = history.filter(item => item.id !== id);
                    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                    updateHistoryBadge();
                    renderHistory();
                } catch (error) {
                    logger.error('Error deleting history item:', error);
                }
            }
            window.deleteHistoryItem = deleteHistoryItem;

            // Clear all history
            function clearAllHistory() {
                const currentLang = localStorage.getItem('preferredLang') || 'es';
                const confirmMsg = currentLang === 'es'
                    ? '¬øEst√°s seguro de que quieres borrar todo el historial?'
                    : 'Are you sure you want to clear all history?';

                if (confirm(confirmMsg)) {
                    localStorage.removeItem(HISTORY_KEY);
                    updateHistoryBadge();
                    renderHistory();
                }
            }
            window.clearAllHistory = clearAllHistory;

            // Export history as JSON
            function exportHistory() {
                try {
                    const history = getHistory();
                    if (history.length === 0) {
                        const currentLang = localStorage.getItem('preferredLang') || 'es';
                        alert(currentLang === 'es' ? 'No hay historial para exportar' : 'No history to export');
                        return;
                    }

                    const dataStr = JSON.stringify(history, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `dory-analysis-history-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    logger.error('Error exporting history:', error);
                }
            }
            window.exportHistory = exportHistory;

            // Load history item into textarea
            function loadHistoryItem(id) {
                try {
                    const history = getHistory();
                    const item = history.find(h => h.id === id);
                    if (item) {
                        const emailTextarea = document.getElementById('email_text');
                        emailTextarea.value = item.email_text;
                        closeHistoryModal();

                        // Scroll to textarea
                        emailTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });

                        // Optional: auto-analyze
                        // document.getElementById('email-form').dispatchEvent(new Event('submit'));
                    }
                } catch (error) {
                    logger.error('Error loading history item:', error);
                }
            }
            window.loadHistoryItem = loadHistoryItem;

            // Render history in modal
            function renderHistory() {
                const history = getHistory();
                const historyList = document.getElementById('history-list');
                const historyCount = document.getElementById('history-count');
                const currentLang = localStorage.getItem('preferredLang') || 'es';

                // Calculate statistics
                const phishingCount = history.filter(item => item.is_phishing).length;
                const legitimateCount = history.length - phishingCount;

                // Update count with statistics
                const countText = currentLang === 'es'
                    ? `${history.length} an√°lisis total | üî¥ ${phishingCount} phishing | üü¢ ${legitimateCount} leg√≠timos`
                    : `${history.length} analyses | üî¥ ${phishingCount} phishing | üü¢ ${legitimateCount} legitimate`;
                historyCount.textContent = countText;

                // Render items or empty state
                if (history.length === 0) {
                    historyList.innerHTML = `
                        <div class="history-empty">
                            <div class="history-empty-icon">üì≠</div>
                            <div class="history-empty-text">${currentLang === 'es' ? 'No hay historial a√∫n' : 'No history yet'}</div>
                            <div class="history-empty-subtext">${currentLang === 'es' ? 'Los an√°lisis que realices aparecer√°n aqu√≠' : 'Your analyses will appear here'}</div>
                        </div>
                    `;
                } else {
                    // Clear existing content
                    historyList.innerHTML = '';

                    history.forEach(item => {
                        const date = new Date(item.timestamp);
                        const dateStr = date.toLocaleString(currentLang === 'es' ? 'es-ES' : 'en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        const resultClass = item.is_phishing ? 'phishing' : 'legitimate';
                        const resultText = item.is_phishing
                            ? (currentLang === 'es' ? '‚ö†Ô∏è Phishing' : '‚ö†Ô∏è Phishing')
                            : (currentLang === 'es' ? '‚úì Leg√≠timo' : '‚úì Legitimate');

                        // SECURITY: Sanitize email preview
                        const sanitizedPreview = sanitizeHTML(item.email_text);
                        const preview = sanitizedPreview.substring(0, 150) + (sanitizedPreview.length > 150 ? '...' : '');

                        const loadBtnText = currentLang === 'es' ? 'üìù Cargar' : 'üìù Load';
                        const deleteBtnText = currentLang === 'es' ? 'üóëÔ∏è Borrar' : 'üóëÔ∏è Delete';

                        // Create history item using DOM methods (safer than innerHTML)
                        const historyItemDiv = document.createElement('div');
                        historyItemDiv.className = 'history-item';

                        // Create header
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'history-item-header';

                        const dateSpan = document.createElement('span');
                        dateSpan.className = 'history-item-date';
                        dateSpan.textContent = dateStr;

                        const resultSpan = document.createElement('span');
                        resultSpan.className = `history-item-result ${resultClass}`;
                        resultSpan.textContent = resultText;

                        headerDiv.appendChild(dateSpan);
                        headerDiv.appendChild(resultSpan);

                        // Create preview
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'history-item-preview';
                        previewDiv.textContent = preview;

                        // Create actions
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'history-item-actions';

                        const loadBtn = document.createElement('button');
                        loadBtn.className = 'history-item-btn load';
                        loadBtn.textContent = loadBtnText;
                        loadBtn.onclick = () => loadHistoryItem(item.id);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'history-item-btn delete';
                        deleteBtn.textContent = deleteBtnText;
                        deleteBtn.onclick = () => deleteHistoryItem(item.id);

                        actionsDiv.appendChild(loadBtn);
                        actionsDiv.appendChild(deleteBtn);

                        // Assemble the item
                        historyItemDiv.appendChild(headerDiv);
                        historyItemDiv.appendChild(previewDiv);
                        historyItemDiv.appendChild(actionsDiv);

                        // Add to history list
                        historyList.appendChild(historyItemDiv);
                    });
                }
            }

            // Update history badge count
            function updateHistoryBadge() {
                const history = getHistory();
                const historyButton = document.getElementById('history-btn');

                if (!historyButton) return; // Safe-guard if element id changed in template

                // Remove old badge if exists
                const oldBadge = historyButton.querySelector('.history-badge');
                if (oldBadge) {
                    oldBadge.remove();
                }

                // Add new badge if there's history
                if (history.length > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'history-badge';
                    badge.textContent = history.length;
                    historyButton.appendChild(badge);
                }
            }

            // MEMORY LEAK FIX: Named function for modal click handler
            function handleModalOutsideClick(e) {
                if (e.target === this) {
                    closeHistoryModal();
                }
            }

            // Open history modal
            function openHistoryModal() {
                renderHistory();
                const modal = document.getElementById('history-modal');
                modal.classList.add('active');

                // Add listener only when modal opens
                modal.addEventListener('click', handleModalOutsideClick);
            }

            // Close history modal
            function closeHistoryModal() {
                const modal = document.getElementById('history-modal');
                modal.classList.remove('active');

                // Remove listener when modal closes (prevent memory leak)
                modal.removeEventListener('click', handleModalOutsideClick);
            }
            window.closeHistoryModal = closeHistoryModal;

            // History button click handler
            const historyButton = document.getElementById('history-btn');
            if (historyButton) {
                historyButton.addEventListener('click', openHistoryModal);
            }

            // Attach close / export / clear handlers for history modal buttons
            const closeHistoryBtn = document.getElementById('close-history');
            if (closeHistoryBtn) {
                closeHistoryBtn.addEventListener('click', closeHistoryModal);
            }

            const exportBtn = document.getElementById('export-history-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportHistory);
            }

            const clearHistoryBtn = document.getElementById('clear-history');
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', clearAllHistory);
            }

            // Initialize badge on load
            updateHistoryBadge();

            // --- File Upload Functionality ---
            // Note: HTML uses ids `file-upload` and `drop-zone` (not `file-input` / `file-upload-area`).
            const fileInput = document.getElementById('file-upload');
            const fileUploadArea = document.getElementById('drop-zone') || document.getElementById('file-upload-area');
            const filePreview = document.getElementById('file-preview');
            const filePreviewName = document.getElementById('file-name');
            const filePreviewInfo = document.getElementById('file-preview-info');
            const filePreviewRemove = document.getElementById('remove-file');
            const emailTextarea = document.getElementById('email_text');

            // Click to upload (guarded)
            if (fileUploadArea && fileInput) {
                fileUploadArea.addEventListener('click', () => {
                    fileInput.click();
                });
            }

            // MEMORY LEAK FIX: Named handlers for drag and drop
            function handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                fileUploadArea.classList.add('dragover');
            }

            function handleDragLeave(e) {
                e.preventDefault();
                e.stopPropagation();
                fileUploadArea.classList.remove('dragover');
            }

            function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                fileUploadArea.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            }

            function handleRemoveFile(e) {
                e.stopPropagation();
                removeFile();
            }

            // Attach event listeners (only once)
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }

            if (fileUploadArea) {
                fileUploadArea.addEventListener('dragover', handleDragOver);
                fileUploadArea.addEventListener('dragleave', handleDragLeave);
                fileUploadArea.addEventListener('drop', handleDrop);
            }

            if (filePreviewRemove) {
                filePreviewRemove.addEventListener('click', handleRemoveFile);
            }

            // Handle file selection
            function handleFileSelect(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            }

            // Process the file
            function handleFile(file) {
                // Validate file type
                const validExtensions = ['.eml', '.msg', '.txt', '.html', '.htm'];
                const fileName = file.name.toLowerCase();
                const isValid = validExtensions.some(ext => fileName.endsWith(ext));

                if (!isValid) {
                    const currentLang = localStorage.getItem('preferredLang') || 'es';
                    const errorMsg = currentLang === 'es'
                        ? 'Tipo de archivo no v√°lido. Por favor sube archivos .eml, .msg, .txt o .html'
                        : 'Invalid file type. Please upload .eml, .msg, .txt or .html files';
                    alert(errorMsg);
                    return;
                }

                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    const currentLang = localStorage.getItem('preferredLang') || 'es';
                    const errorMsg = currentLang === 'es'
                        ? 'El archivo es demasiado grande. M√°ximo 5MB'
                        : 'File is too large. Maximum 5MB';
                    alert(errorMsg);
                    return;
                }

                // Read file content
                const reader = new FileReader();
                reader.onload = function (e) {
                    const content = e.target.result;

                    // Set textarea content
                    emailTextarea.value = content;

                    // Show preview
                    showFilePreview(file, content);
                };
                reader.onerror = function () {
                    const currentLang = localStorage.getItem('preferredLang') || 'es';
                    const errorMsg = currentLang === 'es'
                        ? 'Error al leer el archivo'
                        : 'Error reading file';
                    alert(errorMsg);
                };
                reader.readAsText(file);
            }

            // Show file preview
            function showFilePreview(file, content) {
                const currentLang = localStorage.getItem('preferredLang') || 'es';

                // Hide upload area, show preview
                fileUploadArea.style.display = 'none';
                filePreview.style.display = 'block';

                // Set file name
                filePreviewName.textContent = file.name;

                // Set file info
                const fileSize = (file.size / 1024).toFixed(2);
                const lines = content.split('\n').length;
                const chars = content.length;

                const infoText = currentLang === 'es'
                    ? `Tama√±o: ${fileSize} KB | L√≠neas: ${lines} | Caracteres: ${chars}`
                    : `Size: ${fileSize} KB | Lines: ${lines} | Characters: ${chars}`;

                filePreviewInfo.textContent = infoText;
            }

            // Remove file
            function removeFile() {
                // Reset file input
                fileInput.value = '';

                // Clear textarea
                emailTextarea.value = '';

                // Hide preview, show upload area
                filePreview.style.display = 'none';
                fileUploadArea.style.display = 'flex';
            }

            // --- URL Analysis Functionality ---

            // REDOS PROTECTION: Extract URLs from text with safety limits
            function extractURLs(text) {
                // Limit text length to prevent ReDoS
                const MAX_TEXT_LENGTH = 50000;
                if (text.length > MAX_TEXT_LENGTH) {
                    logger.warn('Text too long for URL extraction, truncating...');
                    text = text.substring(0, MAX_TEXT_LENGTH);
                }

                // Simplified regex - less complex, safer against ReDoS
                // Matches http(s):// URLs and www. URLs with max length limit
                const urlRegex = /https?:\/\/[^\s<>"']{1,500}|www\.[^\s<>"']{1,500}/gi;
                const matches = text.match(urlRegex) || [];

                // Limit number of URLs processed
                const MAX_URLS = 50;
                const limitedMatches = matches.slice(0, MAX_URLS);

                if (matches.length > MAX_URLS) {
                    logger.warn(`Found ${matches.length} URLs, processing only first ${MAX_URLS}`);
                }

                // Clean and normalize URLs
                return limitedMatches.map(url => {
                    url = url.trim();

                    // Remove trailing punctuation
                    url = url.replace(/[.,;:!?)]+$/, '');

                    // Add http:// if missing
                    if (!url.match(/^https?:\/\//i)) {
                        url = 'http://' + url;
                    }
                    return url;
                }).filter((url, index, self) => self.indexOf(url) === index); // Remove duplicates
            }

            // SECURITY: Analyze URL for suspicious characteristics with validation
            function analyzeURL(url) {
                const analysis = {
                    url: url,
                    riskLevel: 'low',
                    riskScore: 0,
                    flags: []
                };

                try {
                    // Validate URL length
                    if (url.length > 2000) {
                        analysis.riskScore += 30;
                        analysis.flags.push({ type: 'high', text: 'Extremely long URL' });
                        analysis.riskLevel = 'high';
                        return analysis;
                    }

                    const urlObj = new URL(url);
                    const domain = urlObj.hostname.toLowerCase();
                    const path = urlObj.pathname.toLowerCase();
                    const fullURL = url.toLowerCase();

                    // Check for IP address instead of domain
                    if (/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(domain)) {
                        analysis.flags.push({ type: 'ip-address', text: '‚ö†Ô∏è IP Address' });
                        analysis.riskScore += 30;
                    }

                    // Check for suspicious TLDs
                    const suspiciousTLDs = ['.tk', '.ml', '.ga', '.cf', '.gq', '.xyz', '.top', '.club', '.work', '.date', '.racing', '.download'];
                    if (suspiciousTLDs.some(tld => domain.endsWith(tld))) {
                        analysis.flags.push({ type: 'suspicious-tld', text: '‚ö†Ô∏è Suspicious TLD' });
                        analysis.riskScore += 20;
                    }

                    // Check for phishing keywords in URL
                    const phishingKeywords = ['verify', 'account', 'update', 'secure', 'banking', 'login', 'signin', 'suspended', 'locked', 'confirm', 'password', 'credential'];
                    if (phishingKeywords.some(keyword => fullURL.includes(keyword))) {
                        analysis.flags.push({ type: 'phishing-keywords', text: 'üö® Phishing Keywords' });
                        analysis.riskScore += 25;
                    }

                    // Check for suspicious domain keywords
                    const suspiciousDomainKeywords = ['paypal', 'amazon', 'microsoft', 'google', 'apple', 'facebook', 'instagram', 'netflix', 'bank', 'secure', 'account', 'verify'];
                    const hasSuspiciousDomain = suspiciousDomainKeywords.some(keyword => {
                        return domain.includes(keyword) && !domain.includes(keyword + '.com') && !domain.endsWith(keyword + '.com');
                    });
                    if (hasSuspiciousDomain) {
                        analysis.flags.push({ type: 'suspicious-domain', text: 'üö® Suspicious Domain' });
                        analysis.riskScore += 35;
                    }

                    // Check for URL shorteners
                    const shorteners = ['bit.ly', 'tinyurl.com', 't.co', 'goo.gl', 'ow.ly', 'is.gd', 'buff.ly', 'adf.ly', 'bit.do', 'cutt.ly', 'short.io'];
                    if (shorteners.some(shortener => domain.includes(shortener))) {
                        analysis.flags.push({ type: 'shortened', text: '‚ö†Ô∏è Shortened URL' });
                        analysis.riskScore += 15;
                    }

                    // Check for long subdomains (often used in phishing)
                    const subdomains = domain.split('.');
                    if (subdomains.length > 4) {
                        analysis.flags.push({ type: 'long-subdomain', text: '‚ö†Ô∏è Long Subdomain' });
                        analysis.riskScore += 15;
                    }

                    // Check for HTTP instead of HTTPS
                    if (urlObj.protocol === 'http:') {
                        analysis.flags.push({ type: 'http-not-secure', text: '‚ö†Ô∏è Not HTTPS' });
                        analysis.riskScore += 10;
                    }

                    // Determine risk level
                    if (analysis.riskScore >= 50) {
                        analysis.riskLevel = 'high';
                    } else if (analysis.riskScore >= 25) {
                        analysis.riskLevel = 'medium';
                    } else {
                        analysis.riskLevel = 'low';
                        if (analysis.flags.length === 0) {
                            analysis.flags.push({ type: 'safe', text: '‚úÖ Looks Safe' });
                        }
                    }

                } catch (error) {
                    logger.error('Error analyzing URL:', error);
                    analysis.flags.push({ type: 'suspicious-domain', text: '‚ö†Ô∏è Invalid URL' });
                    analysis.riskLevel = 'medium';
                }

                return analysis;
            }

            // Display URLs in the UI
            function displayURLs(text) {
                const urls = extractURLs(text);
                const urlSection = document.getElementById('url-analysis-section');
                const urlList = document.getElementById('url-list');
                const urlCountBadge = document.getElementById('url-count-badge');
                const currentLang = localStorage.getItem('preferredLang') || 'es';

                if (urls.length === 0) {
                    urlSection.style.display = 'none';
                    return;
                }

                // Update count
                urlCountBadge.textContent = urls.length;

                // Analyze and display each URL
                let html = '';
                urls.forEach((url, index) => {
                    const analysis = analyzeURL(url);

                    const flagsHTML = analysis.flags.map(flag =>
                        `<span class="url-flag ${flag.type}">${flag.text}</span>`
                    ).join('');

                    html += `
                        <div class="url-item">
                            <div class="url-risk-indicator ${analysis.riskLevel}"></div>
                            <div class="url-content">
                                <div class="url-text">${url}</div>
                                <div class="url-flags">${flagsHTML}</div>
                            </div>
                            <div class="url-actions">
                                <button class="url-action-btn" onclick="copyURL('${url.replace(/'/g, "\\'")}')">
                                    ${currentLang === 'es' ? 'üìã Copiar' : 'üìã Copy'}
                                </button>
                                <button class="url-action-btn" onclick="openURL('${url.replace(/'/g, "\\'")}')">
                                    ${currentLang === 'es' ? 'üîó Abrir' : 'üîó Open'}
                                </button>
                            </div>
                        </div>
                    `;
                });

                urlList.innerHTML = html;
                urlSection.style.display = 'block';
            }

            // Copy URL to clipboard
            const copyURL = (url) => {
                navigator.clipboard.writeText(url).then(() => {
                    const currentLang = localStorage.getItem('preferredLang') || 'es';
                    alert(currentLang === 'es' ? 'URL copiada al portapapeles' : 'URL copied to clipboard');
                }).catch(err => {
                    logger.error('Failed to copy URL:', err);
                });
            };
            window.copyURL = copyURL;

            // Open URL (with warning)
            window.openURL = function (url) {
                const currentLang = localStorage.getItem('preferredLang') || 'es';
                const warningMsg = currentLang === 'es'
                    ? '‚ö†Ô∏è ADVERTENCIA: Esta URL puede ser peligrosa. ¬øEst√°s seguro de que quieres abrirla?'
                    : '‚ö†Ô∏è WARNING: This URL may be dangerous. Are you sure you want to open it?';

                if (confirm(warningMsg)) {
                    window.open(url, '_blank', 'noopener,noreferrer');
                }
            };
            // note: do not overwrite window.openURL here

            // --- Language Toggle Function ---
            function toggleLanguage() {
                const currentLang = localStorage.getItem('preferredLang') || 'es';
                const newLang = currentLang === 'es' ? 'en' : 'es';
                
                localStorage.setItem('preferredLang', newLang);
                applyLanguage(newLang);
                
                // Update button text to show current language
                const langButton = document.getElementById('lang-toggle');
                if (langButton) {
                    langButton.textContent = newLang === 'es' ? 'Espa√±ol' : 'English';
                }
            }

            // --- Apply Language Function ---
            function applyLanguage(lang) {
                const t = translations[lang];
                
                // Update main elements
                const mainHeading = document.getElementById('main-heading');
                if (mainHeading) mainHeading.textContent = t.title;
                
                const textareaLabel = document.getElementById('textarea-label');
                if (textareaLabel) textareaLabel.textContent = t.enter_text;
                
                const analyzeButton = document.getElementById('analyze-btn');
                if (analyzeButton) analyzeButton.innerHTML = `<span>${t.analyze_button}</span>`;
                
                const clearButton = document.getElementById('clear-btn');
                if (clearButton) clearButton.innerHTML = `<span>${t.clear_text}</span>`;
                
                const emailTextarea = document.getElementById('email_text');
                if (emailTextarea) emailTextarea.setAttribute('placeholder', t.placeholder);
                
                // Update sidebar header
                const sidebarHeader = document.getElementById('examples-header-title');
                if (sidebarHeader) sidebarHeader.textContent = t.examples_label;
                
                // Update example buttons
                const exampleNames = ['bank', 'prize', 'social', 'meeting', 'order'];
                exampleNames.forEach(name => {
                    const nameElement = document.getElementById(`example-${name}-name`);
                    const descElement = document.getElementById(`example-${name}-desc`);
                    if (nameElement) nameElement.textContent = t[`ex_${name}_name`];
                    if (descElement) descElement.textContent = t[`ex_${name}_desc`];
                });
                
                // Update category titles
                const phishingCat = document.getElementById('category-phishing-title');
                const legitCat = document.getElementById('category-legit-title');
                if (phishingCat) phishingCat.textContent = t.phishing_cat;
                if (legitCat) legitCat.textContent = t.legit_cat;
                
                // Update file upload text
                const fileUploadTitle = document.getElementById('file-upload-title');
                const fileUploadSubtitle = document.getElementById('file-upload-subtitle');
                if (fileUploadTitle) fileUploadTitle.textContent = t.upload_title;
                if (fileUploadSubtitle) fileUploadSubtitle.textContent = t.upload_subtitle;
            }

            // Load saved language or default to Spanish
            const savedLang = localStorage.getItem('preferredLang') || 'es';
            applyLanguage(savedLang);

            // Update button text to show current language
            const langButton = document.getElementById('lang-toggle');
            if (langButton) {
                langButton.textContent = savedLang === 'es' ? 'Espa√±ol' : 'English';
            }



            // --- Analyze Email Function ---
            async function analyzeEmail() {
                const emailText = document.getElementById('email_text').value;
                const resultArea = document.getElementById('result');
                const currentLang = localStorage.getItem('preferredLang') || 'es';

                if (!emailText.trim()) {
                    alert(currentLang === 'es' ? 'Por favor ingresa el texto del correo' : 'Please enter email text');
                    return;
                }

                // Show loading
                resultArea.style.display = 'block';
                resultArea.innerHTML = '<div class="loading-spinner"></div><p style="text-align:center">Analyzing...</p>';

                try {
                    const response = await fetch('/predict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email_text: emailText })
                    });

                    if (!response.ok) {
                        if (response.status === 404 || response.status === 405) {
                             throw new Error("Server endpoint not found. Please ensure you are running the Flask application (app_hf.py) and accessing it via http://127.0.0.1:5000, not via Live Server.");
                        }
                        throw new Error(`Server error: ${response.status} ${response.statusText}`);
                    }

                    const text = await response.text();
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        console.error("Invalid JSON:", text);
                        throw new Error("Invalid response from server. The server might be returning HTML instead of JSON.");
                    }

                    lastPredictionData = { ...data, email_text: emailText };

                    if (data.error) {
                        showError(data.error);
                        return;
                    }

                    const isPhishing = data.is_phishing;
                    const resultClass = isPhishing ? 'result-phishing' : 'result-legitimate';
                    const icon = isPhishing ? '‚ö†Ô∏è' : '‚úÖ';

                    const t = translations[currentLang];
                    const resultTitle = isPhishing ? t.phishing : t.legitimate;
                    const confidence = (data.confidence * 100).toFixed(1);
                    const confidenceColor = isPhishing ? getCSSVar('--accent-danger') : getCSSVar('--accent-success');

                    // Threat translations
                    const threatTranslations = {
                        en: {
                            'Suspicious domain extension': 'Suspicious domain extension',
                            'URL shortener detected': 'URL shortener detected',
                            'IP address in URL': 'IP address in URL',
                            'Urgent language tactics': 'Urgent language tactics',
                            'Requests credentials': 'Requests credentials',
                            'Too-good-to-be-true offer': 'Too-good-to-be-true offer',
                            'Brand name misspelling': 'Brand name misspelling',
                            'Generic greeting': 'Generic greeting',
                            'Excessive capitalization': 'Excessive capitalization',
                            'phishing keywords': 'phishing keywords',
                            'Google Safe Browsing': 'Google Safe Browsing',
                            'Malware': 'Malware',
                            'Phishing/Social Engineering': 'Phishing/Social Engineering',
                            'Unwanted Software': 'Unwanted Software',
                            'Harmful Application': 'Harmful Application'
                        },
                        es: {
                            'Suspicious domain extension': 'Extensi√≥n de dominio sospechosa',
                            'URL shortener detected': 'Acortador de URL detectado',
                            'IP address in URL': 'Direcci√≥n IP en la URL',
                            'Urgent language tactics': 'T√°cticas de lenguaje urgente',
                            'Requests credentials': 'Solicita credenciales',
                            'Too-good-to-be-true offer': 'Oferta demasiado buena para ser verdad',
                            'Brand name misspelling': 'Nombre de marca mal escrito',
                            'Generic greeting': 'Saludo gen√©rico',
                            'Excessive capitalization': 'Uso excesivo de may√∫sculas',
                            'phishing keywords': 'palabras clave de phishing',
                            'Google Safe Browsing': 'Google Safe Browsing',
                            'Malware': 'Malware',
                            'Phishing/Social Engineering': 'Phishing/Ingenier√≠a Social',
                            'Unwanted Software': 'Software No Deseado',
                            'Harmful Application': 'Aplicaci√≥n Da√±ina'
                        }
                    };

                    // Function to translate threat messages
                    function translateThreat(threat, lang) {
                        // Handle dynamic messages like "7 phishing keywords"
                        const keywordMatch = threat.match(/^(\d+)\s+phishing keywords$/);
                        if (keywordMatch) {
                            const count = keywordMatch[1];
                            return lang === 'es'
                                ? `${count} palabras clave de phishing`
                                : `${count} phishing keywords`;
                        }

                        // Handle Google Safe Browsing threats like "Google Safe Browsing: Malware"
                        const googleMatch = threat.match(/^Google Safe Browsing:\s+(.+)$/);
                        if (googleMatch) {
                            const threatType = googleMatch[1];
                            const translatedType = threatTranslations[lang][threatType] || threatType;
                            return lang === 'es'
                                ? `Google Safe Browsing: ${translatedType}`
                                : `Google Safe Browsing: ${translatedType}`;
                        }

                        // Use translation table or return original if not found
                        return threatTranslations[lang][threat] || threat;
                    }

                    // Build threats list HTML
                    let threatsHTML = '';
                    if (data.threats_detected && data.threats_detected.length > 0) {
                        threatsHTML = '<div class="detail-row" style="grid-column: 1 / -1;"><span class="detail-label">' + t.threatsDetected + ':</span><ul style="margin: 5px 0 0 20px; color: ' + getCSSVar('--accent-danger') + ';">';
                        data.threats_detected.forEach(threat => {
                            const translatedThreat = translateThreat(threat, currentLang);
                            threatsHTML += '<li>' + translatedThreat + '</li>';
                        });
                        threatsHTML += '</ul></div>';
                    } else {
                        threatsHTML = '<div class="detail-row" style="grid-column: 1 / -1;"><span class="detail-label">' + t.threatsDetected + ':</span><span class="detail-value" style="color: ' + getCSSVar('--accent-success') + ';">' + t.none + '</span></div>';
                    }

                    // Build Google Safe Browsing HTML
                    let safeBrowsingHTML = '';
                    if (data.google_safe_browsing) {
                        const gsb = data.google_safe_browsing;
                        safeBrowsingHTML = '<div style="grid-column: 1 / -1; margin-top: 15px; padding-top: 15px; border-top: 1px solid ' + getCSSVar('--border-primary') + ';"><strong>üõ°Ô∏è ' + t.googleSafeBrowsing + '</strong></div>';

                        // Status badge
                        if (gsb.checked) {
                            const statusText = gsb.is_safe ? t.safe : t.malicious;
                            const statusColor = gsb.is_safe ? getCSSVar('--accent-success') : getCSSVar('--accent-danger');
                            const statusIcon = gsb.is_safe ? '‚úì' : '‚ö†Ô∏è';
                            safeBrowsingHTML += '<div class="detail-row"><span class="detail-label">' + t.urlVerification + ':</span><span class="detail-value" style="color: ' + statusColor + ';"> ' + statusIcon + ' ' + statusText + '</span></div>';

                            // Show malicious URLs if found
                            if (!gsb.is_safe && gsb.malicious_urls && gsb.malicious_urls.length > 0) {
                                safeBrowsingHTML += '<div class="detail-row" style="grid-column: 1 / -1;"><span class="detail-label">' + t.maliciousUrls + ':</span><ul style="margin: 5px 0 0 20px; color: ' + getCSSVar('--accent-danger') + ';">';
                                gsb.malicious_urls.forEach(url => {
                                    safeBrowsingHTML += '<li style="word-break: break-all;">' + url + '</li>';
                                });
                                safeBrowsingHTML += '</ul></div>';

                                // Show threat types if found
                                if (gsb.threats_found && gsb.threats_found.length > 0) {
                                    safeBrowsingHTML += '<div class="detail-row" style="grid-column: 1 / -1;"><span class="detail-label">' + t.threatTypes + ':</span><ul style="margin: 5px 0 0 20px; color: ' + getCSSVar('--accent-danger') + ';">';
                                    gsb.threats_found.forEach(threat => {
                                        const translatedThreat = threatTranslations[currentLang][threat] || threat;
                                        safeBrowsingHTML += '<li>' + translatedThreat + '</li>';
                                    });
                                    safeBrowsingHTML += '</ul></div>';
                                }
                            }
                        } else {
                            // API not configured
                            safeBrowsingHTML += '<div class="detail-row" style="grid-column: 1 / -1;"><span class="detail-label">' + t.urlVerification + ':</span><span class="detail-value" style="color: ' + getCSSVar('--text-tertiary') + ';">‚äò ' + t.apiNotConfigured + '</span></div>';
                        }
                    }

                    // Build advanced flags HTML
                    let flagsHTML = '';
                    if (data.flags) {
                        const flagsToShow = [
                            { key: 'suspicious_tld', label: t.suspiciousTLD },
                            { key: 'url_shortener', label: t.urlShortener },
                            { key: 'ip_in_url', label: t.ipInUrl },
                            { key: 'urgency_tactics', label: t.urgencyTactics },
                            { key: 'credential_request', label: t.credentialRequest },
                            { key: 'unrealistic_offer', label: t.unrealisticOffer },
                            { key: 'brand_typo', label: t.brandTypo },
                            { key: 'generic_greeting', label: t.genericGreeting }
                        ];

                        flagsHTML = '<div style="grid-column: 1 / -1; margin-top: 15px; padding-top: 15px; border-top: 1px solid ' + getCSSVar('--border-primary') + ';"><strong>' + t.advancedFlags + '</strong></div>';
                        flagsToShow.forEach(flag => {
                            const value = data.flags[flag.key];
                            const valueText = value ? t.yes : t.no;
                            const valueColor = value ? getCSSVar('--accent-danger') : getCSSVar('--accent-success');
                            flagsHTML += '<div class="detail-row"><span class="detail-label">' + flag.label + ':</span><span class="detail-value" style="color: ' + valueColor + ';">' + valueText + '</span></div>';
                        });
                    }

                    resultArea.innerHTML = `
                    <div class="result-card ${resultClass}">
                        <div class="result-header" style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-size: 1.2rem; font-weight: bold;">
                            <span class="result-icon" style="font-size: 1.5rem;">${icon}</span>
                            <span>${resultTitle}</span>
                        </div>
                        <div class="result-details" style="display: grid; gap: 10px;">
                            <div class="detail-row" style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="detail-label" style="color: var(--text-secondary);">${t.confidence}:</span>
                                <span class="detail-value" style="font-weight: 600;">${confidence}%</span>
                            </div>
                            <div class="confidence-bar" style="height: 8px; background: var(--bg-input); border-radius: 4px; overflow: hidden; margin-bottom: 10px;">
                                <div class="confidence-fill" style="width: ${confidence}%; background-color: ${confidenceColor}; height: 100%;"></div>
                            </div>
                            ${threatsHTML}
                            <div class="detail-row" style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="detail-label" style="color: var(--text-secondary);">${t.risk_score}:</span>
                                <span class="detail-value" style="font-weight: 600;">${data.analysis.risk_score}</span>
                            </div>
                            <div class="detail-row" style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="detail-label" style="color: var(--text-secondary);">${t.textLength}:</span>
                                <span class="detail-value" style="font-weight: 600;">${data.analysis.text_length}</span>
                            </div>
                            <div class="detail-row" style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="detail-label" style="color: var(--text-secondary);">${t.wordCount}:</span>
                                <span class="detail-value" style="font-weight: 600;">${data.analysis.word_count}</span>
                            </div>
                            <div class="detail-row" style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="detail-label" style="color: var(--text-secondary);">${t.urls}:</span>
                                <span class="detail-value" style="font-weight: 600;">${data.analysis.url_count}</span>
                            </div>
                            <div class="detail-row" style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="detail-label" style="color: var(--text-secondary);">${t.keywordMatches}:</span>
                                <span class="detail-value" style="font-weight: 600;">${data.analysis.phishing_keywords}</span>
                            </div>
                            <div class="detail-row" style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="detail-label" style="color: var(--text-secondary);">${t.uppercaseRatio}:</span>
                                <span class="detail-value" style="font-weight: 600;">${(data.analysis.uppercase_ratio * 100).toFixed(1)}%</span>
                            </div>
                            <div class="detail-row" style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="detail-label" style="color: var(--text-secondary);">${t.exclamationMarks}:</span>
                                <span class="detail-value" style="font-weight: 600;">${data.analysis.exclamation_marks}</span>
                            </div>
                            <div class="detail-row" style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="detail-label" style="color: var(--text-secondary);">${t.emojiCount}:</span>
                                <span class="detail-value" style="font-weight: 600;">${data.analysis.emoji_count}</span>
                            </div>
                            ${safeBrowsingHTML}
                            ${flagsHTML}
                        </div>
                        <div id="feedback-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid ${getCSSVar('--border-primary')}; text-align: center;">
                            <p style="margin-bottom: 15px; color: ${getCSSVar('--text-secondary')}; font-size: 14px;">${t.feedbackQuestion}</p>
                            <div style="display: flex; gap: 15px; justify-content: center;">
                                <button onclick="submitFeedback('correct')" style="padding: 10px 20px; background: linear-gradient(135deg, ${getCSSVar('--accent-success')}, ${getCSSVar('--accent-success-hover')}); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s;">
                                    üëç ${t.feedbackCorrect}
                                </button>
                                <button onclick="submitFeedback('incorrect')" style="padding: 10px 20px; background: linear-gradient(135deg, ${getCSSVar('--accent-danger')}, ${getCSSVar('--accent-danger-hover')}); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s;">
                                    üëé ${t.feedbackIncorrect}
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                    // Save to history
                    // Save to history
                    saveToHistory(emailText, data.prediction, data.confidence, data);

                    // Enable dragging after result is shown
                    window.enableDraggableResult();

                } catch (error) {
                    logger.error('Error analyzing email:', error);
                    let errorMsg = currentLang === 'es' ? 'Error al analizar el correo' : 'Error analyzing email';
                    if (error.message) {
                        errorMsg += ': ' + error.message;
                    }
                    showError(errorMsg);
                }
            }

            // --- Show Error ---
            function showError(message) {
                const currentLang = localStorage.getItem('preferredLang') || 'es';
                const errorTitle = currentLang === 'es' ? 'Error' : 'Error';
                const resultArea = document.getElementById('result');

                resultArea.innerHTML = `
                    <div class="result error">
                        <div class="result-header">
                            <span class="result-icon">‚ùå</span>
                            <span>${errorTitle}</span>
                        </div>
                        <div class="result-details">
                            ${message}
                        </div>
                    </div>
                `;
            }

            // --- Submit Feedback Function ---
            window.submitFeedback = async function (feedbackType) {
                if (!lastPredictionData) {
                    logger.error('No prediction data available');
                    return;
                }

                const currentLang = localStorage.getItem('preferredLang') || 'es';
                const translations = {
                    en: {
                        thanks: 'Thank you for your feedback!',
                        error: 'Error submitting feedback'
                    },
                    es: {
                        thanks: '¬°Gracias por tu retroalimentaci√≥n!',
                        error: 'Error al enviar retroalimentaci√≥n'
                    }
                };

                try {
                    const response = await fetch('/feedback', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email_text: lastPredictionData.email_text,
                            prediction: lastPredictionData.prediction,
                            user_feedback: feedbackType,
                            confidence: lastPredictionData.confidence,
                            risk_score: lastPredictionData.risk_score,
                            threats_detected: lastPredictionData.threats_detected,
                            google_safe_browsing_checked: lastPredictionData.google_safe_browsing_checked,
                            google_safe_browsing_safe: lastPredictionData.google_safe_browsing_safe
                        })
                    });

                    if (response.ok) {
                        // Replace feedback section with thank you message
                        const feedbackSection = document.getElementById('feedback-section');
                        if (feedbackSection) {
                            feedbackSection.innerHTML = `
                            <p style="color: ${getCSSVar('--accent-success')}; font-weight: bold; font-size: 16px;">
                                ‚úì ${translations[currentLang].thanks}
                            </p>
                        `;
                        }
                    } else {
                        alert(translations[currentLang].error);
                    }
                } catch (error) {
                    logger.error('Feedback error:', error);
                    alert(translations[currentLang].error);
                }
            };

            // Attach event listeners for Analyze and Clear buttons
            const analyzeButton = document.getElementById('analyze-btn');
            if (analyzeButton) {
                analyzeButton.addEventListener('click', analyzeEmail);
            } else {
                console.error("Analyze button not found");
            }

            const clearButton = document.getElementById('clear-btn');
            if (clearButton) {
                clearButton.addEventListener('click', clearTextArea);
            } else {
                console.error("Clear button not found");
            }

            // Attach event listener for Language Toggle button
            const langToggleBtn = document.getElementById('lang-toggle');
            if (langToggleBtn) {
                langToggleBtn.addEventListener('click', toggleLanguage);
            } else {
                console.error("Language toggle button not found");
            }

        }); // End DOMContentLoaded

        // --- Clear Text Area Function ---
        function clearTextArea() {
            const emailText = document.getElementById('email_text');
            if (emailText) emailText.value = '';

            // Clear the result area as well
            const resultArea = document.getElementById('result');
            if (resultArea) {
                resultArea.innerHTML = '';
                resultArea.style.display = 'none';
            }

            // Clear file upload if exists
            const fileInput = document.getElementById('file-upload');
            const filePreview = document.getElementById('file-preview');
            const dropZone = document.getElementById('drop-zone');

            if (fileInput) fileInput.value = '';

            if (filePreview && dropZone) {
                filePreview.style.display = 'none';
                dropZone.style.display = 'flex';
            }

            // Clear URL analysis
            const urlSection = document.getElementById('url-analysis-section');
            if (urlSection) {
                urlSection.style.display = 'none';
            }
        }

        // --- Examples Section Functions ---
        function loadExample(exampleKey) {
            const currentLang = localStorage.getItem('preferredLang') || 'es';
            // Define examples directly here or ensure 'examples' object is available globally
            // For safety, let's define a minimal set or check if 'examples' exists
            if (typeof examples === 'undefined') {
                console.error("Examples data not found");
                return;
            }

            const exampleText = examples[exampleKey]?.[currentLang];

            if (exampleText) {
                const textarea = document.getElementById('email_text');
                textarea.value = exampleText;

                // Smooth scroll to textarea
                textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Add a highlight animation
                textarea.style.transition = 'background-color 0.5s ease';
                const originalBg = getComputedStyle(textarea).backgroundColor;
                textarea.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';

                setTimeout(() => {
                    textarea.style.backgroundColor = originalBg;
                }, 1000);
            } else {
                logger.error('Example not found:', exampleKey);
            }
        }

        // Global Z-Index for stacking order
        let globalZIndex = 1000;

        // --- Draggable Elements System ---
        function makeDraggable(element, defaultPos = null) {
            // Prevent double initialization
            if (element.classList.contains('is-draggable')) return;
            element.classList.add('is-draggable');

            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            // Ensure element is positioned for dragging
            element.style.position = 'fixed';
            element.style.zIndex = ++globalZIndex;
            element.style.boxShadow = '0 10px 25px rgba(0,0,0,0.5)';
            element.style.transition = 'none'; // Disable transition during drag

            // Create drag handle
            const dragHandle = document.createElement('div');
            dragHandle.className = 'drag-handle';
            dragHandle.style.cssText = `
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 15px;
                height: 40px;
                background: linear-gradient(90deg, #3b82f6, #2563eb);
                color: white;
                font-family: sans-serif;
                font-weight: bold;
                font-size: 14px;
                cursor: move;
                border-radius: 8px 8px 0 0;
                user-select: none;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            `;
            
            const titleSpan = document.createElement('span');
            titleSpan.textContent = '‚ú• DRAG ME';
            
            const resetBtn = document.createElement('button');
            resetBtn.textContent = '‚Ü∫ Reset';
            resetBtn.style.cssText = `
                background: rgba(255,255,255,0.2);
                border: none;
                color: white;
                border-radius: 4px;
                padding: 2px 8px;
                cursor: pointer;
                font-size: 11px;
            `;
            resetBtn.onclick = (e) => {
                e.stopPropagation(); // Prevent drag start
                xOffset = 0;
                yOffset = 0;
                setTranslate(0, 0, element);
                // Clear storage
                const elementId = element.id || element.className;
                localStorage.removeItem(`drag_pos_${elementId}`);
                
                // Reset to default position
                if (defaultPos) {
                    element.style.top = defaultPos.top || '20%';
                    element.style.left = defaultPos.left || '50%';
                    if (defaultPos.transform) element.style.transform = defaultPos.transform;
                } else {
                    element.style.top = '20%';
                    element.style.left = '50%';
                    element.style.transform = 'translateX(-50%)';
                }
            };

            dragHandle.appendChild(titleSpan);
            dragHandle.appendChild(resetBtn);

            // Insert handle at the top
            element.insertBefore(dragHandle, element.firstChild);

            // Bring to front on click
            element.addEventListener('mousedown', () => {
                element.style.zIndex = ++globalZIndex;
            });

            // Drag events
            dragHandle.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            dragHandle.addEventListener('touchstart', dragStart);
            document.addEventListener('touchmove', drag);
            document.addEventListener('touchend', dragEnd);

            function dragStart(e) {
                if (e.type === 'touchstart') {
                    initialX = e.touches[0].clientX - xOffset;
                    initialY = e.touches[0].clientY - yOffset;
                } else {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                }

                if (e.target === dragHandle || e.target === titleSpan) {
                    isDragging = true;
                    element.style.opacity = '0.9';
                    element.style.zIndex = ++globalZIndex;
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();

                    if (e.type === 'touchmove') {
                        currentX = e.touches[0].clientX - initialX;
                        currentY = e.touches[0].clientY - initialY;
                    } else {
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                    }

                    xOffset = currentX;
                    yOffset = currentY;

                    setTranslate(currentX, currentY, element);
                }
            }

            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                element.style.opacity = '1';

                // Save position
                const elementId = element.id || element.className;
                localStorage.setItem(`drag_pos_${elementId}`, JSON.stringify({ x: xOffset, y: yOffset }));
            }

            function setTranslate(xPos, yPos, el) {
                el.style.transform = `translate(${xPos}px, ${yPos}px)`;
            }

            // Load saved position or set default
            const elementId = element.id || element.className;
            const savedPos = localStorage.getItem(`drag_pos_${elementId}`);
            
            if (savedPos) {
                const pos = JSON.parse(savedPos);
                xOffset = pos.x;
                yOffset = pos.y;
                setTranslate(pos.x, pos.y, element);
            } else if (defaultPos) {
                // Apply default position
                element.style.top = defaultPos.top || '';
                element.style.left = defaultPos.left || '';
                element.style.right = defaultPos.right || '';
                if (defaultPos.width) element.style.width = defaultPos.width;
                if (defaultPos.maxWidth) element.style.maxWidth = defaultPos.maxWidth;
            } else {
                // Fallback defaults
                if (element.id === 'result') {
                    element.style.top = '100px';
                    element.style.left = '50px';
                    element.style.right = '50px';
                    element.style.width = 'auto';
                    element.style.maxWidth = '800px';
                }
            }
        }

        // Enable dragging when result is shown
        window.enableDraggableResult = function() {
            // Small delay to ensure DOM is ready
            setTimeout(() => {
                const resultArea = document.getElementById('result');
                
                if (resultArea && resultArea.style.display !== 'none') {
                    makeDraggable(resultArea, {
                        top: '150px',
                        left: '50%',
                        transform: 'translateX(-50%)',
                        width: '90%',
                        maxWidth: '800px'
                    });
                }
            }, 100);
        };

        // Initialize draggable elements on load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Sidebar
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    if (!sidebar.id) sidebar.id = 'sidebar-panel';
                    makeDraggable(sidebar, {
                        top: '100px',
                        left: 'auto',
                        right: '20px',
                        width: '300px'
                    });
                }

                // Input Area
                const inputArea = document.querySelector('.input-area');
                if (inputArea) {
                    if (!inputArea.id) inputArea.id = 'input-panel';
                    
                    // Apply card styling
                    inputArea.style.background = 'var(--bg-secondary)';
                    inputArea.style.backdropFilter = 'blur(12px)';
                    inputArea.style.padding = '1.5rem';
                    inputArea.style.borderRadius = 'var(--radius-md)';
                    inputArea.style.border = '1px solid var(--border-primary)';
                    
                    makeDraggable(inputArea, {
                        top: '100px',
                        left: '20px',
                        width: 'calc(100% - 360px)', // Leave room for sidebar
                        maxWidth: '800px'
                    });
                }
            }, 500);
        });
    </script>
    

</body>

</html>