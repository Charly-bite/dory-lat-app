<!doctype html>
<html lang="en"> <!-- Lang attribute will be updated by JS -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dory-Lat Phishing Detector</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='Favicon Gabo 16x16.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='Favicon Gabo 32x32.png') }}">
    <link rel="icon" type="image/png" sizes="128x128" href="{{ url_for('static', filename='Favicon Gabo 128x128.png') }}">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='Favicon Gabo 512x512.png') }}">
    <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='Favicon Gabo 512x512.png') }}">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* === CSS Variables for Theme System === */
        :root {
            /* Dark Theme (Default) */
            --bg-primary: #1a1a2e;
            --bg-secondary: rgba(26, 26, 46, 0.8);
            --bg-gradient-start: #16213e;
            --bg-gradient-end: #0f3460;
            --bg-input: #1a1a2e;
            --bg-select: #1a1f2e;
            
            --text-primary: #ffffff;
            --text-secondary: #a9b4d2;
            --text-placeholder: #a9b4d2;
            --text-select: #e8e6e3;
            
            --border-primary: #0f3460;
            --border-secondary: rgba(255, 255, 255, 0.18);
            --border-light: rgba(255, 255, 255, 0.1);
            --border-medium: rgba(255, 255, 255, 0.2);
            
            --accent-danger: #e94560;
            --accent-danger-hover: #c62a42;
            --accent-danger-light: #f7b6c0;
            --accent-danger-bg: rgba(233, 69, 96, 0.1);
            
            --accent-success: #14dd7a;
            --accent-success-dark: #0fa368;
            --accent-success-light: #a1e9c4;
            --accent-success-bg: rgba(20, 221, 122, 0.1);
            
            --accent-warning: #ffc107;
            --accent-warning-light: #ffddaa;
            --accent-warning-bg: rgba(255, 193, 7, 0.1);
            
            --btn-clear: #536976;
            --btn-clear-hover: #41515b;
            --btn-outline: #f0f0f0;
            
            --shadow-primary: rgba(0, 0, 0, 0.37);
            --shadow-accent: rgba(233, 69, 96, 0.3);
            --shadow-hover: rgba(233, 69, 96, 0.4);
            
            --overlay-bg: rgba(255, 255, 255, 0.1);
            --gray-text: #888;
            --feedback-text: #ccc;
            
            /* Theme transition */
            --transition-speed: 0.3s;
        }
        
        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #f5f7fa;
            --bg-secondary: rgba(255, 255, 255, 0.9);
            --bg-gradient-start: #e8eaf6;
            --bg-gradient-end: #c5cae9;
            --bg-input: #ffffff;
            --bg-select: #ffffff;
            
            --text-primary: #1a1a2e;
            --text-secondary: #5a6c7d;
            --text-placeholder: #9099a3;
            --text-select: #2c3e50;
            
            --border-primary: #d1d8e0;
            --border-secondary: rgba(0, 0, 0, 0.1);
            --border-light: rgba(0, 0, 0, 0.08);
            --border-medium: rgba(0, 0, 0, 0.15);
            
            --accent-danger: #d32f2f;
            --accent-danger-hover: #b71c1c;
            --accent-danger-light: #c62828;
            --accent-danger-bg: rgba(211, 47, 47, 0.08);
            
            --accent-success: #388e3c;
            --accent-success-dark: #2e7d32;
            --accent-success-light: #4caf50;
            --accent-success-bg: rgba(56, 142, 60, 0.08);
            
            --accent-warning: #f57c00;
            --accent-warning-light: #ff9800;
            --accent-warning-bg: rgba(245, 124, 0, 0.08);
            
            --btn-clear: #78909c;
            --btn-clear-hover: #607d8b;
            --btn-outline: #37474f;
            
            --shadow-primary: rgba(0, 0, 0, 0.12);
            --shadow-accent: rgba(211, 47, 47, 0.2);
            --shadow-hover: rgba(211, 47, 47, 0.3);
            
            --overlay-bg: rgba(0, 0, 0, 0.05);
            --gray-text: #666;
            --feedback-text: #555;
        }
        
        /* Smooth transitions for theme changes */
        * {
            transition: background-color var(--transition-speed) ease,
                        color var(--transition-speed) ease,
                        border-color var(--transition-speed) ease;
        }
        
        /* Prevent transition on page load */
        .no-transition * {
            transition: none !important;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: start; /* Align to top */
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
        }
        .container {
            background-color: var(--bg-secondary);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 var(--shadow-primary);
            width: 90%;
            max-width: 700px;
            text-align: center; /* Center align text */
            margin-top: 20px; /* Add some margin top */
            border: 1px solid var(--border-secondary);
        }
        h1 {
            color: var(--text-primary);
            margin-bottom: 25px;
            font-weight: 600;
        }
        label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-secondary);
            font-weight: 400;
            text-align: left; /* Align label text left */
        }
        textarea {
            width: 100%;
            min-height: 180px; /* Increased height */
            padding: 15px;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 25px;
            box-sizing: border-box; /* Include padding and border in width */
            background-color: var(--bg-input);
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
        }
        textarea::placeholder { /* Style the placeholder text */
            color: var(--text-placeholder);
            font-style: italic;
        }
        .button-container {
            display: flex;
            justify-content: space-between; /* Space out buttons */
            gap: 15px; /* Add gap between buttons */
            margin-bottom: 25px;
        }
        button {
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-grow: 1; /* Make buttons share space */
        }
        .analyze-button {
            background-color: var(--accent-danger);
            color: white;
        }
        .analyze-button:hover {
            background-color: var(--accent-danger-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--shadow-hover);
        }
        .clear-button {
            background-color: var(--btn-clear);
            color: white;
        }
        .clear-button:hover {
            background-color: var(--btn-clear-hover);
            transform: translateY(-2px);
        }
        .lang-button { /* Style for language button */
            background-color: transparent;
            color: var(--btn-outline);
            border: 1px solid var(--btn-outline);
            max-width: 150px; /* Adjust width if needed */
            flex-grow: 0; /* Don't let it grow like others */
        }
        .lang-button:hover {
            background-color: var(--btn-outline);
            color: var(--bg-primary);
        }
        .result {
            margin-top: 25px;
            padding: 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            word-wrap: break-word; /* Ensure long results wrap */
            text-align: left; /* Align result text left */
            border-left: 5px solid;
        }
        .result.phishing {
            background-color: var(--result-phishing-bg);
            color: var(--result-phishing-text);
            border-color: var(--accent-danger);
        }
        .result.legitimate {
            background-color: var(--result-legitimate-bg);
            color: var(--result-legitimate-text);
            border-color: var(--accent-success);
        }
        .result.error, .model-error { /* Combined error style */
            background-color: var(--result-warning-bg);
            color: var(--result-warning-text);
            border-color: var(--accent-warning);
            text-align: left; /* Align error text left */
        }
        .model-error { /* Specific style for model load error */
             margin-bottom: 20px; /* Add space below model error */
             padding: 15px;
             font-size: 0.9rem;
        }
        /* Result details styles */
        .result-header {
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .result-icon {
            font-size: 1.5rem;
        }
        .result-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-primary);
            font-size: 0.9rem;
            font-weight: normal;
        }
        .detail-row {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
        .detail-label {
            opacity: 0.8;
        }
        .detail-value {
            font-weight: 600;
        }
        .confidence-bar {
            width: 100%;
            height: 8px;
            background-color: var(--confidence-bg);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        .confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .loading {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
        }
        .spinner {
            border: 3px solid var(--spinner-bg);
            border-top: 3px solid var(--accent-danger);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Add container for header and button */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .header-container h1 {
            margin: 0; /* Remove default h1 margin */
            text-align: left; /* Ensure heading stays left */
            flex-grow: 1; /* Allow heading to take space */
        }
        /* Logo styles */
        .logo-link {
            display: inline-block;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        .logo-link:hover {
            transform: scale(1.1);
        }
        .logo-link img {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            box-shadow: 0 4px 15px var(--shadow-hover);
        }
        /* Footer styles */
        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-primary);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .footer a {
            color: var(--accent-danger);
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .footer a:hover {
            color: var(--accent-danger-light);
        }
        
        /* Theme toggle button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--bg-input);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px var(--shadow-primary);
            z-index: 1000;
        }
        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 6px 20px var(--shadow-hover);
        }
        
        /* History button */
        .history-button {
            position: fixed;
            top: 20px;
            right: 80px;
            background-color: var(--bg-input);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px var(--shadow-primary);
            z-index: 1000;
        }
        .history-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px var(--shadow-hover);
            background-color: var(--accent-danger);
            color: white;
        }
        
        /* Modal overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        
        /* Modal content */
        .modal-content {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px var(--shadow-primary);
        }
        
        /* Modal header */
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.5rem;
        }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            transition: all 0.3s ease;
        }
        .modal-close:hover {
            color: var(--accent-danger);
            transform: rotate(90deg);
        }
        
        /* Modal body */
        .modal-body {
            padding: 20px 25px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        /* History item */
        .history-item {
            background-color: var(--bg-input);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .history-item:hover {
            border-color: var(--accent-danger);
            box-shadow: 0 2px 8px var(--shadow-hover);
        }
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .history-item-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .history-item-result {
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .history-item-result.phishing {
            background-color: var(--result-phishing-bg);
            color: var(--result-phishing-text);
        }
        .history-item-result.legitimate {
            background-color: var(--result-legitimate-bg);
            color: var(--result-legitimate-text);
        }
        .history-item-preview {
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 10px;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-item-actions {
            display: flex;
            gap: 10px;
        }
        .history-item-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .history-item-btn.load {
            background-color: var(--accent-success);
            color: white;
        }
        .history-item-btn.load:hover {
            background-color: var(--accent-success-hover);
        }
        .history-item-btn.delete {
            background-color: transparent;
            color: var(--accent-danger);
            border: 1px solid var(--accent-danger);
        }
        .history-item-btn.delete:hover {
            background-color: var(--accent-danger);
            color: white;
        }
        
        /* Modal footer */
        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-footer-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .modal-footer-btn.export {
            background-color: var(--accent-success);
            color: white;
        }
        .modal-footer-btn.export:hover {
            background-color: var(--accent-success-hover);
        }
        .modal-footer-btn.clear {
            background-color: transparent;
            color: var(--accent-danger);
            border: 1px solid var(--accent-danger);
        }
        .modal-footer-btn.clear:hover {
            background-color: var(--accent-danger);
            color: white;
        }
        
        /* Empty state */
        .history-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        .history-empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .history-empty-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        .history-empty-subtext {
            font-size: 0.9rem;
            opacity: 0.8;
        }
    </style>
</head>
<body class="no-transition">
    <!-- Theme Toggle Button -->
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
        üåô
    </button>
    
    <!-- History Button -->
    <button id="history-button" class="history-button" aria-label="View history">
        üìú
    </button>
    
    <div class="container">

        <a href="https://github.com/Charly-bite" target="_blank" class="logo-link" rel="noopener noreferrer">
            <img src="{{ url_for('static', filename='Favicon Gabo 128x128.png') }}" alt="GitHub Profile">
        </a>

        <div class="header-container">
            <!-- Added ID for translation -->
            <h1 id="main-heading">Phishing Detector</h1>
            <!-- Added Language Toggle Button -->
            <button id="lang-toggle" class="lang-button">Espa√±ol</button>
        </div>

        {% if model_error %}
            <div class="model-error">{{ model_error }}</div>
        {% endif %}

        <form id="email-form">
             <!-- Added ID for translation -->
            <label for="email_text" id="textarea-label">Enter the email text below:</label>
            
            <!-- Example Selector -->
            <div style="margin-bottom: 15px;">
                <select id="example-selector" style="width: 100%; padding: 12px; border-radius: 8px; background-color: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border-primary); font-size: 1rem; cursor: pointer;">
                    <option value="" id="example-option-default">-- Select an example to test --</option>
                    <option value="phishing_bank" id="example-option-bank">üè¶ Phishing: Fake Bank Alert</option>
                    <option value="phishing_prize" id="example-option-prize">üéÅ Phishing: Fake Prize/Lottery</option>
                    <option value="phishing_social" id="example-option-social">üì± Phishing: Social Media Alert</option>
                    <option value="phishing_urgency" id="example-option-urgency">‚ö†Ô∏è Phishing: Urgent Action Required</option>
                    <option value="legitimate_work" id="example-option-work">‚úÖ Legitimate: Work Meeting</option>
                    <option value="legitimate_service" id="example-option-service">üì¶ Legitimate: Order Confirmation</option>
                </select>
            </div>
            
            <!-- Added placeholder attribute -->
            <textarea
                id="email_text"
                name="email_text"
                required
                placeholder="Paste the full email content here, not just the address..."
                >{{ email_text or '' }}</textarea>

            <div class="button-container">
                 <!-- Added ID for translation -->
                <button type="submit" class="analyze-button" id="analyze-button">Analyze Email</button>
                 <!-- Added ID for translation -->
                <button type="button" class="clear-button" id="clear-button" onclick="clearTextArea()">Clear Text</button>
            </div>
        </form>

        <!-- Added ID for the result container -->
        <div id="result-area">
            {% if prediction_text %}
                <div class="result {% if 'Phishing' in prediction_text %}phishing{% elif 'Legitimate' in prediction_text %}legitimate{% else %}error{% endif %}">
                    {{ prediction_text }}
                </div>
            {% endif %}
        </div>

        <div class="footer">
            Contact: <a href="mailto:carlos.aceves6195@alumnos.udg.mx">carlos.aceves6195@alumnos.udg.mx</a>
        </div>
    </div>

    <script>
        // Wait for the HTML to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- Theme Toggle Logic ---
            const themeToggle = document.getElementById('theme-toggle');
            const html = document.documentElement;
            
            // Helper function to get CSS variable values
            function getCSSVar(varName) {
                return getComputedStyle(html).getPropertyValue(varName).trim();
            }
            
            // Load saved theme or default to dark
            const savedTheme = localStorage.getItem('theme') || 'dark';
            html.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            // Remove no-transition class after initial load
            setTimeout(() => {
                document.body.classList.remove('no-transition');
            }, 100);
            
            // Theme toggle handler
            themeToggle.addEventListener('click', function() {
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });
            
            // Update theme icon
            function updateThemeIcon(theme) {
                themeToggle.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
                themeToggle.setAttribute('aria-label', theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
            }
            
            // --- History Management Functions ---
            const HISTORY_KEY = 'dory_analysis_history';
            const MAX_HISTORY_ITEMS = 10;
            
            // Get history from localStorage
            function getHistory() {
                try {
                    const history = localStorage.getItem(HISTORY_KEY);
                    return history ? JSON.parse(history) : [];
                } catch (error) {
                    console.error('Error reading history:', error);
                    return [];
                }
            }
            
            // Save analysis to history
            function saveToHistory(emailText, prediction, confidence, data) {
                try {
                    const history = getHistory();
                    const newEntry = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        email_text: emailText,
                        prediction: prediction,
                        confidence: confidence,
                        is_phishing: data.is_phishing,
                        risk_score: data.risk_score || 0,
                        threats_detected: data.threats_detected || [],
                        google_safe_browsing: data.google_safe_browsing || null
                    };
                    
                    // Add to beginning of array
                    history.unshift(newEntry);
                    
                    // Keep only last MAX_HISTORY_ITEMS
                    if (history.length > MAX_HISTORY_ITEMS) {
                        history.splice(MAX_HISTORY_ITEMS);
                    }
                    
                    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                    console.log('Analysis saved to history');
                } catch (error) {
                    console.error('Error saving to history:', error);
                }
            }
            
            // Delete single history item
            function deleteHistoryItem(id) {
                try {
                    let history = getHistory();
                    history = history.filter(item => item.id !== id);
                    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                    renderHistory();
                } catch (error) {
                    console.error('Error deleting history item:', error);
                }
            }
            
            // Clear all history
            function clearAllHistory() {
                const currentLang = localStorage.getItem('preferredLang') || 'es';
                const confirmMsg = currentLang === 'es' 
                    ? '¬øEst√°s seguro de que quieres borrar todo el historial?' 
                    : 'Are you sure you want to clear all history?';
                
                if (confirm(confirmMsg)) {
                    localStorage.removeItem(HISTORY_KEY);
                    renderHistory();
                }
            }
            
            // Export history as JSON
            function exportHistory() {
                try {
                    const history = getHistory();
                    if (history.length === 0) {
                        const currentLang = localStorage.getItem('preferredLang') || 'es';
                        alert(currentLang === 'es' ? 'No hay historial para exportar' : 'No history to export');
                        return;
                    }
                    
                    const dataStr = JSON.stringify(history, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `dory-analysis-history-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Error exporting history:', error);
                }
            }
            
            // Load history item into textarea
            function loadHistoryItem(id) {
                try {
                    const history = getHistory();
                    const item = history.find(h => h.id === id);
                    if (item) {
                        const emailTextarea = document.getElementById('email_text');
                        emailTextarea.value = item.email_text;
                        closeHistoryModal();
                        
                        // Scroll to textarea
                        emailTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Optional: auto-analyze
                        // document.getElementById('email-form').dispatchEvent(new Event('submit'));
                    }
                } catch (error) {
                    console.error('Error loading history item:', error);
                }
            }
            
            // Render history in modal
            function renderHistory() {
                const history = getHistory();
                const historyList = document.getElementById('history-list');
                const historyCount = document.getElementById('history-count');
                const currentLang = localStorage.getItem('preferredLang') || 'es';
                
                // Update count
                const countText = currentLang === 'es' 
                    ? `${history.length} an√°lisis` 
                    : `${history.length} analyses`;
                historyCount.textContent = countText;
                
                // Render items or empty state
                if (history.length === 0) {
                    historyList.innerHTML = `
                        <div class="history-empty">
                            <div class="history-empty-icon">üì≠</div>
                            <div class="history-empty-text">${currentLang === 'es' ? 'No hay historial a√∫n' : 'No history yet'}</div>
                            <div class="history-empty-subtext">${currentLang === 'es' ? 'Los an√°lisis que realices aparecer√°n aqu√≠' : 'Your analyses will appear here'}</div>
                        </div>
                    `;
                } else {
                    let html = '';
                    history.forEach(item => {
                        const date = new Date(item.timestamp);
                        const dateStr = date.toLocaleString(currentLang === 'es' ? 'es-ES' : 'en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        const resultClass = item.is_phishing ? 'phishing' : 'legitimate';
                        const resultText = item.is_phishing 
                            ? (currentLang === 'es' ? '‚ö†Ô∏è Phishing' : '‚ö†Ô∏è Phishing')
                            : (currentLang === 'es' ? '‚úì Leg√≠timo' : '‚úì Legitimate');
                        
                        const preview = item.email_text.substring(0, 150) + (item.email_text.length > 150 ? '...' : '');
                        
                        const loadBtnText = currentLang === 'es' ? 'üìù Cargar' : 'üìù Load';
                        const deleteBtnText = currentLang === 'es' ? 'üóëÔ∏è Borrar' : 'üóëÔ∏è Delete';
                        
                        html += `
                            <div class="history-item">
                                <div class="history-item-header">
                                    <span class="history-item-date">${dateStr}</span>
                                    <span class="history-item-result ${resultClass}">${resultText}</span>
                                </div>
                                <div class="history-item-preview">${preview}</div>
                                <div class="history-item-actions">
                                    <button class="history-item-btn load" onclick="loadHistoryItem(${item.id})">
                                        ${loadBtnText}
                                    </button>
                                    <button class="history-item-btn delete" onclick="deleteHistoryItem(${item.id})">
                                        ${deleteBtnText}
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    historyList.innerHTML = html;
                }
            }
            
            // Open history modal
            function openHistoryModal() {
                renderHistory();
                document.getElementById('history-modal').classList.add('active');
            }
            
            // Close history modal
            function closeHistoryModal() {
                document.getElementById('history-modal').classList.remove('active');
            }
            
            // History button click handler
            const historyButton = document.getElementById('history-button');
            historyButton.addEventListener('click', openHistoryModal);
            
            // Close modal when clicking outside
            document.getElementById('history-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeHistoryModal();
                }
            });

            // --- Elements to Translate ---
            const elements = {
                mainHeading: document.getElementById('main-heading'),
                textareaLabel: document.getElementById('textarea-label'),
                analyzeButton: document.getElementById('analyze-button'),
                clearButton: document.getElementById('clear-button'),
                langToggleButton: document.getElementById('lang-toggle'),
                emailTextarea: document.getElementById('email_text'), // Reference to textarea for placeholder
                exampleSelector: document.getElementById('example-selector'),
                exampleOptionDefault: document.getElementById('example-option-default'),
                exampleOptionBank: document.getElementById('example-option-bank'),
                exampleOptionPrize: document.getElementById('example-option-prize'),
                exampleOptionSocial: document.getElementById('example-option-social'),
                exampleOptionUrgency: document.getElementById('example-option-urgency'),
                exampleOptionWork: document.getElementById('example-option-work'),
                exampleOptionService: document.getElementById('example-option-service'),
                historyModalTitle: document.getElementById('history-modal-title'),
                exportBtnText: document.getElementById('export-btn-text'),
                clearBtnText: document.getElementById('clear-btn-text'),
            };

            // --- Example Emails ---
            const examples = {
                phishing_bank: {
                    en: "URGENT: SECURITY ALERT\n\nDear valued customer,\n\nYour Bank of America account has been LOCKED due to suspicious activity detected from Nigeria. You must verify your identity IMMEDIATELY or your account will be permanently closed within 24 hours.\n\nClick here to verify now: http://bankofamerica-secure-login.tk/verify?id=8472910\n\nDO NOT ignore this message. Failure to act will result in permanent loss of access to your funds.\n\nBank Security Team\n(This is an automated message, do not reply)",
                    es: "URGENTE: ALERTA DE SEGURIDAD\n\nEstimado cliente,\n\nSu cuenta de Banco Santander ha sido BLOQUEADA debido a actividad sospechosa detectada desde el extranjero. Debe verificar su identidad INMEDIATAMENTE o su cuenta ser√° cerrada permanentemente en las pr√≥ximas 24 horas.\n\nHaga clic aqu√≠ para verificar ahora: http://bancosantander-verificacion.tk/login?id=8472910\n\nNO ignore este mensaje. Si no act√∫a, perder√° acceso permanente a sus fondos.\n\nEquipo de Seguridad Bancaria\n(Este es un mensaje automatizado, no responda)"
                },
                phishing_prize: {
                    en: "üéâ CONGRATULATIONS! YOU'VE WON! üéâ\n\nDear LUCKY WINNER,\n\nYou have been selected as the GRAND PRIZE WINNER of our Apple iPhone 15 Pro Max GIVEAWAY! üì±‚ú®\n\nYour winning number: #847291\nPrize value: $1,299 USD\n\nClaim your FREE iPhone now before it expires:\nüëâ http://apple-prizes-claim.xyz/winner?code=IPHONE2024\n\nHurry! Only 3 hours left to claim!\n\nüéÅ 100% FREE - No purchase necessary!\nüöö FREE International Shipping!\n\nClick NOW or lose your prize forever!",
                    es: "üéâ ¬°FELICIDADES! ¬°HAS GANADO! üéâ\n\nEstimado GANADOR AFORTUNADO,\n\n¬°Has sido seleccionado como GANADOR DEL GRAN PREMIO de nuestro SORTEO de iPhone 15 Pro Max! üì±‚ú®\n\nTu n√∫mero ganador: #847291\nValor del premio: $1,299 USD\n\nReclama tu iPhone GRATIS ahora antes de que expire:\nüëâ http://sorteo-apple-oficial.xyz/ganador?codigo=IPHONE2024\n\n¬°Ap√∫rate! ¬°Solo quedan 3 horas para reclamar!\n\nüéÅ 100% GRATIS - ¬°No requiere compra!\nüöö ¬°Env√≠o Internacional GRATIS!\n\n¬°Haz clic AHORA o pierde tu premio para siempre!"
                },
                phishing_social: {
                    en: "‚ö†Ô∏è Instagram Security Alert ‚ö†Ô∏è\n\nWe detected an unusual login attempt to your account from:\nLocation: Lagos, Nigeria\nDevice: Unknown Android Device\nTime: 2 hours ago\n\nThis wasn't you? Secure your account immediately:\nhttp://instagram-security-check.com/verify/account\n\nIf you don't verify within 12 hours, your account will be permanently deleted to prevent unauthorized access.\n\nInstagram Security Team\n---\nThis is an automated security notification.",
                    es: "‚ö†Ô∏è Alerta de Seguridad de Instagram ‚ö†Ô∏è\n\nDetectamos un intento de inicio de sesi√≥n inusual en tu cuenta desde:\nUbicaci√≥n: Lagos, Nigeria\nDispositivo: Dispositivo Android Desconocido\nHora: Hace 2 horas\n\n¬øNo fuiste t√∫? Asegura tu cuenta inmediatamente:\nhttp://instagram-seguridad-verificar.com/verificar/cuenta\n\nSi no verificas en 12 horas, tu cuenta ser√° eliminada permanentemente para prevenir acceso no autorizado.\n\nEquipo de Seguridad de Instagram\n---\nEsta es una notificaci√≥n de seguridad automatizada."
                },
                phishing_urgency: {
                    en: "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FINAL NOTICE - IMMEDIATE ACTION REQUIRED ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è\n\nYour Microsoft Office 365 subscription will EXPIRE TODAY at 11:59 PM!\n\nAll your files, emails, and documents will be DELETED if you don't renew NOW!\n\n‚ùå Time remaining: 4 hours 23 minutes\n‚ùå Files at risk: 15,847 documents\n‚ùå Emails to be deleted: 9,234 messages\n\nRENEW IMMEDIATELY to avoid data loss:\nüîó http://microsoft-office-renewal.net/urgent/renew\n\nCredit card required for verification. Act now!\n\nMicrosoft Billing Department",
                    es: "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è AVISO FINAL - ACCI√ìN INMEDIATA REQUERIDA ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è\n\n¬°Tu suscripci√≥n a Microsoft Office 365 EXPIRAR√Å HOY a las 11:59 PM!\n\n¬°Todos tus archivos, correos y documentos ser√°n ELIMINADOS si no renuevas AHORA!\n\n‚ùå Tiempo restante: 4 horas 23 minutos\n‚ùå Archivos en riesgo: 15,847 documentos\n‚ùå Correos a eliminar: 9,234 mensajes\n\nRENUEVA INMEDIATAMENTE para evitar p√©rdida de datos:\nüîó http://microsoft-office-renovacion.net/urgente/renovar\n\nTarjeta de cr√©dito requerida para verificaci√≥n. ¬°Act√∫a ahora!\n\nDepartamento de Facturaci√≥n de Microsoft"
                },
                legitimate_work: {
                    en: "Subject: Team Meeting Tomorrow - Project Update\n\nHi everyone,\n\nJust a friendly reminder about our weekly team meeting tomorrow (Tuesday) at 10:00 AM in Conference Room 3.\n\nAgenda:\n- Q4 progress review\n- Upcoming deadlines discussion\n- Resource allocation for next sprint\n\nPlease bring your monthly reports. If you can't attend, let me know by EOD today.\n\nBest regards,\nJohn Smith\nProject Manager\nTech Solutions Inc.",
                    es: "Asunto: Reuni√≥n de Equipo Ma√±ana - Actualizaci√≥n de Proyecto\n\nHola a todos,\n\nSolo un recordatorio amistoso sobre nuestra reuni√≥n semanal de equipo ma√±ana (martes) a las 10:00 AM en la Sala de Conferencias 3.\n\nAgenda:\n- Revisi√≥n de progreso del Q4\n- Discusi√≥n de fechas l√≠mite pr√≥ximas\n- Asignaci√≥n de recursos para el siguiente sprint\n\nPor favor traigan sus reportes mensuales. Si no pueden asistir, av√≠senme antes del fin del d√≠a.\n\nSaludos,\nJuan P√©rez\nGerente de Proyecto\nSoluciones Tecnol√≥gicas S.A."
                },
                legitimate_service: {
                    en: "Order Confirmation - Amazon.com\n\nHello,\n\nThank you for your order! Your package has been shipped and is on its way.\n\nOrder #: 123-4567890-1234567\nShipping Address: 123 Main St, Anytown, ST 12345\nEstimated Delivery: November 5, 2025\n\nYou can track your package at: amazon.com/orders\n(Please log into your account to view tracking details)\n\nItems ordered:\n- Wireless Mouse - $25.99\n- USB-C Cable (2-pack) - $12.99\n\nThank you for shopping with Amazon!\n\nThe Amazon Team",
                    es: "Confirmaci√≥n de Pedido - Amazon.com.mx\n\nHola,\n\n¬°Gracias por tu pedido! Tu paquete ha sido enviado y est√° en camino.\n\nPedido #: 123-4567890-1234567\nDirecci√≥n de Env√≠o: Calle Principal 123, Ciudad, CP 12345\nEntrega Estimada: 5 de noviembre, 2025\n\nPuedes rastrear tu paquete en: amazon.com.mx/pedidos\n(Por favor inicia sesi√≥n en tu cuenta para ver detalles de rastreo)\n\nArt√≠culos ordenados:\n- Mouse Inal√°mbrico - $25.99\n- Cable USB-C (paquete de 2) - $12.99\n\n¬°Gracias por comprar en Amazon!\n\nEl Equipo de Amazon"
                }
            };

            // --- Translations ---
            const translations = {
                en: {
                    mainHeading: "Phishing Detector",
                    textareaLabel: "Enter the email text below:",
                    analyzeButton: "Analyze Email",
                    clearButton: "Clear Text",
                    langToggleButton: "Espa√±ol", // Show Spanish option when in English
                    textareaPlaceholder: "Paste the full email content here, not just the address...",
                    exampleDefault: "-- Select an example to test --",
                    exampleBank: "üè¶ Phishing: Fake Bank Alert",
                    examplePrize: "üéÅ Phishing: Fake Prize/Lottery",
                    exampleSocial: "üì± Phishing: Social Media Alert",
                    exampleUrgency: "‚ö†Ô∏è Phishing: Urgent Action Required",
                    exampleWork: "‚úÖ Legitimate: Work Meeting",
                    exampleService: "üì¶ Legitimate: Order Confirmation",
                    historyModalTitle: "Analysis History",
                    exportBtnText: "Export JSON",
                    clearBtnText: "Clear All",
                },
                es: {
                    mainHeading: "Detector de Phishing",
                    textareaLabel: "Introduzca el texto del correo electr√≥nico a continuaci√≥n:",
                    analyzeButton: "Analizar Correo",
                    clearButton: "Limpiar Texto",
                    langToggleButton: "English", // Show English option when in Spanish
                    textareaPlaceholder: "Pegue aqu√≠ el contenido completo del correo electr√≥nico, no s√≥lo la direcci√≥n...",
                    exampleDefault: "-- Seleccione un ejemplo para probar --",
                    exampleBank: "üè¶ Phishing: Alerta Bancaria Falsa",
                    examplePrize: "üéÅ Phishing: Premio/Loter√≠a Falsa",
                    exampleSocial: "üì± Phishing: Alerta de Redes Sociales",
                    exampleUrgency: "‚ö†Ô∏è Phishing: Acci√≥n Urgente Requerida",
                    exampleWork: "‚úÖ Leg√≠timo: Reuni√≥n de Trabajo",
                    exampleService: "üì¶ Leg√≠timo: Confirmaci√≥n de Pedido",
                    historyModalTitle: "Historial de An√°lisis",
                    exportBtnText: "Exportar JSON",
                    clearBtnText: "Limpiar Todo",
                }
            };

            // --- Function to Set Language ---
            function setLanguage(lang) {
                if (!translations[lang]) {
                    console.error("Language not supported:", lang);
                    return;
                }

                // Update text content
                elements.mainHeading.innerText = translations[lang].mainHeading;
                elements.textareaLabel.innerText = translations[lang].textareaLabel;
                elements.analyzeButton.innerText = translations[lang].analyzeButton;
                elements.clearButton.innerText = translations[lang].clearButton;
                elements.langToggleButton.innerText = translations[lang].langToggleButton;

                // Update placeholder
                elements.emailTextarea.placeholder = translations[lang].textareaPlaceholder;

                // Update example selector options
                elements.exampleOptionDefault.innerText = translations[lang].exampleDefault;
                elements.exampleOptionBank.innerText = translations[lang].exampleBank;
                elements.exampleOptionPrize.innerText = translations[lang].examplePrize;
                elements.exampleOptionSocial.innerText = translations[lang].exampleSocial;
                elements.exampleOptionUrgency.innerText = translations[lang].exampleUrgency;
                elements.exampleOptionWork.innerText = translations[lang].exampleWork;
                elements.exampleOptionService.innerText = translations[lang].exampleService;
                
                // Update history modal translations
                elements.historyModalTitle.innerText = translations[lang].historyModalTitle;
                elements.exportBtnText.innerText = translations[lang].exportBtnText;
                elements.clearBtnText.innerText = translations[lang].clearBtnText;

                // Store preference
                localStorage.setItem('preferredLang', lang);
                // Set lang attribute on HTML tag for potential CSS use or accessibility
                document.documentElement.lang = lang;
            }

            // --- Toggle Button Event Listener ---
            elements.langToggleButton.addEventListener('click', function() {
                // Get current language (from storage or default to 'en')
                const currentLang = localStorage.getItem('preferredLang') || 'en';
                // Determine the new language
                const newLang = currentLang === 'en' ? 'es' : 'en';
                // Set the new language
                setLanguage(newLang);
            });

            // --- Example Selector Handler ---
            elements.exampleSelector.addEventListener('change', function() {
                const selectedExample = this.value;
                if (selectedExample) {
                    const currentLang = localStorage.getItem('preferredLang') || 'en';
                    elements.emailTextarea.value = examples[selectedExample][currentLang];
                    // Reset selector to default
                    this.value = '';
                }
            });

            // --- Initial Language Load ---
            // Get language from storage or default to Spanish (for .lat domain)
            const initialLang = localStorage.getItem('preferredLang') || 'es';
            setLanguage(initialLang);

            // --- Global variable to store last prediction ---
            let lastPredictionData = null;

            // --- Form Submission with AJAX ---
            const emailForm = document.getElementById('email-form');
            const resultArea = document.getElementById('result-area');

            emailForm.addEventListener('submit', async function(e) {
                e.preventDefault(); // Prevent default form submission

                const emailText = document.getElementById('email_text').value.trim();
                const currentLang = localStorage.getItem('preferredLang') || 'es';
                
                if (!emailText) {
                    const emptyMessage = currentLang === 'es' 
                        ? 'Por favor ingrese un texto de correo para analizar'
                        : 'Please enter some email text to analyze';
                    showError(emptyMessage);
                    return;
                }

                // Show loading state
                showLoading();

                try {
                    const response = await fetch('/predict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `email_text=${encodeURIComponent(emailText)}`
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Store prediction data for feedback
                        lastPredictionData = {
                            email_text: emailText,
                            prediction: data.prediction,
                            confidence: data.confidence,
                            risk_score: data.analysis.risk_score,
                            threats_detected: data.threats_detected,
                            google_safe_browsing_checked: data.google_safe_browsing?.checked || false,
                            google_safe_browsing_safe: data.google_safe_browsing?.is_safe || true
                        };
                        showResult(data);
                    } else {
                        const errorMessage = currentLang === 'es'
                            ? data.error || 'Ocurri√≥ un error durante el an√°lisis'
                            : data.error || 'An error occurred during analysis';
                        showError(errorMessage);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showError('Failed to connect to the server. Please try again.');
                }
            });

            // --- Show Loading State ---
            function showLoading() {
                const currentLang = localStorage.getItem('preferredLang') || 'en';
                const loadingText = currentLang === 'es' ? 'Analizando...' : 'Analyzing...';
                
                resultArea.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>${loadingText}</div>
                    </div>
                `;
            }

            // --- Show Result ---
            function showResult(data) {
                const currentLang = localStorage.getItem('preferredLang') || 'en';
                const isPhishing = data.prediction === 'PHISHING';
                const resultClass = isPhishing ? 'phishing' : 'legitimate';
                const icon = isPhishing ? '‚ö†Ô∏è' : '‚úÖ';
                
                const translations = {
                    en: {
                        phishing: 'Phishing Detected',
                        legitimate: 'Legitimate Email',
                        confidence: 'Confidence',
                        textLength: 'Text Length',
                        wordCount: 'Word Count',
                        urls: 'URLs Found',
                        excessiveCaps: 'Excessive Caps',
                        urgentLanguage: 'Urgent Language',
                        threatsDetected: 'Threats Detected',
                        riskScore: 'Risk Score',
                        keywordMatches: 'Phishing Keywords',
                        emojiCount: 'Emojis',
                        exclamationMarks: 'Exclamation Marks',
                        uppercaseRatio: 'Uppercase Ratio',
                        advancedFlags: 'Advanced Analysis',
                        advancedAnalysis: 'Advanced Analysis',
                        suspiciousTLD: 'Suspicious Domain',
                        suspiciousDomain: 'Suspicious Domain',
                        urlShortener: 'URL Shortener',
                        ipInUrl: 'IP in URL',
                        urgencyTactics: 'Urgency Tactics',
                        credentialRequest: 'Requests Credentials',
                        unrealisticOffer: 'Unrealistic Offer',
                        brandTypo: 'Brand Misspelling',
                        genericGreeting: 'Generic Greeting',
                        yes: 'Yes',
                        no: 'No',
                        none: 'None',
                        characters: 'characters',
                        words: 'words',
                        googleSafeBrowsing: 'Google Safe Browsing',
                        urlVerification: 'URL Verification',
                        checked: 'Checked',
                        notChecked: 'Not Checked',
                        safe: 'Safe',
                        malicious: 'Malicious',
                        maliciousUrls: 'Malicious URLs',
                        threatTypes: 'Threat Types',
                        apiNotConfigured: 'API not configured',
                        feedbackQuestion: 'Was this prediction correct?',
                        feedbackCorrect: 'Yes, correct',
                        feedbackIncorrect: 'No, incorrect',
                        feedbackThanks: 'Thank you for your feedback!',
                        feedbackError: 'Error submitting feedback'
                    },
                    es: {
                        phishing: 'Phishing Detectado',
                        legitimate: 'Correo Leg√≠timo',
                        confidence: 'Confianza',
                        textLength: 'Longitud del Texto',
                        wordCount: 'Cantidad de Palabras',
                        urls: 'URLs Encontradas',
                        excessiveCaps: 'May√∫sculas Excesivas',
                        urgentLanguage: 'Lenguaje Urgente',
                        threatsDetected: 'Amenazas Detectadas',
                        riskScore: 'Puntuaci√≥n de Riesgo',
                        keywordMatches: 'Palabras Clave',
                        emojiCount: 'Emojis',
                        exclamationMarks: 'Signos de Exclamaci√≥n',
                        uppercaseRatio: 'Ratio de May√∫sculas',
                        advancedFlags: 'An√°lisis Avanzado',
                        advancedAnalysis: 'An√°lisis Avanzado',
                        suspiciousTLD: 'Dominio Sospechoso',
                        suspiciousDomain: 'Dominio Sospechoso',
                        urlShortener: 'Acortador de URL',
                        ipInUrl: 'IP en URL',
                        urgencyTactics: 'T√°cticas de Urgencia',
                        credentialRequest: 'Solicita Credenciales',
                        unrealisticOffer: 'Oferta Irreal',
                        brandTypo: 'Marca Mal Escrita',
                        genericGreeting: 'Saludo Gen√©rico',
                        yes: 'S√≠',
                        no: 'No',
                        none: 'Ninguna',
                        characters: 'caracteres',
                        words: 'palabras',
                        googleSafeBrowsing: 'Google Safe Browsing',
                        urlVerification: 'Verificaci√≥n de URLs',
                        checked: 'Verificada',
                        notChecked: 'No Verificada',
                        safe: 'Segura',
                        malicious: 'Maliciosa',
                        maliciousUrls: 'URLs Maliciosas',
                        threatTypes: 'Tipos de Amenazas',
                        apiNotConfigured: 'API no configurada',
                        feedbackQuestion: '¬øFue correcta esta predicci√≥n?',
                        feedbackCorrect: 'S√≠, correcta',
                        feedbackIncorrect: 'No, incorrecta',
                        feedbackThanks: '¬°Gracias por tu retroalimentaci√≥n!',
                        feedbackError: 'Error al enviar retroalimentaci√≥n'
                    }
                };

                const t = translations[currentLang];
                const resultTitle = isPhishing ? t.phishing : t.legitimate;
                const confidence = (data.confidence * 100).toFixed(1);
                const confidenceColor = isPhishing ? getCSSVar('--accent-danger') : getCSSVar('--accent-success');
                
                // Threat translations
                const threatTranslations = {
                    en: {
                        'Suspicious domain extension': 'Suspicious domain extension',
                        'URL shortener detected': 'URL shortener detected',
                        'IP address in URL': 'IP address in URL',
                        'Urgent language tactics': 'Urgent language tactics',
                        'Requests credentials': 'Requests credentials',
                        'Too-good-to-be-true offer': 'Too-good-to-be-true offer',
                        'Brand name misspelling': 'Brand name misspelling',
                        'Generic greeting': 'Generic greeting',
                        'Excessive capitalization': 'Excessive capitalization',
                        'phishing keywords': 'phishing keywords',
                        'Google Safe Browsing': 'Google Safe Browsing',
                        'Malware': 'Malware',
                        'Phishing/Social Engineering': 'Phishing/Social Engineering',
                        'Unwanted Software': 'Unwanted Software',
                        'Harmful Application': 'Harmful Application'
                    },
                    es: {
                        'Suspicious domain extension': 'Extensi√≥n de dominio sospechosa',
                        'URL shortener detected': 'Acortador de URL detectado',
                        'IP address in URL': 'Direcci√≥n IP en la URL',
                        'Urgent language tactics': 'T√°cticas de lenguaje urgente',
                        'Requests credentials': 'Solicita credenciales',
                        'Too-good-to-be-true offer': 'Oferta demasiado buena para ser verdad',
                        'Brand name misspelling': 'Nombre de marca mal escrito',
                        'Generic greeting': 'Saludo gen√©rico',
                        'Excessive capitalization': 'Uso excesivo de may√∫sculas',
                        'phishing keywords': 'palabras clave de phishing',
                        'Google Safe Browsing': 'Google Safe Browsing',
                        'Malware': 'Malware',
                        'Phishing/Social Engineering': 'Phishing/Ingenier√≠a Social',
                        'Unwanted Software': 'Software No Deseado',
                        'Harmful Application': 'Aplicaci√≥n Da√±ina'
                    }
                };
                
                // Function to translate threat messages
                function translateThreat(threat, lang) {
                    // Handle dynamic messages like "7 phishing keywords"
                    const keywordMatch = threat.match(/^(\d+)\s+phishing keywords$/);
                    if (keywordMatch) {
                        const count = keywordMatch[1];
                        return lang === 'es' 
                            ? `${count} palabras clave de phishing`
                            : `${count} phishing keywords`;
                    }
                    
                    // Handle Google Safe Browsing threats like "Google Safe Browsing: Malware"
                    const googleMatch = threat.match(/^Google Safe Browsing:\s+(.+)$/);
                    if (googleMatch) {
                        const threatType = googleMatch[1];
                        const translatedType = threatTranslations[lang][threatType] || threatType;
                        return lang === 'es'
                            ? `Google Safe Browsing: ${translatedType}`
                            : `Google Safe Browsing: ${translatedType}`;
                    }
                    
                    // Use translation table or return original if not found
                    return threatTranslations[lang][threat] || threat;
                }
                
                // Build threats list HTML
                let threatsHTML = '';
                if (data.threats_detected && data.threats_detected.length > 0) {
                    threatsHTML = '<div class="detail-row" style="grid-column: 1 / -1;"><span class="detail-label">' + t.threatsDetected + ':</span><ul style="margin: 5px 0 0 20px; color: ' + getCSSVar('--accent-danger') + ';">';
                    data.threats_detected.forEach(threat => {
                        const translatedThreat = translateThreat(threat, currentLang);
                        threatsHTML += '<li>' + translatedThreat + '</li>';
                    });
                    threatsHTML += '</ul></div>';
                } else {
                    threatsHTML = '<div class="detail-row" style="grid-column: 1 / -1;"><span class="detail-label">' + t.threatsDetected + ':</span><span class="detail-value" style="color: ' + getCSSVar('--accent-success') + ';">' + t.none + '</span></div>';
                }
                
                // Build Google Safe Browsing HTML
                let safeBrowsingHTML = '';
                if (data.google_safe_browsing) {
                    const gsb = data.google_safe_browsing;
                    safeBrowsingHTML = '<div style="grid-column: 1 / -1; margin-top: 15px; padding-top: 15px; border-top: 1px solid ' + getCSSVar('--border-primary') + ';"><strong>üõ°Ô∏è ' + t.googleSafeBrowsing + '</strong></div>';
                    
                    // Status badge
                    if (gsb.checked) {
                        const statusText = gsb.is_safe ? t.safe : t.malicious;
                        const statusColor = gsb.is_safe ? getCSSVar('--accent-success') : getCSSVar('--accent-danger');
                        const statusIcon = gsb.is_safe ? '‚úì' : '‚ö†Ô∏è';
                        safeBrowsingHTML += '<div class="detail-row"><span class="detail-label">' + t.urlVerification + ':</span><span class="detail-value" style="color: ' + statusColor + ';"> ' + statusIcon + ' ' + statusText + '</span></div>';
                        
                        // Show malicious URLs if found
                        if (!gsb.is_safe && gsb.malicious_urls && gsb.malicious_urls.length > 0) {
                            safeBrowsingHTML += '<div class="detail-row" style="grid-column: 1 / -1;"><span class="detail-label">' + t.maliciousUrls + ':</span><ul style="margin: 5px 0 0 20px; color: ' + getCSSVar('--accent-danger') + ';">';
                            gsb.malicious_urls.forEach(url => {
                                safeBrowsingHTML += '<li style="word-break: break-all;">' + url + '</li>';
                            });
                            safeBrowsingHTML += '</ul></div>';
                            
                            // Show threat types if found
                            if (gsb.threats_found && gsb.threats_found.length > 0) {
                                safeBrowsingHTML += '<div class="detail-row" style="grid-column: 1 / -1;"><span class="detail-label">' + t.threatTypes + ':</span><ul style="margin: 5px 0 0 20px; color: ' + getCSSVar('--accent-danger') + ';">';
                                gsb.threats_found.forEach(threat => {
                                    const translatedThreat = threatTranslations[currentLang][threat] || threat;
                                    safeBrowsingHTML += '<li>' + translatedThreat + '</li>';
                                });
                                safeBrowsingHTML += '</ul></div>';
                            }
                        }
                    } else {
                        // API not configured
                        safeBrowsingHTML += '<div class="detail-row" style="grid-column: 1 / -1;"><span class="detail-label">' + t.urlVerification + ':</span><span class="detail-value" style="color: ' + getCSSVar('--text-tertiary') + ';">‚äò ' + t.apiNotConfigured + '</span></div>';
                    }
                }
                
                // Build advanced flags HTML
                let flagsHTML = '';
                if (data.flags) {
                    const flagsToShow = [
                        { key: 'suspicious_tld', label: t.suspiciousTLD },
                        { key: 'url_shortener', label: t.urlShortener },
                        { key: 'ip_in_url', label: t.ipInUrl },
                        { key: 'urgency_tactics', label: t.urgencyTactics },
                        { key: 'credential_request', label: t.credentialRequest },
                        { key: 'unrealistic_offer', label: t.unrealisticOffer },
                        { key: 'brand_typo', label: t.brandTypo },
                        { key: 'generic_greeting', label: t.genericGreeting }
                    ];
                    
                    flagsHTML = '<div style="grid-column: 1 / -1; margin-top: 15px; padding-top: 15px; border-top: 1px solid ' + getCSSVar('--border-primary') + ';"><strong>' + t.advancedFlags + '</strong></div>';
                    flagsToShow.forEach(flag => {
                        const value = data.flags[flag.key];
                        const valueText = value ? t.yes : t.no;
                        const valueColor = value ? getCSSVar('--accent-danger') : getCSSVar('--accent-success');
                        flagsHTML += '<div class="detail-row"><span class="detail-label">' + flag.label + ':</span><span class="detail-value" style="color: ' + valueColor + ';">' + valueText + '</span></div>';
                    });
                }

                resultArea.innerHTML = `
                    <div class="result ${resultClass}">
                        <div class="result-header">
                            <span class="result-icon">${icon}</span>
                            <span>${resultTitle}</span>
                        </div>
                        <div class="result-details">
                            <div class="detail-row">
                                <span class="detail-label">${t.confidence}:</span>
                                <span class="detail-value">${confidence}%</span>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidence}%; background-color: ${confidenceColor};"></div>
                            </div>
                            ${threatsHTML}
                            <div class="detail-row">
                                <span class="detail-label">${t.riskScore}:</span>
                                <span class="detail-value">${data.analysis.risk_score}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.textLength}:</span>
                                <span class="detail-value">${data.analysis.text_length}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.wordCount}:</span>
                                <span class="detail-value">${data.analysis.word_count}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.urls}:</span>
                                <span class="detail-value">${data.analysis.url_count}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.keywordMatches}:</span>
                                <span class="detail-value">${data.analysis.phishing_keywords}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.uppercaseRatio}:</span>
                                <span class="detail-value">${(data.analysis.uppercase_ratio * 100).toFixed(1)}%</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.exclamationMarks}:</span>
                                <span class="detail-value">${data.analysis.exclamation_marks}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">${t.emojiCount}:</span>
                                <span class="detail-value">${data.analysis.emoji_count}</span>
                            </div>
                            ${safeBrowsingHTML}
                            ${flagsHTML}
                        </div>
                        <div id="feedback-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid ${getCSSVar('--border-primary')}; text-align: center;">
                            <p style="margin-bottom: 15px; color: ${getCSSVar('--text-secondary')}; font-size: 14px;">${t.feedbackQuestion}</p>
                            <div style="display: flex; gap: 15px; justify-content: center;">
                                <button onclick="submitFeedback('correct')" style="padding: 10px 20px; background: linear-gradient(135deg, ${getCSSVar('--accent-success')}, ${getCSSVar('--accent-success-hover')}); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s;">
                                    üëç ${t.feedbackCorrect}
                                </button>
                                <button onclick="submitFeedback('incorrect')" style="padding: 10px 20px; background: linear-gradient(135deg, ${getCSSVar('--accent-danger')}, ${getCSSVar('--accent-danger-hover')}); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s;">
                                    üëé ${t.feedbackIncorrect}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Save to history
                const emailText = document.getElementById('email_text').value;
                saveToHistory(emailText, data.prediction, data.confidence, data);
            }

            // --- Show Error ---
            function showError(message) {
                const currentLang = localStorage.getItem('preferredLang') || 'es';
                const errorTitle = currentLang === 'es' ? 'Error' : 'Error';
                
                resultArea.innerHTML = `
                    <div class="result error">
                        <div class="result-header">
                            <span class="result-icon">‚ùå</span>
                            <span>${errorTitle}</span>
                        </div>
                        <div class="result-details">
                            ${message}
                        </div>
                    </div>
                `;
            }

            // --- Submit Feedback Function ---
            window.submitFeedback = async function(feedbackType) {
                if (!lastPredictionData) {
                    console.error('No prediction data available');
                    return;
                }

                const currentLang = localStorage.getItem('preferredLang') || 'es';
                const translations = {
                    en: {
                        thanks: 'Thank you for your feedback!',
                        error: 'Error submitting feedback'
                    },
                    es: {
                        thanks: '¬°Gracias por tu retroalimentaci√≥n!',
                        error: 'Error al enviar retroalimentaci√≥n'
                    }
                };

                try {
                    const response = await fetch('/feedback', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email_text: lastPredictionData.email_text,
                            prediction: lastPredictionData.prediction,
                            user_feedback: feedbackType,
                            confidence: lastPredictionData.confidence,
                            risk_score: lastPredictionData.risk_score,
                            threats_detected: lastPredictionData.threats_detected,
                            google_safe_browsing_checked: lastPredictionData.google_safe_browsing_checked,
                            google_safe_browsing_safe: lastPredictionData.google_safe_browsing_safe
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Replace feedback section with thank you message
                        const feedbackSection = document.getElementById('feedback-section');
                        if (feedbackSection) {
                            feedbackSection.innerHTML = `
                                <p style="color: ${getCSSVar('--accent-success')}; font-weight: bold; font-size: 16px;">
                                    ‚úì ${translations[currentLang].thanks}
                                </p>
                            `;
                        }
                    } else {
                        alert(translations[currentLang].error);
                    }
                } catch (error) {
                    console.error('Feedback error:', error);
                    alert(translations[currentLang].error);
                }
            };

        }); // End DOMContentLoaded

        // --- Clear Text Area Function ---
        function clearTextArea() {
            document.getElementById('email_text').value = '';
            // Clear the result area as well
            const resultArea = document.getElementById('result-area');
            if (resultArea) {
                resultArea.innerHTML = ''; // Clear previous results
            }
        }
    </script>

    <!-- History Modal -->
    <div id="history-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="history-modal-title">Analysis History</h2>
                <button class="modal-close" onclick="closeHistoryModal()" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body" id="history-list">
                <!-- History items will be inserted here -->
            </div>
            <div class="modal-footer">
                <div>
                    <span id="history-count" style="color: var(--text-secondary); font-size: 0.9rem;">0 analyses</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="modal-footer-btn export" onclick="exportHistory()" id="export-history-btn">
                        üì• <span id="export-btn-text">Export JSON</span>
                    </button>
                    <button class="modal-footer-btn clear" onclick="clearAllHistory()" id="clear-history-btn">
                        üóëÔ∏è <span id="clear-btn-text">Clear All</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>